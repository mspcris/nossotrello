{# tracktime/templates/tracktime/partials/phone_required_modal.html #}
{% load static %}

<div
  id="tt-phone-modal"
  class="fixed inset-0 z-[5000] flex items-center justify-center p-4"
  style="background: rgba(0,0,0,0.55);"
  aria-modal="true"
  role="dialog"
>
  <div
    data-tt-dialog
    class="w-full max-w-[520px] rounded-2xl bg-white text-slate-900 shadow-2xl border border-slate-200 overflow-hidden"
  >
    <div class="p-4 border-b border-slate-200">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="text-sm text-slate-600">Track-time</div>
          <h2 class="text-xl font-semibold tracking-tight">Cadastre seu telefone</h2>
          <p class="mt-1 text-sm text-slate-600">
            Para usar o track-time, precisamos do seu WhatsApp no formato <strong>+55 (DD) NÚMERO</strong>.
          </p>
        </div>

        <button
          type="button"
          class="text-slate-400 hover:text-slate-700"
          aria-label="Fechar"
          onclick="document.getElementById('tt-phone-modal')?.remove()"
        >
          ✕
        </button>
      </div>
    </div>

    <form
      class="p-4"
      hx-post="{% url 'tracktime:phone_save' %}"
      hx-swap="none"
      hx-on::after-request="
        if (event.detail && event.detail.successful) {
          const root = document.getElementById('tt-phone-modal');
          if (root) root.remove();

          const cardId = this.querySelector('input[name=card_id]')?.value;
          const projectId = this.querySelector('input[name=project_id]')?.value;
          const activityId = this.querySelector('input[name=activity_id]')?.value;

          if (cardId && projectId && activityId && window.htmx) {
            window.htmx.ajax('POST', '/track-time/cards/' + cardId + '/track-time/start/', {
              target: '#cm-tracktime-panel',
              swap: 'innerHTML',
              values: { project: projectId, activity: activityId }
            });
          }
        }
      "
    >
      {% csrf_token %}

      <input type="hidden" name="card_id" value="{{ card_id }}">
      <input type="hidden" name="project_id" value="{{ project_id }}">
      <input type="hidden" name="activity_id" value="{{ activity_id }}">

      <div class="grid grid-cols-12 gap-3">
        <div class="col-span-4">
          <label class="block text-xs font-semibold text-slate-700 mb-1">País</label>
          <input
            type="text"
            value="+55"
            readonly
            class="w-full rounded-xl border border-slate-300 bg-slate-50 px-3 py-2 text-sm"
          >
        </div>

        <div class="col-span-4">
          <label class="block text-xs font-semibold text-slate-700 mb-1">DDD</label>
          <input
            name="ddd"
            type="text"
            inputmode="numeric"
            autocomplete="off"
            maxlength="2"
            placeholder="21"
            class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-200"
            required
          >
        </div>

        <div class="col-span-12 md:col-span-4">
          <label class="block text-xs font-semibold text-slate-700 mb-1">Telefone</label>
          <input
            name="phone"
            type="text"
            inputmode="numeric"
            autocomplete="off"
            maxlength="9"
            placeholder="999999999"
            class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-200"
            required
          >
        </div>
      </div>

      {% if error %}
        <div class="mt-3 rounded-xl border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-800">
          {{ error }}
        </div>
      {% endif %}

      <div class="mt-4 flex items-center justify-end gap-2">
        <button
          type="button"
          class="px-4 py-2 rounded-xl bg-slate-100 text-slate-900 text-sm font-semibold hover:bg-slate-200
                 focus:outline-none focus:ring-2 focus:ring-slate-200"
          onclick="document.getElementById('tt-phone-modal')?.remove()"
        >
          Cancelar
        </button>

        <button
          type="submit"
          class="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm font-semibold hover:bg-slate-800
                 focus:outline-none focus:ring-2 focus:ring-slate-200"
        >
          Salvar e continuar
        </button>
      </div>

      <p class="mt-3 text-xs text-slate-500">
        Salvamos apenas números: <strong>55 + DDD + telefone</strong> (ex: 5521999999999).
      </p>
    </form>
  </div>
</div>

<script>
(function () {
  const root = document.getElementById("tt-phone-modal");
  if (!root) return;

  const dialog = root.querySelector("[data-tt-dialog]");

  // clique dentro do card não fecha
  if (dialog) {
    dialog.addEventListener("click", function (e) {
      e.stopPropagation();
    });
  }

  // clique fora fecha
  root.addEventListener("click", function () {
    root.remove();
  });

  // ESC fecha
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape") root.remove();
  }, { once: true });

  // foco no DDD
  const ddd = root.querySelector("input[name=ddd]");
  if (ddd) ddd.focus();
})();
</script>
