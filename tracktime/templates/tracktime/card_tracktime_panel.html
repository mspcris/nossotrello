{# Track-time panel (HTMX) #}

<style>
  /* Escopo local para não “vazar” no resto do app */
  .tt-grid { display:grid; grid-template-columns: 1fr 1fr; gap: .5rem; align-items: center; }
  .tt-row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .tt-grow { flex: 1 1 auto; min-width: 180px; }
  .tt-btn {
    appearance: none;
    border: 1px solid rgba(255,255,255,.25);
    background: rgba(255,255,255,.08);
    padding: .45rem .8rem;
    border-radius: .5rem;
    font-weight: 600;
    cursor: pointer;
    line-height: 1;
  }
  .tt-btn:hover { background: rgba(255,255,255,.12); }
  .tt-btn-primary { border-color: rgba(80,180,255,.55); background: rgba(80,180,255,.18); }
  .tt-btn-danger { border-color: rgba(255,90,90,.55); background: rgba(255,90,90,.18); }
  .tt-input, .tt-select {
    width: 100%;
    padding: .45rem .55rem;
    border-radius: .5rem;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
  }
  .tt-right { display:flex; justify-content:flex-end; gap:.5rem; align-items:center; }
  .tt-timer { font-variant-numeric: tabular-nums; opacity: .9; }
  .tt-muted { opacity: .75; font-size: .9em; }
</style>

<div
  class="cm-card space-y-3"
  {% if running %}
    hx-get="{% url 'tracktime:card_panel' card.id %}"
    hx-trigger="every 5s"
    hx-target="#cm-tracktime-panel"
    hx-swap="innerHTML"
  {% endif %}
>
  <div class="tt-row" style="justify-content: space-between;">
    <strong>Track-time</strong>

    {% if running %}
      <div class="tt-timer">
        {# Contador simples (sem JS): minutos desde started_at #}
        {% if running.started_at %}
          {% with delta=now|date:"U"|add:"0" %}
          {% endwith %}
        {% endif %}
        <span class="tt-muted">Rodando</span>
      </div>
    {% else %}
      <span class="tt-muted">Parado</span>
    {% endif %}
  </div>

  {% if running %}
    <form
      method="post"
      hx-post="{% url 'tracktime:card_stop' card.id %}"
      hx-target="#cm-tracktime-panel"
      hx-swap="innerHTML"
      class="tt-right"
    >
      {% csrf_token %}
      <button type="submit" class="tt-btn tt-btn-danger">Stop</button>
    </form>
  {% else %}
    <form
      method="post"
      hx-post="{% url 'tracktime:card_start' card.id %}"
      hx-target="#cm-tracktime-panel"
      hx-swap="innerHTML"
      class="tt-grid"
    >
      {% csrf_token %}

      <div>
        <select name="project" required class="tt-select">
          {% for p in projects %}
            <option value="{{ p.id }}">{{ p.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <select name="activity_type" required class="tt-select">
          {% for a in activities %}
            <option value="{{ a.id }}">{{ a.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="tt-right" style="grid-column: 1 / -1;">
        <button type="submit" class="tt-btn tt-btn-primary">Start</button>
      </div>
    </form>

    {# Manual só quando NÃO está running #}
    <form
      method="post"
      hx-post="{% url 'tracktime:card_manual' card.id %}"
      hx-target="#cm-tracktime-panel"
      hx-swap="innerHTML"
      class="tt-grid"
    >
      {% csrf_token %}
      <div>
        <input type="number" name="minutes" placeholder="Minutos" min="1" required class="tt-input">
      </div>

      <div class="tt-right">
        <input type="hidden" name="project">
        <input type="hidden" name="activity_type">
        <button type="submit" class="tt-btn">Manual</button>
      </div>
    </form>
  {% endif %}

  <hr>

  <strong>Últimos lançamentos</strong>

  {% if entries %}
    <ul class="space-y-1">
      {% for e in entries %}
        <li>
          {{ e.user }} —
          {{ e.project.name }} /
          {{ e.activity_type.name }} —
          {{ e.minutes }} min
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="cm-muted">Nenhum lançamento ainda.</div>
  {% endif %}
</div>

<script>
(function () {
  const panel = document.getElementById("cm-tracktime-panel");
  if (!panel) return;

  function syncHidden() {
    const project = panel.querySelector('select[name="project"]')?.value;
    const activity = panel.querySelector('select[name="activity_type"]')?.value;

    const mp = panel.querySelector('input[name="project"][type="hidden"]');
    const ma = panel.querySelector('input[name="activity_type"][type="hidden"]');

    if (mp) mp.value = project || "";
    if (ma) ma.value = activity || "";
  }

  panel.addEventListener("change", syncHidden);
  syncHidden();
})();
</script>
