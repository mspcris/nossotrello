{# tracktime/templates/tracktime/card_tracktime_panel.html #}

<style>
  /* Escopo local para não “vazar” no resto do app */
  .tt-grid { display:grid; grid-template-columns: 1fr 1fr; gap: .5rem; align-items: center; }
  .tt-row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .tt-btn {
    appearance: none;
    border: 1px solid rgba(255,255,255,.25);
    background: rgba(255,255,255,.08);
    padding: .55rem .95rem;
    border-radius: .65rem;
    font-weight: 700;
    cursor: pointer;
    line-height: 1;
  }
  .tt-btn:hover { background: rgba(255,255,255,.12); }
  .tt-btn-primary { border-color: rgba(80,180,255,.55); background: rgba(80,180,255,.18); }
  .tt-btn-danger { border-color: rgba(255,90,90,.55); background: rgba(255,90,90,.18); }
  .tt-input, .tt-select {
    width: 100%;
    padding: .55rem .65rem;
    border-radius: .65rem;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
  }
  .tt-right { display:flex; justify-content:flex-end; gap:.5rem; align-items:center; }
  .tt-muted { opacity: .75; font-size: .9em; }
  .tt-box-warn {
    border: 1px solid rgba(255,200,0,.35);
    background: rgba(255,200,0,.08);
    padding: 12px;
    border-radius: 12px;
  }

  /* ===== Spinner central (no espaço do modal) ===== */
  .tt-elapsed-center {
    display:flex;
    justify-content:center;
    padding: 14px 0 6px;
  }
  .tt-loader-wrap {
    position: relative;
    width: 180px;
    height: 180px;
  }
  .tt-loader {
    position:absolute;
    inset:0;
    border: 8px solid rgba(255,255,255,.12);
    border-top: 8px solid rgba(80,180,255,.65);
    border-radius: 50%;
    animation: ttspin 1s linear infinite;
  }
  .tt-loader-text {
    position:absolute;
    inset:0;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding: 18px;
  }
  @keyframes ttspin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<div class="cm-card space-y-3">

  <div class="tt-row" style="justify-content: space-between;">
    <strong>Track-time</strong>
    <span id="tt-running-badge" class="tt-muted">
      {% if running %}Rodando{% else %}Parado{% endif %}
    </span>
  </div>

  {# ====== SLOT (SEM hx-get / SEM polling de DOM) ====== #}
  <div id="tt-running-slot">
    {% include "tracktime/partials/card_tracktime_running_slot.html" %}
  </div>

  {# ====== FORMULÁRIOS (só quando NÃO está rodando) ====== #}
  {% if not running %}
    <form
      method="post"
      hx-post="{% url 'tracktime:card_start' card.id %}"
      hx-target="#cm-tracktime-panel"
      hx-swap="innerHTML"
      class="tt-grid"
    >
      {% csrf_token %}

      <div>
        <select id="tt-project" name="project" required class="tt-select">
          {% for p in projects %}
            <option value="{{ p.id }}">{{ p.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <select id="tt-activity" name="activity_type" required class="tt-select">
          {% for a in activities %}
            <option value="{{ a.id }}">{{ a.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="tt-right" style="grid-column: 1 / -1;">
        <button type="submit" class="tt-btn tt-btn-primary">Start</button>
      </div>
    </form>

    {# Manual só quando NÃO está rodando #}
    <form
      method="post"
      hx-post="{% url 'tracktime:card_manual' card.id %}"
      hx-target="#cm-tracktime-panel"
      hx-swap="innerHTML"
      class="tt-grid"
    >
      {% csrf_token %}

      <div>
        <input type="number" name="minutes" placeholder="Minutos" min="1" required class="tt-input">
      </div>

      <div class="tt-right">
        <input type="hidden" name="project">
        <input type="hidden" name="activity_type">
        <button type="submit" class="tt-btn">Manual</button>
      </div>
    </form>
  {% endif %}

  <hr>

  <strong>Últimos lançamentos</strong>

  {% if entries %}
    <ul class="space-y-1">
      {% for e in entries %}
        <li>
          {{ e.user }} —
          {{ e.project.name }} /
          {{ e.activity_type.name }} —
          {{ e.minutes }} min
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="cm-muted">Nenhum lançamento ainda.</div>
  {% endif %}
</div>

<script>
(function () {
  const panel = document.getElementById("cm-tracktime-panel");
  if (!panel) return;

  // =========================
  // 1) Hidden sync (só 1x por painel)
  // =========================
  if (panel.dataset.ttSyncBound !== "1") {
    panel.dataset.ttSyncBound = "1";

    function syncHidden() {
      const project = panel.querySelector('#tt-project')?.value;
      const activity = panel.querySelector('#tt-activity')?.value;

      const mp = panel.querySelector('input[name="project"][type="hidden"]');
      const ma = panel.querySelector('input[name="activity_type"][type="hidden"]');

      if (mp) mp.value = project || "";
      if (ma) ma.value = activity || "";
    }

    panel.addEventListener("change", syncHidden);
    syncHidden();
  }

  // =========================
  // 2) Elapsed updater (pode reiniciar após HTMX swap)
  // =========================
  function hhmmToHhMm(hhmm) {
    const s = String(hhmm || "");
    const m = s.match(/^(\d{2}):(\d{2})$/);
    if (!m) return s;
    return `${m[1]}h${m[2]}m`;
  }

  // guarda o timer no próprio painel (pra matar/recriar)
  function stopTimer() {
    const id = panel.dataset.ttElapsedTimerId;
    if (id) {
      clearInterval(Number(id));
      delete panel.dataset.ttElapsedTimerId;
    }
  }

  async function refreshElapsed(url, line) {
    try {
      const res = await fetch(url, {
        method: "GET",
        credentials: "same-origin",
        headers: { "Accept": "application/json", "X-Requested-With": "XMLHttpRequest" },
        cache: "no-store",
      });

      if (!res.ok) {
        line.textContent = `Falha HTTP (${res.status})`;
        return;
      }

      // proteção contra HTML (redirect/login) retornando 200
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      if (!ct.includes("application/json")) {
        line.textContent = "Resposta não é JSON (ver login/redirect).";
        return;
      }

      const data = await res.json();

      if (!data) {
        line.textContent = "Falha ao ler JSON.";
        return;
      }

      if (!data.running) {
        line.textContent = "Aguardando iniciar…";
        return;
      }

      if (data.running && data.in_this_card === false) {
        line.textContent = `Timer rodando em outro card (#${data.running_card_id}).`;
        return;
      }

      const started = hhmmToHhMm(data.started_hhmm);
      const mmss = String(data.elapsed_mmss || "");
      line.textContent = `${started} • ${mmss}`;
    } catch (_) {
      line.textContent = "Erro no fetch.";
    }
  }

  function initElapsedBox() {
    const wrap = panel.querySelector("#tt-elapsed-box");
    const line = panel.querySelector("#tt-elapsed-line");

    // não tem spinner neste estado (ex: not running)
    if (!wrap || !line) {
      stopTimer();
      return;
    }

    // evita duplicar init no mesmo elemento após swaps
    if (wrap.dataset.ttBound === "1") return;
    wrap.dataset.ttBound = "1";

    const url = wrap.dataset.url;
    if (!url) {
      line.textContent = "Sem URL do JSON.";
      return;
    }

    // sempre reinicia o timer ao montar o box (evita timer zumbi)
    stopTimer();

    // primeira leitura imediata
    refreshElapsed(url, line);

    // intervalo (não mexe no DOM do modal, só no texto)
    const t = setInterval(() => refreshElapsed(url, line), 5000);
    panel.dataset.ttElapsedTimerId = String(t);

    // mata timer se o painel sair do DOM
    const obs = new MutationObserver(() => {
      if (!document.body.contains(panel)) {
        stopTimer();
        obs.disconnect();
      }
    });
    obs.observe(document.body, { childList: true, subtree: true });
  }

  // init inicial
  initElapsedBox();

  // re-init após HTMX swap (start/stop remonta o painel)
  document.body.addEventListener("htmx:afterSwap", function (ev) {
    if (ev.target && (ev.target.id === "cm-tracktime-panel" || ev.target.closest?.("#cm-tracktime-panel"))) {
      initElapsedBox();
    }
  });

  document.body.addEventListener("htmx:afterSettle", function (ev) {
    if (ev.target && (ev.target.id === "cm-tracktime-panel" || ev.target.closest?.("#cm-tracktime-panel"))) {
      initElapsedBox();
    }
  });
})();
</script>
