
<!-- /boards/templates/boards/partials/column_item.html -->
<div class="column-item relative w-72 flex-shrink-0 rounded-xl shadow-lg overflow-visible
            column-glass {{ column.theme|default:'gray'|add:'-column-bg' }}
            flex flex-col max-h-[calc(100vh-180px)]"
     data-column-id="{{ column.id }}">

  <!-- ===================== HEADER ===================== -->
  <div class="column-header shrink-0 px-4 py-2 border-b border-white/40 z-10 min-h-[72px]">

    <!-- Linha 1: a√ß√µes -->
    <div class="flex items-center justify-end gap-2">
      {% with n=column.card_count|default:column.cards.count %}
        <span class="mr-auto text-xs text-gray-600" data-column-counter>
          {{ n }} card{% if n != 1 %}s{% endif %}
        </span>
      {% endwith %}



<!-- follow coluna (popover) -->
<div class="relative" data-col-follow-scope="{{ column.id }}">
      <button id="col-follow-btn-{{ column.id }}"
        data-col-follow-btn
        data-col-id="{{ column.id }}"
        type="button"
        class="px-2 py-1 rounded-lg bg-white/20 border border-white/40
               text-gray-700 hover:text-gray-900 backdrop-blur-sm transition"
        aria-expanded="false"
        title="Seguir cards desta coluna"
        onpointerdown="event.stopPropagation();"
        ontouchstart="event.stopPropagation();"
        onclick="event.preventDefault(); event.stopPropagation(); window.__cmToggleColFollowPopover('{{ column.id }}');">
  üëÅ
</button>



<div id="col-follow-popover-{{ column.id }}"
     data-col-follow-popover
     data-col-id="{{ column.id }}"
     class="hidden absolute right-full mr-3 mt-2 w-72 rounded-xl shadow-2xl
            bg-slate-900/90 text-white backdrop-blur-md border border-white/15
            p-3 z-[9999]">

          <div class="text-sm font-semibold text-white">Seguir cards desta coluna</div>

            <div class="mt-2 text-xs text-white/70">
              Seguir cards atuais e, opcionalmente, seguir automaticamente novos cards que entrarem aqui.
            </div>

            <label class="mt-2 flex items-center gap-2 text-xs text-white/70">
      <input type="checkbox" id="col-follow-include-new-{{ column.id }}" checked>
      Incluir novos cards automaticamente
    </label>

    <div class="mt-3 flex gap-2">
      <button type="button"
              class="flex-1 text-sm px-3 py-2 rounded-lg bg-gray-900 text-white hover:bg-black transition"
              onpointerdown="event.stopPropagation();"
              ontouchstart="event.stopPropagation();"
              onclick="event.preventDefault(); event.stopPropagation(); window.__cmEnableColFollow('{{ column.id }}');">
        Ativar
      </button>

      <button type="button"
              class="flex-1 text-sm px-3 py-2 rounded-lg bg-white/70 border border-gray-200 hover:bg-white transition"
              onpointerdown="event.stopPropagation();"
              ontouchstart="event.stopPropagation();"
              onclick="event.preventDefault(); event.stopPropagation(); window.__cmDisableColFollow('{{ column.id }}');">
        Desativar
      </button>
    </div>

    <label class="mt-2 flex items-center gap-2 text-xs text-gray-700">
      <input type="checkbox" id="col-follow-unfollow-existing-{{ column.id }}" checked>
      Ao desativar, parar de seguir os cards atuais tamb√©m
    </label>

    <div class="mt-2 text-xs text-white/70" id="col-follow-status-{{ column.id }}"></div>
  </div>
</div>






      <!-- + Card (TOPO) -->
      <button type="button"
              class="text-gray-700 hover:text-gray-900 px-2 py-1 rounded-lg
                     bg-white/20 backdrop-blur-sm border border-white/40 transition"
              hx-get="{% url 'boards:add_card' column.id %}?where=top"
              hx-target="#form-top-col-{{ column.id }}"
              hx-swap="innerHTML"
              onpointerdown="event.stopPropagation();"
              ontouchstart="event.stopPropagation();">
        + Card
      </button>

      <!-- menu 3 dots (POPOVER) -->
      <div class="relative" data-col-menu-scope="{{ column.id }}">
        <button type="button"
                class="px-2 py-1 rounded-lg bg-white/20 border border-white/40
                       text-gray-700 hover:text-gray-900 backdrop-blur-sm transition"
                data-col-menu-trigger="{{ column.id }}"
                aria-expanded="false"
                onpointerdown="event.stopPropagation();"
                ontouchstart="event.stopPropagation();"
                onclick="event.preventDefault(); event.stopPropagation(); window.__cmToggleColMenu('{{ column.id }}');">
          ‚ãÆ
        </button>

        <div id="col-menu-{{ column.id }}"
             data-col-menu-popover="{{ column.id }}"
             class="hidden absolute right-0 mt-2 w-60 rounded-lg shadow-lg
                    bg-white/90 backdrop-blur-md border border-gray-300 p-3 z-50 text-gray-900
                    max-h-[70vh] overflow-y-auto overscroll-contain">


          <!-- A) Excluir cards (toggle: entrar/sair) -->
          <button type="button"
                  id="col-del-mode-btn-{{ column.id }}"
                  class="w-full text-left text-sm px-3 py-2 rounded-lg
                         bg-gray-900 text-white hover:bg-black transition"
                  onpointerdown="event.stopPropagation();"
                  ontouchstart="event.stopPropagation();"
                  onclick="event.preventDefault(); event.stopPropagation(); window.__cmToggleDeleteCardsOnlyThisColumn('{{ column.id }}');">
            Excluir Cards
          </button>

          <hr class="my-2">

          <!-- A2) Arquivar cards (toggle: entrar/sair) -->
          <button type="button"
                  id="col-arch-mode-btn-{{ column.id }}"
                  class="w-full text-left text-sm px-3 py-2 rounded-lg
                         bg-slate-800 text-white hover:bg-slate-900 transition"
                  onpointerdown="event.stopPropagation();"
                  ontouchstart="event.stopPropagation();"
                  onclick="event.preventDefault(); event.stopPropagation(); window.__cmToggleArchiveCardsOnlyThisColumn('{{ column.id }}');">
            Arquivar Cards
          </button>

          <hr class="my-2">

          <!-- B) Excluir coluna -->
          <button type="button"
                  class="w-full text-left text-sm px-3 py-2 rounded-lg
                         bg-red-600 text-white hover:bg-red-700 transition"
                  onpointerdown="event.stopPropagation();"
                  ontouchstart="event.stopPropagation();"
                  onclick="event.preventDefault(); event.stopPropagation(); if(confirm('Excluir esta coluna e todos os cards nela?')) { htmx.trigger(this, 'confirmed'); }"
                  hx-post="{% url 'boards:delete_column' column.id %}"
                  hx-trigger="confirmed"
                  hx-target="closest .column-item"
                  hx-swap="delete">
            Excluir coluna
          </button>

          <hr class="my-2">

          <!-- C) Alterar cor (abre seletor atual) -->
          <button type="button"
                  class="w-full text-left text-sm px-3 py-2 rounded-lg
                          bg-white/70 border border-gray-200 hover:bg-white transition text-gray-900 hover:text-gray-900"

                  onpointerdown="event.stopPropagation();"
                  ontouchstart="event.stopPropagation();"
                  onclick="event.preventDefault(); event.stopPropagation(); window.__cmToggleColumnColorPicker('{{ column.id }}');">
            Alterar cor
          </button>

          <div id="col-color-picker-{{ column.id }}" class="hidden mt-2">
            <p class="text-xs text-gray-600 mb-2">Cor da coluna:</p>

            <div class="grid grid-cols-5 gap-2">
              {% for value, label in column.THEME_CHOICES %}
                <!-- IMPORTANTE: virou BUTTON (anti-drag no mobile) -->
                <button type="button"
                        class="w-7 h-7 rounded-full cursor-pointer border border-gray-300
                               hover:scale-110 transition"
                        style="background-color: var(--{{ value }}-color);"
                        onpointerdown="event.stopPropagation();"
                        ontouchstart="event.stopPropagation();"
                        onclick="event.preventDefault(); event.stopPropagation();"
                        hx-post="{% url 'boards:set_column_theme' column.id %}"
                        hx-vals='{"theme": "{{ value }}"}'
                        hx-target="closest .column-glass"
                        hx-swap="outerHTML">
                </button>
              {% endfor %}
            </div>
          </div>

          <hr class="my-2">

          <!-- D) Organizar por vencimento -->
          <p class="text-xs text-gray-600 mb-2">Organizar por vencimento:</p>
          <div class="grid grid-cols-2 gap-2">
            <button type="button"
                    class="text-sm px-3 py-2 rounded-lg bg-white/70 border border-gray-200 hover:bg-white transition"
                    onpointerdown="event.stopPropagation();"
                    ontouchstart="event.stopPropagation();"
                    onclick="event.preventDefault(); event.stopPropagation(); window.__cmSortColumnByDue('{{ column.id }}','asc'); window.__cmHideAllColMenus();">
              Asc
            </button>
            <button type="button"
                    class="text-sm px-3 py-2 rounded-lg bg-white/70 border border-gray-200 hover:bg-white transition"
                    onpointerdown="event.stopPropagation();"
                    ontouchstart="event.stopPropagation();"
                    onclick="event.preventDefault(); event.stopPropagation(); window.__cmSortColumnByDue('{{ column.id }}','desc'); window.__cmHideAllColMenus();">
              Desc
            </button>
          </div>

          <hr class="my-2">

          <!-- E) Organizar por data de in√≠cio -->
          <p class="text-xs text-gray-600 mb-2">Organizar por in√≠cio:</p>
          <div class="grid grid-cols-2 gap-2">
            <button type="button"
                    class="text-sm px-3 py-2 rounded-lg bg-white/70 border border-gray-200 hover:bg-white transition"
                    onpointerdown="event.stopPropagation();"
                    ontouchstart="event.stopPropagation();"
                    onclick="event.preventDefault(); event.stopPropagation(); window.__cmSortColumnByStart('{{ column.id }}','asc'); window.__cmHideAllColMenus();">
              Asc
            </button>
            <button type="button"
                    class="text-sm px-3 py-2 rounded-lg bg-white/70 border border-gray-200 hover:bg-white transition"
                    onpointerdown="event.stopPropagation();"
                    ontouchstart="event.stopPropagation();"
                    onclick="event.preventDefault(); event.stopPropagation(); window.__cmSortColumnByStart('{{ column.id }}','desc'); window.__cmHideAllColMenus();">
              Desc
            </button>
          </div>

        </div>
      </div>
    </div>

    <!-- Linha 2: t√≠tulo -->
    <div class="mt-2">
      <span id="column-title-{{ column.id }}"
            data-column-title
            data-column-id="{{ column.id }}"
            contenteditable="plaintext-only"
            spellcheck="false"
            title="{{ column.name }}"
            class="block text-gray-800 font-semibold outline-none cursor-text leading-tight break-words max-w-full"
            style="
              display: -webkit-box;
              -webkit-box-orient: vertical;
              -webkit-line-clamp: 2;
              overflow: hidden;
              white-space: normal;
            ">{{ column.name }}</span>
    </div>
  </div>

  <!-- Form add card (TOPO) -->
  <div id="form-top-col-{{ column.id }}"
       class="shrink-0 px-4 pt-2 pb-2">
  </div>

  <!-- ===================== LISTA DE CARDS (SCROLL AQUI) ===================== -->
  <ul id="cards-col-{{ column.id }}"
      class="flex-1 min-h-0 overflow-y-auto p-4 space-y-3">
    {% for card in column.cards.all %}
      {% include "boards/partials/card_item.html" %}
    {% endfor %}
  </ul>

  <!-- + Card (fim) -->
  <div class="shrink-0 px-4 pb-2">
    <button type="button"
            class="w-full text-left text-sm text-gray-700 hover:text-gray-900
                   px-3 py-2 rounded-lg bg-white/10 backdrop-blur-sm
                   border border-white/30 hover:bg-white/20 transition"
            hx-get="{% url 'boards:add_card' column.id %}?where=bottom"
            hx-target="#form-col-{{ column.id }}"
            hx-swap="innerHTML"
            onpointerdown="event.stopPropagation();"
            ontouchstart="event.stopPropagation();">
      + Card
    </button>
  </div>

  <!-- Form add card (RODAP√â) -->
  <div id="form-col-{{ column.id }}"
       class="shrink-0 p-4">
  </div>

</div>

<script>
(function () {
  // Evita reinstalar as mesmas fun√ß√µes quando o partial renderiza v√°rias colunas
  if (window.__cmColumnMenuFnsInstalled) return;
  window.__cmColumnMenuFnsInstalled = true;

  // =========================
  // Popover do menu da coluna (‚ãÆ)
  // =========================
  function hideMenu(menuEl, triggerEl) {
    if (!menuEl) return;
    menuEl.classList.add("hidden");
    if (triggerEl) triggerEl.setAttribute("aria-expanded", "false");
  }

  function showMenu(menuEl, triggerEl) {
    if (!menuEl) return;
    menuEl.classList.remove("hidden");
    if (triggerEl) triggerEl.setAttribute("aria-expanded", "true");
  }

  function hideAllMenus(exceptMenuEl) {
    document.querySelectorAll("[data-col-menu-popover]").forEach((m) => {
      if (exceptMenuEl && m === exceptMenuEl) return;
      const id = m.getAttribute("data-col-menu-popover");
      const trg = document.querySelector(`[data-col-menu-trigger="${id}"]`);
      hideMenu(m, trg);
    });
  }

  // Expor para usar de outros bot√µes
  window.__cmHideAllColMenus = function () { hideAllMenus(null); };

  function isDeleteCardsModeOn() {
    // modo global do hamburger: mostra .delete-card-btn quando ativo :contentReference[oaicite:2]{index=2}
    return !!document.querySelector(".delete-card-btn:not(.hidden)");
  }

  function updateMenuLabels(colId) {
    // 1) Excluir cards: vira "Sair..." quando o modo est√° ativo nessa coluna
    const delBtn = document.getElementById("col-del-mode-btn-" + colId);
    const activeCol = document.body.dataset.cmDeleteCardsOnlyColumn || "";
    if (delBtn) {
      const activeHere = isDeleteCardsModeOn() && activeCol === String(colId);
      delBtn.textContent = activeHere ? "Sair do modo de exclus√£o" : "Excluir Cards";
    }

    // 2) Arquivar cards: toggle local
    const archBtn = document.getElementById("col-arch-mode-btn-" + colId);
    const activeArchCol = document.body.dataset.cmArchiveCardsOnlyColumn || "";
    if (archBtn) {
      const activeArchHere = activeArchCol === String(colId);
      archBtn.textContent = activeArchHere ? "Sair do modo de arquivar" : "Arquivar Cards";
    }
  }

  // Abre/fecha o menu ‚ãÆ da coluna
  window.__cmToggleColMenu = function (colId) {
    const menu = document.getElementById("col-menu-" + colId);
    const trg  = document.querySelector(`[data-col-menu-trigger="${colId}"]`);
    if (!menu) return;

    const isOpen = !menu.classList.contains("hidden");
    hideAllMenus(menu);

    if (isOpen) {
      hideMenu(menu, trg);
      return;
    }

    updateMenuLabels(colId);
    showMenu(menu, trg);
  };

  // Fecha menus ao clicar fora ou apertar ESC (instala 1x)
  if (!window.__cmColMenuOutsideInstalled) {
    window.__cmColMenuOutsideInstalled = true;

    document.addEventListener("click", (e) => {
      const inside = e.target.closest?.("[data-col-menu-popover], [data-col-menu-trigger]");
      if (inside) return;
      hideAllMenus(null);
    }, true);

    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      hideAllMenus(null);
    }, true);
  }

  // =========================
  // Color picker da coluna
  // =========================
  window.__cmToggleColumnColorPicker = function (colId) {
    const el = document.getElementById("col-color-picker-" + colId);
    if (!el) return;
    el.classList.toggle("hidden");
  };

  // =========================
  // Persist√™ncia da ordem dos cards (backend)
  // =========================
  function getCookie(name) {
    const parts = (`; ${document.cookie}`).split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
    return "";
  }

  function getCSRFToken() {
    const fromInput = document.querySelector("[name=csrfmiddlewaretoken]")?.value || "";
    return fromInput || getCookie("csrftoken");
  }

  window.__cmPersistColumnOrder = async function (colId) {
    const ul = document.getElementById("cards-col-" + colId);
    if (!ul) return;

    const ordered = Array.from(ul.querySelectorAll("li[data-card-id]"))
      .map((li) => Number(li.dataset.cardId))
      .filter((n) => Number.isFinite(n));

    if (!ordered.length) return;

    const csrf = getCSRFToken();
    const endpoint = `/column/${colId}/reorder_cards/`;

    const res = await fetch(endpoint, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrf,
        "X-Requested-With": "XMLHttpRequest",
      },
      body: JSON.stringify({ ordered_card_ids: ordered }),
      credentials: "same-origin",
    });

    if (res.status === 403) {
      const data403 = await res.json().catch(() => ({}));
      alert(data403?.error || "Somente leitura.");
      return;
    }

    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      throw new Error(txt || "Falha ao salvar ordem da coluna.");
    }

    const data = await res.json().catch(() => ({}));
    if (!data || data.ok !== true) throw new Error("Resposta inv√°lida ao salvar ordem.");
  };

  // =========================
  // Helpers de data
  // =========================
  function parseYMD(s) {
    if (!s) return null;
    const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return null;
    const y = Number(m[1]), mo = Number(m[2]) - 1, d = Number(m[3]);
    const dt = new Date(Date.UTC(y, mo, d, 0, 0, 0));
    return isNaN(dt.getTime()) ? null : dt;
  }

  function refreshCountersCompat() {
    if (window.BoardUI && typeof window.BoardUI.refreshColumnCounters === "function") {
      window.BoardUI.refreshColumnCounters();
      return;
    }
    if (typeof window.refreshCounters === "function") {
      window.refreshCounters();
      return;
    }
  }

  // =========================
  // Ordena√ß√£o por DATA DE IN√çCIO (DOM + persist√™ncia)
  // =========================
  window.__cmSortColumnByStart = async function (colId, dir) {
    const ul = document.getElementById("cards-col-" + colId);
    if (!ul) return;

    const items = Array.from(ul.querySelectorAll("li[data-card-id]"));
    if (!items.length) return;

    const indexed = items.map((el, idx) => ({ el, idx }));

    indexed.sort((a, b) => {
      const da = parseYMD(a.el.getAttribute("data-start-date") || "");
      const db = parseYMD(b.el.getAttribute("data-start-date") || "");

      const aMissing = !da;
      const bMissing = !db;
      if (aMissing && bMissing) return a.idx - b.idx;
      if (aMissing) return 1;
      if (bMissing) return -1;

      const diff = da.getTime() - db.getTime();
      if (diff !== 0) return (dir === "desc") ? -diff : diff;
      return a.idx - b.idx;
    });

    indexed.forEach((x) => ul.appendChild(x.el));
    refreshCountersCompat();

    try { await window.__cmPersistColumnOrder(colId); }
    catch (err) { alert(err?.message || "Erro ao persistir ordena√ß√£o."); }
  };

  // =========================
  // Ordena√ß√£o por VENCIMENTO (DOM + persist√™ncia)
  // =========================
  window.__cmSortColumnByDue = async function (colId, dir) {
    const ul = document.getElementById("cards-col-" + colId);
    if (!ul) return;

    const items = Array.from(ul.querySelectorAll("li[data-card-id]"));
    if (!items.length) return;

    const indexed = items.map((el, idx) => ({ el, idx }));

    indexed.sort((a, b) => {
      const da = parseYMD(a.el.getAttribute("data-term-due") || "");
      const db = parseYMD(b.el.getAttribute("data-term-due") || "");

      const aMissing = !da;
      const bMissing = !db;
      if (aMissing && bMissing) return a.idx - b.idx;
      if (aMissing) return 1;
      if (bMissing) return -1;

      const diff = da.getTime() - db.getTime();
      if (diff !== 0) return (dir === "desc") ? -diff : diff;
      return a.idx - b.idx;
    });

    indexed.forEach((x) => ul.appendChild(x.el));
    refreshCountersCompat();

    try { await window.__cmPersistColumnOrder(colId); }
    catch (err) { alert(err?.message || "Erro ao persistir ordena√ß√£o."); }
  };

  // =========================
  // MODO: Excluir cards (somente desta coluna)
  // =========================
  window.__cmToggleDeleteCardsOnlyThisColumn = function (colId) {
    const toggleBtn = document.getElementById("toggle-delete-cards"); // do hamburger :contentReference[oaicite:3]{index=3}
    const activeCol = document.body.dataset.cmDeleteCardsOnlyColumn || "";

    // se j√° est√° ativo nessa coluna -> sair
    if (isDeleteCardsModeOn() && activeCol === String(colId)) {
      document.body.dataset.cmDeleteCardsOnlyColumn = "";
      if (toggleBtn) toggleBtn.click(); // volta para "Excluir cards" :contentReference[oaicite:4]{index=4}
      window.__cmHideAllColMenus();
      updateMenuLabels(colId);
      return;
    }

    // ativa modo global e filtra s√≥ esta coluna
    if (toggleBtn) toggleBtn.click();
    document.body.dataset.cmDeleteCardsOnlyColumn = String(colId);

    setTimeout(() => { window.__cmApplyDeleteCardsOnlyColumn(); }, 0);

    // fecha menu SEMPRE
    window.__cmHideAllColMenus();
  };

  window.__cmApplyDeleteCardsOnlyColumn = function () {
    const onlyColId = document.body.dataset.cmDeleteCardsOnlyColumn || "";
    if (!onlyColId) return;

    document.querySelectorAll(".delete-card-btn").forEach((btn) => {
      const inCol = btn.closest(`.column-item[data-column-id="${onlyColId}"]`);
      btn.style.display = inCol ? "" : "none";
    });
  };

  // =========================
  // MODO: Arquivar cards (somente desta coluna)
  // (requer .archive-card-btn no card_item.html)
  // =========================
  window.__cmToggleArchiveCardsOnlyThisColumn = function (colId) {
    const activeCol = document.body.dataset.cmArchiveCardsOnlyColumn || "";

    // se j√° est√° ativo nessa coluna -> sair
    if (activeCol === String(colId)) {
      document.body.dataset.cmArchiveCardsOnlyColumn = "";
      window.__cmDisableArchiveCardsOnlyColumn();
      window.__cmHideAllColMenus();
      updateMenuLabels(colId);
      return;
    }

    document.body.dataset.cmArchiveCardsOnlyColumn = String(colId);
    window.__cmApplyArchiveCardsOnlyColumn();
    window.__cmHideAllColMenus();
  };

  window.__cmDisableArchiveCardsOnlyColumn = function () {
    document.querySelectorAll(".archive-card-btn").forEach((btn) => {
      btn.classList.add("hidden");
      btn.style.display = "";
    });
  };

  window.__cmApplyArchiveCardsOnlyColumn = function () {
    const onlyColId = document.body.dataset.cmArchiveCardsOnlyColumn || "";
    if (!onlyColId) return;

    document.querySelectorAll(".archive-card-btn").forEach((btn) => {
      const inCol = btn.closest(`.column-item[data-column-id="${onlyColId}"]`);
      if (inCol) {
        btn.classList.remove("hidden");
        btn.style.display = "";
      } else {
        btn.classList.add("hidden");
        btn.style.display = "none";
      }
    });
  };

  // Reaplica filtros ap√≥s swaps do HTMX
  document.body.addEventListener("htmx:afterSwap", () => {
    if (document.body.dataset.cmDeleteCardsOnlyColumn) window.__cmApplyDeleteCardsOnlyColumn();
    if (document.body.dataset.cmArchiveCardsOnlyColumn) window.__cmApplyArchiveCardsOnlyColumn();
  });

  document.body.addEventListener("htmx:afterSettle", () => {
    if (document.body.dataset.cmDeleteCardsOnlyColumn) window.__cmApplyDeleteCardsOnlyColumn();
    if (document.body.dataset.cmArchiveCardsOnlyColumn) window.__cmApplyArchiveCardsOnlyColumn();
  });

  // =========================
  // Follow da coluna (popover) ‚Äî sem modal
  // =========================
  const BOARD_ID = window.BOARD_ID || "0";
  function colFollowKey(colId){ return `colFollow:${BOARD_ID}:${colId}`; }

  function setColEyeState(colId, following) {
    const btn = document.getElementById("col-follow-btn-" + colId);
    if (!btn) return;
    btn.classList.toggle("is-following", !!following);
  }

  // Rehidrata o olho no load (F5)
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("[data-col-follow-btn][data-col-id]").forEach((btn) => {
      const colId = btn.getAttribute("data-col-id");
      const val = localStorage.getItem(colFollowKey(colId));
      if (!val) return;
      setColEyeState(colId, val === "1");
    });
  });

  function hideColFollowPopover(colId) {
    const pop = document.getElementById("col-follow-popover-" + colId);
    const btn = document.getElementById("col-follow-btn-" + colId);
    if (pop) pop.classList.add("hidden");
    if (btn) btn.setAttribute("aria-expanded", "false");
  }

  function showColFollowPopover(colId) {
    const pop = document.getElementById("col-follow-popover-" + colId);
    const btn = document.getElementById("col-follow-btn-" + colId);
    if (pop) pop.classList.remove("hidden");
    if (btn) btn.setAttribute("aria-expanded", "true");
  }

  function hideAllColFollowPopovers(exceptColId) {
    document.querySelectorAll("[id^='col-follow-popover-']").forEach((el) => {
      const id = (el.id || "").replace("col-follow-popover-", "");
      if (exceptColId && String(id) === String(exceptColId)) return;
      el.classList.add("hidden");
      const btn = document.getElementById("col-follow-btn-" + id);
      if (btn) btn.setAttribute("aria-expanded", "false");
    });
  }

  window.__cmToggleColFollowPopover = function (colId) {
    const pop = document.getElementById("col-follow-popover-" + colId);
    if (!pop) return;

    const isOpen = !pop.classList.contains("hidden");

    // fecha outros popovers (e tamb√©m o menu ‚ãÆ para n√£o brigar)
    hideAllColFollowPopovers(colId);
    if (window.__cmHideAllColMenus) window.__cmHideAllColMenus();

    if (isOpen) {
      hideColFollowPopover(colId);
    } else {
      showColFollowPopover(colId);
      const status = document.getElementById("col-follow-status-" + colId);
      if (status) status.textContent = "";
    }
  };

  async function postJSON(url, payload) {
    const csrf = getCSRFToken();
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrf,
        "X-Requested-With": "XMLHttpRequest",
      },
      body: JSON.stringify(payload || {}),
      credentials: "same-origin",
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      throw new Error(data?.error || "Falha ao atualizar seguir coluna.");
    }
    return data;
  }

  function setAllCardsFollowUI(colId, active) {
    const col = document.querySelector(`.column-item[data-column-id="${colId}"]`);
    if (!col) return;

    col.querySelectorAll(".card-follow-btn").forEach((btn) => {
      if (active) btn.classList.add("is-following");
      else btn.classList.remove("is-following");
    });
  }


  function updateColFollowButton(colId, data) {
  const btn = document.getElementById("col-follow-btn-" + colId);
  const status = document.getElementById("col-follow-status-" + colId);
  if (!btn) return;

  if (data?.active) {
    btn.classList.add("is-following");
    btn.title = `Voc√™ segue ${data.followed_count || 0} cards desta coluna (novos cards: ${data.include_new ? "sim" : "n√£o"})`;
    if (status) status.textContent = `Ativo: seguindo ${data.followed_count || 0} cards (novos: ${data.include_new ? "sim" : "n√£o"}).`;

    // ‚úÖ atualiza UI dos cards na hora
    setAllCardsFollowUI(colId, true);

  } else {
    btn.classList.remove("is-following");
    btn.title = "Seguir cards desta coluna";
    if (status) status.textContent = "Inativo.";

    // ‚úÖ se desativou e escolheu parar de seguir atuais, remove verde
    // (se voc√™ quiser respeitar exatamente o checkbox, trate no caller)
    setAllCardsFollowUI(colId, false);
  }
    localStorage.setItem(colFollowKey(colId), data?.active ? "1" : "0");

}


  window.__cmEnableColFollow = async function (colId) {
    const includeNew = !!document.getElementById("col-follow-include-new-" + colId)?.checked;
    const url = `/column/${colId}/follow/`;
    const status = document.getElementById("col-follow-status-" + colId);
    if (status) status.textContent = "Salvando‚Ä¶";

    try {
      const data = await postJSON(url, {
        active: true,
        include_new: includeNew,
        apply_to_existing: true,
      });
      updateColFollowButton(colId, data);
      hideColFollowPopover(colId);
    } catch (e) {
      if (status) status.textContent = (e?.message || "Erro.");
    }
  };

  window.__cmDisableColFollow = async function (colId) {
  const unfollowExisting = !!document.getElementById("col-follow-unfollow-existing-" + colId)?.checked;
  const url = `/column/${colId}/follow/`;
  const status = document.getElementById("col-follow-status-" + colId);
  if (status) status.textContent = "Salvando‚Ä¶";

  try {
    const data = await postJSON(url, {
      active: false,
      unfollow_existing: unfollowExisting,
    });

    updateColFollowButton(colId, data);

    // ‚úÖ se o usu√°rio N√ÉO marcou pra parar de seguir os atuais, mant√©m UI verde dos cards
    if (!unfollowExisting) setAllCardsFollowUI(colId, true);

    hideColFollowPopover(colId);
  } catch (e) {
    if (status) status.textContent = (e?.message || "Erro.");
  }
};


  // Fecha follow popover ao clicar fora / ESC
  if (!window.__cmColFollowOutsideInstalled) {
    window.__cmColFollowOutsideInstalled = true;

    document.addEventListener("click", (e) => {
      const inside = e.target.closest?.("[data-col-follow-scope]");
      if (inside) return;
      hideAllColFollowPopovers(null);
    }, true);

    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      hideAllColFollowPopovers(null);
    }, true);
  }


})();
</script>

<!-- END /boards/templates/boards/partials/column_item.html -->
