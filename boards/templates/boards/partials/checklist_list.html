{# templates/boards/partials/checklist_list.html #}

<div id="checklists-container"
     class="checklists-container space-y-4"
     data-card-id="{{ card.id }}"
     data-reorder-checklists-url="{% url 'boards:checklists_reorder' card.id %}"
     data-reorder-items-url="{% url 'boards:checklist_items_reorder' card.id %}">

  {% for checklist in checklists|default:card.checklists.all %}

    <div class="checklist-block space-y-2"
         data-checklist-id="{{ checklist.id }}">

      <!-- HEADER -->
      <div class="checklist-head flex items-center gap-2">
        <button type="button"
                class="checklist-drag checklist-handle"
                title="Arrastar checklist"
                aria-label="Arrastar checklist">‚ãÆ‚ãÆ</button>

        <input
          type="text"
          value="{{ checklist.title }}"
          class="checklist-title flex-1"
          name="title"
          hx-post="{% url 'boards:checklist_rename' checklist.id %}"
          hx-trigger="change"
          hx-target="#checklists-container"
          hx-swap="outerHTML"
          hx-on::after-request="
            htmx.ajax(
              'GET',
              '{% url 'boards:activity_panel' card.id %}',
              '#cm-activity-panel'
            )
          "
        />

        <button type="button"
                class="checklist-icon-btn danger"
                title="Remover checklist"
                hx-post="{% url 'boards:checklist_delete' checklist.id %}"
                hx-confirm="Remover este checklist?"
                hx-target="#checklists-container"
                hx-swap="outerHTML"
                hx-on::after-request="
                  htmx.ajax(
                    'GET',
                    '{% url 'boards:activity_panel' card.id %}',
                    '#cm-activity-panel'
                  )
                ">
          üóëÔ∏è
        </button>
      </div>
      <!-- /HEADER -->

      <!-- PROGRESS -->
      {# PROGRESS (backend annotate: checklist.total / checklist.done) #}
{% with total=checklist.total|default:0 done=checklist.done|default:0 %}
  {% if total %}
    <div class="checklist-progress">
      <div class="checklist-progress-meta">
        <span>{{ done }}/{{ total }}</span>
      </div>
      <div class="checklist-progress-bar">
        <div class="checklist-progress-fill"
             style="width:{% widthratio done total 100 %}%"></div>
      </div>
    </div>
  {% endif %}
{% endwith %}
      <!-- /PROGRESS -->

      <!-- ITENS -->
      <div class="checklist-items space-y-1 pl-6"
           data-checklist-id="{{ checklist.id }}">
        {% for item in checklist.items.all %}
          {% include "boards/partials/checklist_item.html" %}
        {% empty %}
          <p class="checklist-empty text-sm text-gray-500">
            Nenhum item ainda.
          </p>
        {% endfor %}
      </div>

      <!-- ADD ITEM -->
      <div class="checklist-add mt-2 pl-6">
        <button type="button"
                class="cm-btn checklist-add-open">
          Adicionar um item
        </button>

        <form method="post"
              class="checklist-add-form hidden"
              hx-post="{% url 'boards:checklist_add_item' checklist.id %}"
              hx-target="#checklists-container"
              hx-swap="outerHTML"
              hx-on::after-request="
                htmx.ajax(
                  'GET',
                  '{% url 'boards:activity_panel' card.id %}',
                  '#cm-activity-panel'
                )
              ">
          {% csrf_token %}

          <input type="text"
                 name="text"
                 class="checklist-add-input"
                 placeholder="Nova tarefa‚Ä¶">

          <div class="checklist-add-actions">
            <button type="submit"
                    class="cm-btn primary">
              Adicionar
            </button>
            <button type="button"
                    class="cm-btn checklist-add-cancel">
              Cancelar
            </button>
          </div>
        </form>
      </div>

    </div>

  {% empty %}
    <p class="text-sm text-gray-500">
      Nenhum checklist ainda. Crie o primeiro no campo acima.
    </p>
  {% endfor %}
</div>
