{% load tag_helpers %}

<!-- CONTEÚDO INTERNO DO MODAL DO CARD -->
<!-- IMPORTANTE: NÃO use .card-modal-scroll aqui (já existe no body) -->
<div class="p-4 space-y-4 w-full min-w-0">

  <!-- =======================================================
       FORM ÚNICO (Descrição + Etiquetas)
       - Mantém update_card seguro
       - Savebar sticky top e só aparece quando tiver mudança
       ======================================================= -->
  <form id="card-desc-form" method="post" enctype="multipart/form-data"
        hx-post="{% url 'boards:update_card' card.id %}"
        hx-target="#modal-body" hx-swap="innerHTML">

    {% csrf_token %}

    <!-- SAVE BAR (abaixo das abas, sticky top) -->
    <div id="desc-savebar" class="card-savebar hidden">
      <div class="flex gap-3">
        <button type="submit" onclick="refreshCardSnippet({{ card.id }})"
                class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
          Salvar
        </button>

        <button type="button" onclick="refreshCardSnippet({{ card.id }}); closeModal();"
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
          Fechar
        </button>
      </div>
    </div>

    <!-- =========================
         ABA DESCRIÇÃO
         ========================= -->
    <div id="card-tab-desc" class="card-tab-panel block">

      <label class="block text-sm font-medium mb-1">Título</label>
      <input type="text" name="title" value="{{ card.title }}"
             class="w-full border rounded px-3 py-2 mb-3">

      <label class="block text-sm font-medium mb-1">Descrição</label>
      <div id="quill-editor" class="border rounded mb-2"></div>

      <input type="hidden" id="description-input" name="description"
             value="{{ card.description|default_if_none:'' }}">
    </div>

    <!-- =========================
         ABA ETIQUETAS
         ========================= -->
    <div id="card-tab-tags" class="card-tab-panel hidden">

      <label class="block text-sm font-medium mb-1">Etiquetas</label>
      <input type="text" name="tags" value="{{ card.tags|default_if_none:'' }}"
             class="w-full border rounded px-3 py-2 mb-2">

      {% if card.tags %}
      <div id="tags-preview" class="flex flex-wrap gap-1 mb-2">
        {% for tag in card.tags|split_tags %}
          {% with tag|tag_color as color %}
          <span class="group relative flex items-center text-xs font-semibold px-2 py-1 rounded-md"
                style="background-color: {{ color }}20; color: {{ color }}; border: 1px solid {{ color }};"
                data-tag="{{ tag }}">
            {{ tag }}
            <button type="button"
                    class="ml-1 text-red-600 hover:text-red-900 font-bold opacity-0 group-hover:opacity-100 transition"
                    onclick="removeTagInstant({{ card.id }}, '{{ tag }}')">✕</button>
          </span>
          {% endwith %}
        {% endfor %}
      </div>
      {% endif %}

      <p class="text-xs opacity-70">
        Dica: após alterar etiquetas, o botão “Salvar” aparece automaticamente.
      </p>
    </div>

  </form>

  <!-- =========================
       ABA CHECKLISTS
       (sem scroll interno — usa o scroll único do modal)
       ========================= -->
  <div id="card-tab-check" class="card-tab-panel hidden">

    <form method="post"
          hx-post="{% url 'boards:checklist_add' card.id %}"
          hx-target="#checklist-list"
          hx-swap="innerHTML"
          class="mb-4 space-y-2">

      {% csrf_token %}
      <label class="block text-sm font-medium">Novo checklist</label>

      <div class="flex gap-2">
        <input type="text" name="title"
               class="flex-1 border rounded px-3 py-2 text-sm"
               placeholder="Ex: Tarefas desta semana">
        <button type="submit"
                class="px-3 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
          Adicionar
        </button>
      </div>
    </form>

    <div id="checklist-list" class="space-y-4">
      {% include "boards/partials/checklist_list.html" %}
    </div>

  </div>

  <!-- =========================
       ABA ATIVIDADE (sub-abas: Nova atividade / Histórico / Mover Card)
       ========================= -->
  <div id="card-tab-ativ" class="card-tab-panel hidden">

    <div class="ativ-subtab-wrap">

      <input class="ativ-subtab-radio" type="radio" name="ativ-subtab" id="ativ-tab-new" checked>
      <input class="ativ-subtab-radio" type="radio" name="ativ-subtab" id="ativ-tab-hist">
      <input class="ativ-subtab-radio" type="radio" name="ativ-subtab" id="ativ-tab-move">

      <div class="ativ-subtab-buttons">
        <label for="ativ-tab-new" class="ativ-subtab-btn">Nova atividade</label>
        <label for="ativ-tab-hist" class="ativ-subtab-btn">Histórico</label>
        <label for="ativ-tab-move" class="ativ-subtab-btn">Mover Card</label>

      </div>

      <div class="ativ-subtab-views">

        <!-- VIEW: NOVA ATIVIDADE -->
        <div class="ativ-view ativ-view-new">
          <label class="block text-sm font-medium mb-2">Nova atividade</label>

          <div id="quill-editor-ativ" class="border rounded mb-2"></div>
          <input type="hidden" id="activity-input" name="activity">

          <div class="flex gap-3 mt-3">
            <button type="button"
                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                    onclick="submitActivity({{ card.id }});">
              Incluir
            </button>

            <button type="button"
                    class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
                    onclick="clearActivityEditor()">
              Limpar
            </button>
          </div>
        </div>

        <!-- VIEW: HISTÓRICO -->
        <div class="ativ-view ativ-view-hist hidden">
          {% include "boards/partials/card_activity_panel.html" %}
        </div>

        <!-- VIEW: MOVER CARD -->
        <div class="ativ-view ativ-view-move hidden">
          <div class="p-3 rounded border border-gray-200 bg-white shadow-sm space-y-3">
            <div class="text-sm text-gray-600">
              <div><strong>Local atual:</strong> <span id="move-current-location">carregando…</span></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <label class="block">
                <span class="text-xs text-gray-500">Quadro</span>
                <select id="move-board" class="w-full border border-gray-200 rounded px-2 py-2 text-sm">
                  <option value="">Carregando…</option>
                </select>
              </label>

              <label class="block">
                <span class="text-xs text-gray-500">Coluna</span>
                <select id="move-column" class="w-full border border-gray-200 rounded px-2 py-2 text-sm" disabled>
                  <option value="">Selecione um quadro</option>
                </select>
              </label>

              <label class="block">
                <span class="text-xs text-gray-500">Posição</span>
                <select id="move-position" class="w-full border border-gray-200 rounded px-2 py-2 text-sm" disabled>
                  <option value="">Selecione uma coluna</option>
                </select>
              </label>
            </div>

            <div class="flex items-center justify-end gap-2 pt-2">
              <button type="button"
                      class="px-3 py-2 rounded border border-gray-200 text-sm"
                      onclick="document.getElementById('ativ-tab-hist')?.click();">
                Cancelar
              </button>

              <button type="button"
                      class="px-4 py-2 rounded bg-blue-600 text-white text-sm"
                      id="btn-move-card"
                      onclick="window.submitMoveCard?.({{ card.id }});">
                Mover
              </button>
            </div>

            <p id="move-error" class="text-sm text-red-600 hidden"></p>
          </div>
        </div>

      </div><!-- /.ativ-subtab-views -->

    </div><!-- /.ativ-subtab-wrap -->

  </div><!-- /#card-tab-ativ -->

  <!-- =========================
       ABA ANEXOS
       ========================= -->
  <div id="card-tab-files" class="card-tab-panel hidden">

    <div class="mb-4">
      <label class="block text-sm font-medium mb-2">Enviar novo anexo:</label>

      <input type="file" id="file-upload-input" name="file"
             class="border rounded px-3 py-2 w-full"
             hx-post="{% url 'boards:add_attachment' card.id %}"
             hx-target="#attachments-list"
             hx-swap="beforeend"
             hx-trigger="change"
             hx-encoding="multipart/form-data"
             hx-on="htmx:afterRequest: document.getElementById('attachments-empty')?.remove()" />
    </div>

    <div id="attachments-list" class="space-y-3">
      {% for attachment in card.attachments.all %}
        {% include "boards/partials/attachment_item.html" %}
      {% empty %}
        <div id="attachments-empty" class="p-3 rounded border bg-white/40 backdrop-blur-sm shadow-sm">
          <p class="font-medium text-sm">Nenhum anexo enviado ainda</p>
          <p class="text-xs text-gray-500">Envie um arquivo acima.</p>
        </div>
      {% endfor %}
    </div>

  </div><!-- /#card-tab-files -->

</div>
<!-- FIM DO CONTEÚDO INTERNO DO MODAL DO CARD -->
