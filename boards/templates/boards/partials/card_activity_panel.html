<!-- CARD_ACTIVITY_PANEL.HTML -->
{% load tag_helpers %}

<div id="card-activity-panel" class="flex flex-col">
  <div class="flex items-center justify-between mb-1">
    <h3 class="text-lg font-semibold">Atividade</h3>
  </div>

  <div id="activity-panel-wrapper" class="activity-panel max-h-[60vh] overflow-y-auto pr-2">
    <div class="cm-activity-list space-y-2">

      {% for log in logs|default:card.logs.all|dictsortreversed:"created_at" %}

        <div class="activity-item px-3 py-2 rounded-xl border shadow-sm bg-[var(--cm-surface)] border-[var(--cm-border)]">
          <div class="flex items-start justify-between gap-2">
            <div class="activity-meta text-[11px] text-gray-500 mb-1 leading-none">
              {{ log.created_at|date:"d/m/Y H:i" }}
            </div>

            {% if log.actor %}
              <button
                type="button"
                class="cm-activity-reply-btn text-gray-500 hover:text-gray-800"
                title="Responder"
                aria-label="Responder"
                data-reply-to="{{ log.id }}"
                data-reply-user="{% if log.actor.profile.handle %}@{{ log.actor.profile.handle }}{% else %}{{ log.actor.email }}{% endif %}"
              >â†©</button>
            {% endif %}
          </div>

          <div class="activity-content text-sm leading-snug">
            {% if log.actor %}
              <div class="text-[12px] text-gray-700 mb-1">
                <strong>
                  {% if log.actor.profile.handle %}@{{ log.actor.profile.handle }}{% else %}{{ log.actor.email }}{% endif %}
                </strong>
                <span>Disse:</span>
              </div>
            {% endif %}

            {% if log.attachment %}
              <p class="mb-1">
                <strong>Anexo:</strong>
                <a href="{{ log.attachment.url }}" target="_blank" class="text-blue-600 underline">
                  {{ log.attachment.name|cut:"attachments/" }}
                </a>
              </p>
            {% endif %}

            {{ log.content|safe }}
          </div>

          {% if log.replies.all %}
            <div class="mt-2 space-y-2">
              {% for r in log.replies.all %}
                <div class="pl-3 py-2 rounded-xl border bg-white/40 border-[var(--cm-border)]">
                  <div class="activity-meta text-[11px] text-gray-500 mb-1 leading-none">
                    {{ r.created_at|date:"d/m/Y H:i" }}
                  </div>

                  <div class="text-[12px] text-gray-700 mb-1">
                    <strong>
                      {% if r.actor.profile.handle %}@{{ r.actor.profile.handle }}{% else %}{{ r.actor.email }}{% endif %}
                    </strong>
                    <span>
                      Respondeu ao
                      <strong>
                        {% if log.actor.profile.handle %}@{{ log.actor.profile.handle }}{% else %}{{ log.actor.email }}{% endif %}
                      </strong>
                      que:
                    </span>
                  </div>

                  <div class="activity-content text-sm leading-snug">
                    {{ r.content|safe }}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>

      {% empty %}
        <p class="text-gray-400 text-sm">Nenhuma atividade ainda.</p>
      {% endfor %}

    </div>
  </div>
</div>

<!-- END CARD_ACTIVITY_PANEL.HTML -->
