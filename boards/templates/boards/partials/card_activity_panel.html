{# templates/boards/partials/card_activity_panel.html #}
{% load tag_helpers %}

<div id="card-activity-panel" class="cm-feed-root">

  {# TOOLBAR #}
  <div class="cm-feed-toolbar" id="cm-feed-toolbar">
    <div class="cm-feed-search">
      <span class="cm-feed-ico" aria-hidden="true">üîç</span>
      <input type="text" id="cm-feed-q" placeholder="Buscar" autocomplete="off">
    </div>

    <div class="cm-feed-filter">
      <span class="cm-feed-ico" aria-hidden="true">‚è∑</span>
      <span class="cm-feed-filter-label">Filtros:</span>

      <select id="cm-feed-filter">
        <option value="comments">Coment√°rios</option>
        <option value="files">Arquivos</option>
        <option value="system">Sistema</option>
        <option value="all">Tudo</option>
      </select>
    </div>

    <button type="button" class="cm-feed-iconbtn" id="cm-feed-menu" title="Op√ß√µes" aria-label="Op√ß√µes">
      ‚ò∞
    </button>
  </div>

  {# SCROLL DO FEED #}
  <div id="activity-panel-wrapper" class="activity-panel cm-feed-scroll max-h-[60vh] overflow-y-auto pr-2">
    <div class="cm-feed" id="cm-feed">

      {# IMPORTANTE: logs deve vir do backend j√° DECORADO (lista com cm_type) #}
      {% with logs_list=logs %}
        {% if logs_list %}

          {% for log in logs_list %}
            {% ifchanged log.created_at|date:"d/m/Y" %}
              <div class="cm-feed-dayhdr">{{ log.created_at|date:"d/m/Y" }}</div>
            {% endifchanged %}

            {% with html_l=log.content|default_if_none:""|lower txt_l=log.content_text|default_if_none:""|lower %}
              <article
                class="cm-feed-item"
                data-type="{{ log.cm_type|default:'comments' }}"
                data-text="{{ txt_l|striptags|escape }} {{ html_l|striptags|escape }}"
              >
                <div class="cm-feed-row">

                  {# avatar #}
                  <div class="cm-feed-avatar" aria-hidden="true">
                    {% if log.actor %}
                      {{ log.actor.email|default:"U"|slice:":1"|upper }}
                    {% else %}
                      ‚Ä¢
                    {% endif %}
                  </div>

                  <div class="cm-feed-main">

                    {# HEADER (fora do bal√£o) #}
                    <div class="cm-feed-meta">
                      <span class="cm-feed-handle">
                        {% if log.actor %}
                          {% if log.actor.profile.handle %}
                            @{{ log.actor.profile.handle }}
                          {% else %}
                            {{ log.actor.email }}
                          {% endif %}
                        {% else %}
                          (SISTEMA)
                        {% endif %}
                      </span>

                      <span class="cm-feed-time">{{ log.created_at|date:"H:i" }}</span>

                      {% if log.actor %}
                        <button
                          type="button"
                          class="cm-feed-reply-btn cm-activity-reply-btn"
                          title="Responder"
                          aria-label="Responder"
                          data-reply-to="{{ log.id }}"
                          data-reply-user="{% if log.actor.profile.handle %}@{{ log.actor.profile.handle }}{% else %}{{ log.actor.email }}{% endif %}"
                        >
                          <svg viewBox="0 0 24 24" class="w-4 h-4 opacity-80" fill="currentColor" aria-hidden="true">
                            <path d="M10 9V5L3 12l7 7v-4.1c6 0 9.5 2 11 6-1-8-5-12-11-12z"/>
                          </svg>
                        </button>
                      {% endif %}
                    </div>

                    {# BAL√ÉO #}
                    <div class="cm-feed-bubble">
                      <div class="cm-feed-body">
                        {% if log.content_delta %}
                          {{ log.content_text|linebreaksbr }}
                        {% else %}
                          {{ log.content|safe }}
                        {% endif %}
                      </div>

                      {# anexo expl√≠cito (thumb pequena) #}
                      {% if log.attachment %}
                        <div class="cm-attach">
                          <a
                            class="cm-attach-file"
                            href="{{ log.attachment.url }}"
                            target="_blank"
                            rel="noopener"
                          >
                            {{ log.attachment.name|cut:"attachments/" }}
                          </a>

                          <a
                            href="{{ log.attachment.url }}"
                            target="_blank"
                            rel="noopener"
                            class="cm-attach-thumb"
                            data-preview-src="{{ log.attachment.url }}"
                          >
                            <img src="{{ log.attachment.url }}" alt="">
                            <span class="cm-attach-zoom" aria-hidden="true">üîç</span>
                          </a>
                        </div>
                      {% endif %}

                      {# replies #}
                      {% with replies=log.replies.all %}
                        {% if replies %}
                          <div class="cm-replies">
                            <div class="cm-replies-title">
                              {{ replies|length }} resposta{{ replies|length|pluralize }}
                            </div>

                            {% for r in replies %}
                              <div class="cm-reply">
                                <div class="cm-reply-avatar" aria-hidden="true">
                                  {% if r.actor %}
                                    {{ r.actor.email|default:"U"|slice:":1"|upper }}
                                  {% else %}
                                    ‚Ä¢
                                  {% endif %}
                                </div>

                                <div class="cm-reply-main">
                                  <div class="cm-feed-meta">
                                    <span class="cm-feed-handle">
                                      {% if r.actor %}
                                        {% if r.actor.profile.handle %}
                                          @{{ r.actor.profile.handle }}
                                        {% else %}
                                          {{ r.actor.email }}
                                        {% endif %}
                                      {% else %}
                                        (SISTEMA)
                                      {% endif %}
                                    </span>
                                    <span class="cm-feed-time">{{ r.created_at|date:"H:i" }}</span>
                                  </div>

                                  <div class="cm-feed-bubble">
                                    <div class="cm-feed-body">
                                      {% if r.content_delta %}
                                        {{ r.content_text|linebreaksbr }}
                                      {% else %}
                                        {{ r.content|safe }}
                                      {% endif %}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            {% endfor %}
                          </div>
                        {% endif %}
                      {% endwith %}
                    </div>

                  </div>
                </div>
              </article>
            {% endwith %}

          {% endfor %}

          <div class="cm-feed-foot">
            <button type="button" class="cm-feed-more" id="cm-feed-more">+ Carregar mais</button>

            <button type="button" class="cm-newmsg-pill" id="cm-newmsg-pill" aria-label="Novas mensagens" title="Ir para as novas mensagens">
              <span aria-hidden="true">‚¨á</span>
              <span id="cm-newmsg-count">2</span> novas mensagens
            </button>
          </div>

        {% else %}
          <p class="cm-muted">Nenhuma atividade ainda.</p>
        {% endif %}
      {% endwith %}

    </div>
  </div>

  {# Preview flutuante #}
  <div class="cm-hover-preview" id="cm-hover-preview" aria-hidden="true">
    <img id="cm-hover-img" alt="">
    <div class="cm-hover-footer">
      <span class="cm-muted" id="cm-hover-name">Imagem</span>
      <a class="cm-muted" id="cm-hover-open" target="_blank" rel="noopener">Abrir</a>
      <span class="cm-hover-zoom" id="cm-hover-zoom">500%</span>
    </div>
  </div>

</div>
{# END templates/boards/partials/card_activity_panel.html #}
