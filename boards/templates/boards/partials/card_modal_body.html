{# templates/boards/partials/card_modal_body.html (arquivo completo) #}
{% load tag_helpers %}

{% if card.cover_image %}
  <div class="px-4 pt-4">
    <div class="group relative rounded-xl overflow-hidden border border-white/20">
      <a href="{{ card.cover_image.url }}" target="_blank" rel="noopener" class="block">
        <img src="{{ card.cover_image.url }}" alt="Capa do card" class="w-full object-cover" style="max-height: 260px;">
      </a>

      <button type="button"
              class="absolute top-2 right-2 px-2 py-1 rounded text-xs bg-black/60 text-white
                     opacity-0 group-hover:opacity-100 transition"
              hx-post="{% url 'boards:remove_card_cover' card.id %}"
              hx-target="#modal-body"
              hx-swap="innerHTML"
              aria-label="Remover capa"
              title="Remover capa">
        ‚úï
      </button>
    </div>
  </div>
{% endif %}

<style>
  /* ============================================================
     CM MODAL (card_modal_body.html)
     ============================================================ */

  #cm-root{
    --cm-radius: 14px;
    --cm-radius-sm: 10px;
    --cm-pad: 14px;

    --cm-bg: rgba(255,255,255,0.86);
    --cm-surface: rgba(255,255,255,0.92);
    --cm-surface-2: rgba(250,250,250,0.95);
    --cm-border: rgba(15,23,42,0.12);
    --cm-border-2: rgba(15,23,42,0.08);
    --cm-text: rgba(15,23,42,0.92);
    --cm-muted: rgba(15,23,42,0.62);
    --cm-placeholder: rgba(15,23,42,0.45);

    --cm-accent: rgb(37 99 235);
    --cm-accent-2: rgba(37,99,235,0.12);
    --cm-danger: rgb(220 38 38);

    --cm-shadow: 0 10px 30px rgba(2,6,23,0.10);
    --cm-shadow-sm: 0 6px 18px rgba(2,6,23,0.08);
    --cm-ring: 0 0 0 3px rgba(37,99,235,0.22);
  }

  #card-modal-root.theme-dark #cm-root,
  #card-modal-root.card-theme-dark #cm-root{
    --cm-bg: rgba(2,6,23,0.55);
    --cm-surface: rgba(2,6,23,0.62);
    --cm-surface-2: rgba(15,23,42,0.56);
    --cm-border: rgba(255,255,255,0.14);
    --cm-border-2: rgba(255,255,255,0.10);
    --cm-text: rgba(241,245,249,0.94);
    --cm-muted: rgba(226,232,240,0.72);
    --cm-placeholder: rgba(226,232,240,0.52);
    --cm-accent: rgb(96 165 250);
    --cm-shadow: 0 14px 40px rgba(0,0,0,0.35);
    --cm-shadow-sm: 0 10px 26px rgba(0,0,0,0.30);
    --cm-ring: 0 0 0 3px rgba(59,130,246,0.25);
  }

  html.dark #cm-root{
    --cm-bg: rgba(2,6,23,0.55);
    --cm-surface: rgba(2,6,23,0.62);
    --cm-surface-2: rgba(15,23,42,0.56);
    --cm-border: rgba(255,255,255,0.14);
    --cm-border-2: rgba(255,255,255,0.10);
    --cm-text: rgba(241,245,249,0.94);
    --cm-muted: rgba(226,232,240,0.72);
    --cm-placeholder: rgba(226,232,240,0.52);
    --cm-accent: rgb(96 165 250);
    --cm-shadow: 0 14px 40px rgba(0,0,0,0.35);
    --cm-shadow-sm: 0 10px 26px rgba(0,0,0,0.30);
    --cm-ring: 0 0 0 3px rgba(59,130,246,0.25);
  }

  .cm-wrap{
    padding: 16px;
    width: 100%;
    min-width: 0;
    color: var(--cm-text) !important;
  }

  .cm-card{
    border-radius: var(--cm-radius);
    border: 1px solid var(--cm-border);
    background: var(--cm-surface);
    box-shadow: var(--cm-shadow-sm);
    padding: var(--cm-pad);
  }

  .cm-muted{
    font-size: 12px;
    color: var(--cm-muted) !important;
  }

  .cm-topbar{
    position: sticky;
    top: 0;
    z-index: 10;

    border-radius: var(--cm-radius);
    border: 1px solid var(--cm-border);
    background: var(--cm-bg);
    box-shadow: var(--cm-shadow);
    padding: 10px;
    margin-bottom: 8px;
  }

  .cm-bar{
    display:flex;
    align-items:center;
    gap: 10px;
    width: 100%;
    min-width: 0;
  }

  .cm-tabs{
    display:flex;
    gap: 8px;
    align-items:center;
    min-width: 0;
    flex: 1 1 auto;
    overflow-x: auto;
    scrollbar-width: thin;
    padding-bottom: 2px;
  }
  .cm-tabs::-webkit-scrollbar{ height: 6px; }
  .cm-tabs::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.12); border-radius: 999px; }

  .cm-tabbtn{
    padding: 8px 12px;
    border-radius: 999px;
    font-size: 13px;
    border: 1px solid var(--cm-border-2);
    background: var(--cm-surface-2);
    color: var(--cm-text) !important;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
    transition: transform .12s ease, border-color .12s ease, background .12s ease;
    flex: 0 0 auto;
  }
  .cm-tabbtn:hover{
    transform: translateY(-1px);
    border-color: var(--cm-border);
  }
  .cm-tabbtn.is-active{
    background: linear-gradient(180deg, rgba(37,99,235,0.16), rgba(37,99,235,0.10));
    border-color: rgba(37,99,235,0.38);
    box-shadow: 0 0 0 1px rgba(37,99,235,0.12) inset;
  }

  .cm-actions{
    display:flex;
    gap:8px;
    flex: 0 0 auto;
    align-self:center;
  }

  .cm-btn{
    padding: 8px 12px;
    border-radius: 999px;
    border: 1px solid var(--cm-border-2);
    background: var(--cm-surface-2);
    color: var(--cm-text) !important;
    cursor:pointer;
    font-size: 13px;
    transition: transform .12s ease, filter .12s ease, border-color .12s ease;
    white-space: nowrap;
  }
  .cm-btn:hover{ transform: translateY(-1px); border-color: var(--cm-border); }
  .cm-btn.primary{
    background: var(--cm-accent);
    border-color: rgba(37,99,235,0.85);
    color: #fff !important;
    box-shadow: 0 10px 22px rgba(37,99,235,0.22);
  }
  .cm-btn.primary:hover{ filter: brightness(1.05); }

  .cm-label{
    display:block;
    font-size: 12px;
    margin: 0 0 6px 2px;
    color: var(--cm-muted) !important;
  }

  .cm-input, .cm-textarea, .cm-select{
    width:100%;
    border-radius: var(--cm-radius-sm);
    border: 1px solid var(--cm-border-2);
    background: var(--cm-surface-2);
    color: var(--cm-text) !important;
    padding: 10px 12px;
    outline: none;
    transition: box-shadow .12s ease, border-color .12s ease, background .12s ease;
  }
  .cm-input::placeholder,
  .cm-textarea::placeholder{
    color: var(--cm-placeholder) !important;
  }
  .cm-input:focus,
  .cm-textarea:focus,
  .cm-select:focus{
    border-color: rgba(37,99,235,0.55);
    box-shadow: var(--cm-ring);
    background: var(--cm-surface);
  }

  .cm-textarea{ min-height: 220px; resize: vertical; }

  .cm-panel{ display:none; }
  .cm-panel.is-active{ display:block; }

  #cm-actions{ display:none; }
  #cm-root[data-cm-active="desc"] #cm-actions,
  #cm-root[data-cm-active="tags"] #cm-actions{
    display:flex;
  }

  /* --- Barra fixa de tags (fica entre topbar e conte√∫do) --- */
  #cm-tags-wrap{
    margin-bottom: 10px;
  }
  #cm-tags-bar button{
    cursor: pointer;
  }

  /* Atividade */
  #cm-root #cm-activity-panel,
  #cm-root #cm-activity-panel *{
    color: var(--cm-text) !important;
  }
  #cm-root #cm-activity-panel a{
    color: var(--cm-accent) !important;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  /* Anexos */
  #cm-root #attachments-list a{
    color: var(--cm-accent) !important;
    text-decoration: underline;
    text-underline-offset: 2px;
    font-weight: 600;
  }
  #cm-root #attachments-list a:hover{
    filter: brightness(1.08);
  }

  #attachments-error{ border-radius: 10px; }

  .hidden{ display:none !important; }

  @media (max-width: 1024px){
    .cm-topbar{ padding: 8px; }
    .cm-tabbtn, .cm-btn{ padding: 8px 10px; }
    .cm-wrap{ padding: 12px; }
  }
</style>

{# ‚úÖ IMPORTANTE: data-tag-colors aqui para o JS aplicar as cores salvas #}
<div class="cm-wrap"
     id="cm-root"
     data-card-id="{{ card.id }}"
     data-cm-active="desc"
     data-tag-colors='{{ card.tag_colors|default_if_none:"{}"|escape }}'>

  {# ===================== TOPBAR: s√≥ abas e bot√£o salvar ===================== #}
  <div class="cm-topbar">
    <div class="cm-bar" role="tablist" aria-label="Abas do card">
      <div class="cm-tabs">
        <button type="button" class="cm-tabbtn is-active" data-cm-tab="desc">Descri√ß√£o</button>
        <button type="button" class="cm-tabbtn" data-cm-tab="tags">Etiquetas</button>
        <button type="button" class="cm-tabbtn" data-cm-tab="check">Checklists</button>
        <button type="button" class="cm-tabbtn" data-cm-tab="ativ">Atividade</button>
        <button type="button" class="cm-tabbtn" data-cm-tab="files">Anexos</button>
      </div>

      <div class="cm-actions" id="cm-actions">
        <button type="button" class="cm-btn primary" id="cm-save-btn">Salvar</button>
      </div>
    </div>
  </div>

  {# ===================== TAGS FIXAS NO TOPO (fora da aba) ===================== #}
  <div id="cm-tags-wrap">
    {% include "boards/partials/card_tags_bar.html" %}
  </div>

  {# ‚úÖ Form invis√≠vel + color picker invis√≠vel (para salvar cor via POST) #}
  <form id="cm-tag-color-form"
        class="hidden"
        method="post"
        action="{% url 'boards:set_tag_color' card.id %}"
        onsubmit="return false;">
    {% csrf_token %}
    <input type="hidden" name="tag" id="cm-tag-color-tag">
    <input type="hidden" name="color" id="cm-tag-color-value">
  </form>

  <div id="cm-tag-color-popover"
       class="hidden absolute z-50 mt-2 p-3 rounded-xl border bg-white shadow-lg">
    <div class="flex flex-col gap-3">

      <!-- SELETOR DE COR VIS√çVEL -->
      <input type="color"
             id="cm-tag-color-picker"
             class="w-12 h-12 border rounded cursor-pointer">

      <div class="flex gap-2 justify-end">
        <button type="button"
                class="cm-btn"
                id="cm-tag-color-cancel">
          Cancelar
        </button>

        <button type="button"
                class="cm-btn primary"
                id="cm-tag-color-save">
          Salvar cor
        </button>
      </div>

    </div>
  </div>

  {# ===================== FORM PRINCIPAL (desc + tags) ===================== #}
  <form id="cm-main-form"
        method="post"
        enctype="multipart/form-data"
        hx-post="{% url 'boards:update_card' card.id %}"
        hx-target="#modal-body"
        hx-swap="innerHTML">
    {% csrf_token %}

    <section class="cm-panel is-active" data-cm-panel="desc" role="tabpanel">
      <div class="cm-card space-y-3">
        <div>
          <label class="cm-label">T√≠tulo</label>
          <input type="text" name="title" value="{{ card.title }}" class="cm-input">
        </div>

        <div>
          <label class="cm-label">Descri√ß√£o</label>
          <textarea name="description" class="cm-textarea">{{ card.description|default_if_none:"" }}</textarea>
          <div class="cm-muted" style="margin-top:8px;">
            Observa√ß√£o: aqui vai texto/HTML simples. Se quiser voltar com Quill depois, d√° pra plugar em cima disso.
          </div>
        </div>
      </div>
    </section>

    <section class="cm-panel" data-cm-panel="tags" role="tabpanel">
      <div class="cm-card space-y-3">
        <div>
          <label class="cm-label">Etiquetas (separadas por v√≠rgula)</label>
          <input type="text" name="tags" value="{{ card.tags|default_if_none:"" }}" class="cm-input">
        </div>

        <div class="cm-muted">
          Dica: as etiquetas agora ficam sempre vis√≠veis no topo do modal (clique nelas para escolher a cor).
        </div>
      </div>
    </section>
  </form>

  {# ===================== CHECKLISTS ===================== #}
  <section class="cm-panel" data-cm-panel="check" role="tabpanel">
    <div class="cm-card space-y-3">
      <form method="post"
            hx-post="{% url 'boards:checklist_add' card.id %}"
            hx-target="#checklist-list"
            hx-swap="innerHTML">
        {% csrf_token %}
        <label class="cm-label">Novo checklist</label>
        <div class="flex gap-2">
          <input type="text" name="title" class="cm-input" placeholder="Ex: Tarefas da semana">
          <button type="submit" class="cm-btn primary">Adicionar</button>
        </div>
      </form>

      <div id="checklist-list" class="space-y-4">
        {% include "boards/partials/checklist_list.html" with checklists=checklists %}
      </div>
    </div>
  </section>

  {# ===================== ATIVIDADE ===================== #}
  <section class="cm-panel" data-cm-panel="ativ" role="tabpanel">
    <div class="cm-card space-y-3">
      <form method="post"
            hx-post="{% url 'boards:add_activity' card.id %}"
            hx-target="#cm-activity-panel"
            hx-swap="innerHTML"
            hx-on::after-request="this.reset()">
        {% csrf_token %}

        <div id="activity-error"
             class="hidden mb-2 px-3 py-2 rounded-md text-sm border border-red-500/30 bg-red-500/10 text-red-200"></div>

        <label class="cm-label">Nova atividade</label>
        <textarea name="content" class="cm-textarea" style="min-height:140px;" placeholder="Escreva aqui..."></textarea>

        <div class="flex gap-2">
          <button type="submit" class="cm-btn primary">Incluir</button>
          <button type="button" class="cm-btn"
                  onclick="this.closest('form')?.querySelector('textarea[name=content]')?.value='';">
            Limpar
          </button>
        </div>
      </form>

      <div id="cm-activity-panel">
        {% include "boards/partials/card_activity_panel.html" %}
      </div>
    </div>
  </section>

  {# ===================== ANEXOS ===================== #}
  <section class="cm-panel" data-cm-panel="files" role="tabpanel">
    <div class="cm-card space-y-3">

      <div id="attachments-error"
           class="hidden mb-2 px-3 py-2 rounded-md text-sm border
                  border-red-500/30 bg-red-500/10 text-red-200">
      </div>

      <div>
        <label class="cm-label">Enviar novo anexo</label>

        <div class="flex gap-2 flex-wrap">
          <input type="text"
                 id="attachment-desc"
                 name="description"
                 class="cm-input"
                 style="max-width: 420px;"
                 placeholder="Descri√ß√£o do anexo (opcional)">

          <input type="file" name="file"
                 id="attachment-file"
                 class="cm-input"
                 style="max-width: 520px;"
                 hx-post="{% url 'boards:add_attachment' card.id %}"
                 hx-target="#attachments-list"
                 hx-swap="beforeend"
                 hx-trigger="change"
                 hx-encoding="multipart/form-data"
                 hx-include="#attachment-desc" />
        </div>

        <div class="cm-muted" style="margin-top:6px;">
          Limite: 50MB por arquivo.
        </div>
      </div>

      <div id="attachments-list" class="space-y-3">
        {% for attachment in card.attachments.all %}
          {% include "boards/partials/attachment_item.html" %}
        {% empty %}
          <div class="cm-muted">Nenhum anexo ainda.</div>
        {% endfor %}
      </div>
    </div>
  </section>

</div>

<script>
  (function () {

    function syncModalThemeSafely() {
      const modalRoot = document.getElementById("card-modal-root");
      if (!modalRoot) return;

      const hasAnyTheme =
        modalRoot.classList.contains("theme-dark") ||
        modalRoot.classList.contains("theme-glass") ||
        modalRoot.classList.contains("card-theme-dark") ||
        modalRoot.classList.contains("card-theme-white") ||
        modalRoot.classList.contains("card-theme-aero");

      if (hasAnyTheme) return;

      const isDark = document.documentElement.classList.contains("dark");
      modalRoot.classList.add(isDark ? "theme-dark" : "theme-glass");
    }

    function initRadicalTabs(root) {
      if (!root) return;

      const tabs = root.querySelectorAll("[data-cm-tab]");
      const panels = root.querySelectorAll("[data-cm-panel]");
      if (!tabs.length || !panels.length) return;

      function activate(name) {
        root.dataset.cmActive = name;
        tabs.forEach(b => b.classList.toggle("is-active", b.getAttribute("data-cm-tab") === name));
        panels.forEach(p => p.classList.toggle("is-active", p.getAttribute("data-cm-panel") === name));
      }

      tabs.forEach(b => {
        if (b.dataset.cmBound === "1") return;
        b.dataset.cmBound = "1";

        b.addEventListener("click", () => {
          const name = b.getAttribute("data-cm-tab");
          sessionStorage.setItem("cmActiveTab", name);
          activate(name);
        });
      });

      activate(sessionStorage.getItem("cmActiveTab") || "desc");

      const saveBtn = root.querySelector("#cm-save-btn");
      const form = root.querySelector("#cm-main-form");
      if (saveBtn && form && saveBtn.dataset.cmBound !== "1") {
        saveBtn.dataset.cmBound = "1";
        saveBtn.addEventListener("click", () => {
          try { form.requestSubmit(); } catch (e) { form.submit(); }
        });
      }
    }

    function applySavedTagColors(root) {
      if (!root) return;

      let colors = {};
      try {
        const raw =
          root.dataset.tagColors ||
          root.getAttribute("data-tag-colors") ||
          "{}";

        colors = JSON.parse(raw);
        if (!colors || typeof colors !== "object") colors = {};
      } catch (e) {
        colors = {};
      }

      const wrap = root.querySelector("#cm-tags-wrap");
      if (!wrap) return;

      wrap.querySelectorAll("button[data-tag]").forEach(btn => {
        const tag = btn.getAttribute("data-tag");
        const c = colors[tag];
        if (!c) return;

        btn.style.backgroundColor = c + "20";
        btn.style.color = c;
        btn.style.borderColor = c;
      });
    }

    function initTagColorPicker(root) {
      if (!root) return;

      // üö´ evita m√∫ltiplos binds
      if (root.dataset.cmTagColorBound === "1") return;
      root.dataset.cmTagColorBound = "1";

      const wrap   = root.querySelector("#cm-tags-wrap");
      const picker = root.querySelector("#cm-tag-color-picker");
      const pop    = root.querySelector("#cm-tag-color-popover");
      const save   = root.querySelector("#cm-tag-color-save");
      const cancel = root.querySelector("#cm-tag-color-cancel");
      const form   = root.querySelector("#cm-tag-color-form");
      const inpTag = root.querySelector("#cm-tag-color-tag");
      const inpCol = root.querySelector("#cm-tag-color-value");

      if (!wrap || !picker || !pop || !save || !cancel || !form || !inpTag || !inpCol) return;

      let currentBtn = null;

      wrap.addEventListener("click", function (e) {
        const btn = e.target.closest(".cm-tag-btn");
        if (!btn) return;

        currentBtn = btn;
        const tag = btn.dataset.tag;

        let colors = {};
        try {
          colors = JSON.parse(
            root.dataset.tagColors ||
            root.getAttribute("data-tag-colors") ||
            "{}"
          );
        } catch {}

        picker.value = colors[tag] || "#3b82f6";

        const rect = btn.getBoundingClientRect();
        pop.style.top  = rect.bottom + window.scrollY + "px";
        pop.style.left = rect.left  + window.scrollX + "px";

        pop.classList.remove("hidden");
      });

      cancel.addEventListener("click", function () {
        pop.classList.add("hidden");
        currentBtn = null;
      });

      save.addEventListener("click", function () {
        if (!currentBtn) return;

        const tag   = currentBtn.dataset.tag;
        const color = picker.value;

        // 1Ô∏è‚É£ Atualiza visual imediatamente
        currentBtn.style.backgroundColor = color + "20";
        currentBtn.style.color = color;
        currentBtn.style.borderColor = color;

        // 2Ô∏è‚É£ Atualiza estado local do modal (picker)
        let colors = {};
        try {
          colors = JSON.parse(
            root.dataset.tagColors ||
            root.getAttribute("data-tag-colors") ||
            "{}"
          );
        } catch {}

        colors[tag] = color;
        root.dataset.tagColors = JSON.stringify(colors);

        // 3Ô∏è‚É£ Prepara payload
        inpTag.value = tag;
        inpCol.value = color;

        pop.classList.add("hidden");

        // 4Ô∏è‚É£ Envio MANUAL
        fetch(form.action, {
          method: "POST",
          credentials: "same-origin",
          body: new FormData(form),
          headers: {
            "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
          .then(r => {
            if (!r.ok) throw new Error("Falha ao salvar cor da tag");
            return r.json();
          })
          .then(data => {
            // 5Ô∏è‚É£ Atualiza barra de tags do modal
            const wrap = document.getElementById("cm-tags-wrap");
            if (wrap && data.modal) wrap.innerHTML = data.modal;

            // 6Ô∏è‚É£ Atualiza snippet do card na board
            const cardEl = document.getElementById("card-" + data.card_id);
            if (cardEl && data.snippet) cardEl.outerHTML = data.snippet;

            // 7Ô∏è‚É£ Rebind seguro
            const root = document.getElementById("cm-root");
            applySavedTagColors(root);
            initTagColorPicker(root);
          })
          .catch(err => {
            console.error(err);
          });
      });
    }

    function initAttachmentErrors(root) {
      if (!root) return;
      if (root.dataset.cmAttachBound === "1") return;
      root.dataset.cmAttachBound = "1";

      function fileEl() { return root.querySelector("#attachment-file"); }
      function descEl() { return root.querySelector("#attachment-desc"); }

      function showAttachmentError(msg) {
        const box = root.querySelector("#attachments-error");
        if (!box) return;
        box.textContent = msg;
        box.classList.remove("hidden");
      }

      function clearAttachmentError() {
        const box = root.querySelector("#attachments-error");
        if (!box) return;
        box.textContent = "";
        box.classList.add("hidden");
      }

      function resetAttachmentFields() {
        const f = fileEl();
        const d = descEl();
        if (f) f.value = "";
        if (d) d.value = "";
      }

      root.addEventListener("change", function (e) {
        if (e.target && e.target.matches("#attachment-file")) {
          clearAttachmentError();
        }
      });

      document.body.addEventListener("htmx:beforeRequest", function (evt) {
        const elt = evt.detail && evt.detail.elt;
        if (!elt || !elt.matches || !elt.matches("#attachment-file")) return;

        root.dataset.cmUploading = "1";
        root.dataset.cmLastAttachmentDesc = (descEl()?.value || "").trim();
      });

      document.body.addEventListener("htmx:afterSwap", function (evt) {
        const target = evt.target;
        if (!target || target.id !== "attachments-list") return;
        if (root.dataset.cmUploading !== "1") return;

        resetAttachmentFields();
        clearAttachmentError();

        const desc = (root.dataset.cmLastAttachmentDesc || "").trim();
        if (desc) {
          const last = target.lastElementChild;
          if (last) {
            const already = last.querySelector(".cm-attach-desc");
            if (!already) {
              const div = document.createElement("div");
              div.className = "cm-muted cm-attach-desc";
              div.style.marginTop = "4px";
              div.textContent = desc;
              last.appendChild(div);
            }
          }
        }

        root.dataset.cmUploading = "0";
        root.dataset.cmLastAttachmentDesc = "";
      });

      document.body.addEventListener("htmx:responseError", function (evt) {
        const elt = evt.detail && evt.detail.elt;
        const xhr = evt.detail && evt.detail.xhr;

        if (!elt || !elt.matches || !elt.matches("#attachment-file")) return;

        if (xhr && xhr.status === 413) {
          showAttachmentError("Arquivo acima de 50MB. O limite de anexo √© 50MB. Comprima o arquivo ou envie um link (Drive/Dropbox) e tente novamente.");
        } else {
          showAttachmentError("N√£o foi poss√≠vel enviar o anexo agora. Tente novamente.");
        }

        resetAttachmentFields();
        root.dataset.cmUploading = "0";
        root.dataset.cmLastAttachmentDesc = "";
      });

      document.body.addEventListener("htmx:afterRequest", function (evt) {
        const elt = evt.detail && evt.detail.elt;
        const xhr = evt.detail && evt.detail.xhr;
        if (!elt || !elt.matches || !elt.matches("#attachment-file")) return;

        if (xhr && (xhr.status >= 200 && xhr.status < 300)) {
          resetAttachmentFields();
          clearAttachmentError();
          root.dataset.cmUploading = "0";
          root.dataset.cmLastAttachmentDesc = "";
        }
      });
    }

    function initActivityErrorsOnce() {
      if (document.body.dataset.cmActivityErrBound === "1") return;
      document.body.dataset.cmActivityErrBound = "1";

      document.body.addEventListener("htmx:responseError", function (evt) {
        const elt = evt.detail && evt.detail.elt;
        const xhr = evt.detail && evt.detail.xhr;

        if (!elt || !elt.matches || !elt.matches('form[hx-post*="add_activity"]')) return;

        const box = document.getElementById("activity-error");
        if (box) {
          box.textContent = (xhr && xhr.responseText) ? xhr.responseText : "N√£o foi poss√≠vel incluir a atividade.";
          box.classList.remove("hidden");
        }

        try { elt.reset(); } catch (e) {}
      });
    }

    function boot() {
      syncModalThemeSafely();

      const root = document.getElementById("cm-root");
      if (!root) return;

      // inicializa o state do picker com o JSON vindo do backend
      if (!root.dataset.tagColors) {
        root.dataset.tagColors = root.getAttribute("data-tag-colors") || "{}";
      }

      initRadicalTabs(root);
      initAttachmentErrors(root);
      initTagColorPicker(root);
      applySavedTagColors(root);
      initActivityErrorsOnce();
    }

    function maybeBootFrom(target) {
      if (!target) return;

      if (target.id === "modal-body") return boot();

      if (target.querySelector && target.querySelector("#cm-root")) return boot();
    }

    document.addEventListener("DOMContentLoaded", boot);

    document.body.addEventListener("htmx:load", function (evt) {
      maybeBootFrom(evt.target);
    });

    document.body.addEventListener("htmx:afterSwap", function (evt) {
      maybeBootFrom(evt.target);

      const t = evt.target;
      if (t && t.id === "cm-tags-wrap") {
        const root = document.getElementById("cm-root");
        applySavedTagColors(root);
      }
    });

  })();
</script>
