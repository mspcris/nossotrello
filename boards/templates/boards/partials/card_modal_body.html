{% load tag_helpers %}

<div id="card-modal-root" class="flex flex-col max-h-[80vh]">

    <!-- ================== HEADER ================== -->
    <div class="flex items-center justify-between px-4 py-3 border-b bg-white/80 backdrop-blur-md">

        <!-- bolinhas de tema -->
        <div class="flex gap-2">
            <button type="button" class="w-4 h-4 rounded-full border border-gray-300 bg-white"
                onclick="cardSetTheme('white')"></button>
            <button type="button" class="w-4 h-4 rounded-full border border-gray-300 bg-white/10 backdrop-blur-md"
                onclick="cardSetTheme('aero')"></button>
            <button type="button" class="w-4 h-4 rounded-full border border-gray-300 bg-[#1e1e1e]"
                onclick="cardSetTheme('dark')"></button>
        </div>

        <div class="flex items-center gap-3">
            <!-- √°rea direita vazia; bot√£o de tela cheia fica apenas no modal global (base.html) -->
        </div>

    </div> <!-- FIM DO HEADER -->



    <!-- ================== ABAS ================== -->
    <div class="flex border-b bg-white/80 backdrop-blur">
        <button type="button" class="card-tab-btn card-tab-active" data-tab-target="card-tab-desc"
            onclick="cardOpenTab('card-tab-desc')">Descri√ß√£o</button>

        <button type="button" class="card-tab-btn" data-tab-target="card-tab-check"
            onclick="cardOpenTab('card-tab-check')">Checklists</button>

        <button type="button" class="card-tab-btn" data-tab-target="card-tab-ativ"
            onclick="cardOpenTab('card-tab-ativ')">Atividade</button>
    </div>

    <!-- ================== CONTE√öDO ================== -->
    <div class="flex-1 overflow-y-auto p-5 space-y-6">

        <!-- -------- ABA DESCRI√á√ÉO -------- -->
        <div id="card-tab-desc" class="card-tab-panel block">

            <form method="post" enctype="multipart/form-data" hx-post="{% url 'boards:update_card' card.id %}"
                hx-target="#modal-body" hx-swap="innerHTML"
                hx-on::after-request="htmx.ajax('GET', '{% url 'boards:card_snippet' card.id %}', '#card-{{ card.id }}')">



                {% csrf_token %} <label class="block text-sm font-medium mb-1">T√≠tulo</label>
                <input type="text" name="title" value="{{ card.title }}" class="w-full border rounded px-3 py-2 mb-4">

                <label class="block text-sm font-medium mb-1">Descri√ß√£o</label>
                <div id="quill-editor" class="border rounded mb-2"></div>
                <input type="hidden" id="description-input" name="description"
                    value="{{ card.description|default_if_none:'' }}">

                <label class="block text-sm font-medium mb-1 mt-4">Etiquetas (separadas por v√≠rgula)</label>
                <input type="text" name="tags" value="{{ card.tags|default_if_none:'' }}"
                    class="w-full border rounded px-3 py-2 mb-2" placeholder="Ex.: urgente, revis√£o, cliente X">


                {% if card.tags %}
                <div id="tags-preview" class="flex flex-wrap gap-1 mb-4">
                    {% for tag in card.tags|split_tags %}
                    {% with tag|tag_color as color %}
                    <span class="group relative flex items-center text-xs font-semibold px-2 py-1 rounded-md"
                        style="background-color: {{ color }}20; color: {{ color }}; border: 1px solid {{ color }};"
                        data-tag="{{ tag }}">
                        {{ tag }}

                        <button type="button"
                            class="ml-1 text-red-600 hover:text-red-900 font-bold opacity-0 group-hover:opacity-100 transition"
                            onclick="removeTagInstant({{ card.id }}, '{{ tag }}')">
                            ‚úï
                        </button>


                    </span>
                    {% endwith %}
                    {% endfor %}
                </div>
                {% endif %}


                <label class="block text-sm font-medium mb-1 mt-4">Anexos</label>
                <input type="file" name="attachment" class="mb-4">

                <div id="attachment-area" class="mt-2">
                    {% if card.attachment %}
                    <div class="mt-3 relative" id="attachment-box">

                        <p class="text-sm font-medium mb-1">Arquivo atual:</p>

                        <a href="{{ card.attachment.url }}" target="_blank"
                            class="text-blue-600 hover:underline text-sm block mb-1">
                            {{ card.attachment.name }}
                        </a>

                        {% with ext=card.attachment.url|lower %}
                        {% if ext|slice:"-4:" == ".png" or ext|slice:"-4:" == ".jpg" or ext|slice:"-5:" == ".jpeg" %}
                        <img src="{{ card.attachment.url }}" class="mt-2 max-h-40 rounded">
                        {% endif %}
                        {% endwith %}

                        <button type="button" class="absolute top-1 right-1 bg-red-600 text-white px-2 py-1 rounded"
                            onclick="event.stopPropagation();" hx-post="{% url 'boards:delete_attachment' card.id %}"
                            hx-target="#modal-body" hx-swap="innerHTML" hx-confirm="Remover este anexo?">‚úï</button>

                    </div>
                    {% endif %}
                </div>

                <div class="mt-6 flex gap-3">
                    <button type="submit" onclick="refreshCardSnippet({{ card.id }})"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Salvar
                    </button>


                    <button type="button" onclick="refreshCardSnippet({{ card.id }}); closeModal();"
                        class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
                        Fechar
                    </button>


                </div>

            </form>
        </div>

        <!-- -------- ABA CHECKLISTS -------- -->
        <div id="card-tab-check" class="card-tab-panel hidden opacity-60 text-gray-500">
            Checklists ser√£o implementados depois.
        </div>

        <!-- -------- ABA ATIVIDADE -------- -->
        <div id="card-tab-ativ" class="card-tab-panel hidden">

            <h3 class="text-lg font-semibold mb-2">Atividade</h3>

            <div class="space-y-3">
                {% for log in card.logs.all %}
                <div class="p-3 border rounded bg-gray-50">

                    <div class="text-sm text-gray-600 mb-1">
                        {{ log.created_at|date:"d/m/Y H:i" }}
                    </div>

                    <div class="text-sm">{{ log.content|safe }}</div>

                    {% if log.attachment %}
                    <div class="mt-2">
                        <a href="{{ log.attachment.url }}" target="_blank" class="text-blue-600 underline">Arquivo
                            anexado</a>
                    </div>
                    {% endif %}

                </div>
                {% empty %}
                <p class="text-gray-400 text-sm">Nenhuma atividade ainda.</p>
                {% endfor %}
            </div>

        </div>

    </div>

</div>

<style>
    .card-tab-btn {
        padding: 10px 16px;
        font-size: 0.9rem;
        border-bottom: 2px solid transparent;
        color: #4b5563;
    }

    .card-tab-btn.card-tab-active {
        font-weight: 600;
        color: #111827;
        border-bottom-color: #3b82f6;
    }

    .card-tab-panel.hidden {
        display: none;
    }
</style>
<script>
    function cardOpenTab(panelId) {
        document.querySelectorAll('.card-tab-btn').forEach(btn => {
            btn.classList.toggle('card-tab-active',
                btn.getAttribute('data-tab-target') === panelId);
        });

        document.querySelectorAll('.card-tab-panel').forEach(p => {
            p.classList.toggle('hidden', p.id !== panelId);
        });

        // salva aba ativa
        sessionStorage.setItem('modalActiveTab', panelId);
    }

    function cardSetTheme(mode) {
        const root = document.getElementById('card-modal-root');
        root.classList.remove('card-theme-white', 'card-theme-aero', 'card-theme-dark');

        if (mode === 'white') root.classList.add('card-theme-white');
        else if (mode === 'aero') root.classList.add('card-theme-aero');
        else if (mode === 'dark') root.classList.add('card-theme-dark');
    }

    function cardToggleFull() {
        const root = document.getElementById('card-modal-root');
        root.classList.toggle('max-h-[80vh]');
        root.classList.toggle('h-[90vh]');
    }

    // ==========================================================
    // üöÄ REMOVER TAG IMEDIATAMENTE (com backend + log + snippet)
    // ==========================================================
    async function removeTagInstant(cardId, tag) {

        const csrf = document.querySelector("input[name='csrfmiddlewaretoken']").value;

        const formData = new FormData();
        formData.append("tag", tag);

        // chamada ao backend
        let response = await fetch(`/card/${cardId}/remove_tag/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": csrf
            },
            body: formData
        });

        if (!response.ok) {
            console.error("Erro ao remover tag");
            return;
        }

        let data = await response.json();

        // 1) atualiza modal
        document.querySelector("#modal-body").innerHTML = data.modal;

        // 2) atualiza snippet do card no board
        const cardDiv = document.querySelector(`#card-${data.card_id}`);
        if (cardDiv) {
            cardDiv.outerHTML = data.snippet;
        }

        // 3) restaura aba ativa
        const activeTab = sessionStorage.getItem("modalActiveTab") || "card-tab-desc";
        cardOpenTab(activeTab);

        // 4) reinicializar Quill (mesmo processo usado no modal.js)
        const hiddenInput = document.getElementById("description-input");

        if (hiddenInput) {
            const quill = new Quill("#quill-editor", {
                theme: "snow",
                modules: {
                    toolbar: [
                        [{ header: [1, 2, 3, false] }],
                        ["bold", "italic", "underline"],
                        ["link", "image"],
                        [{ list: "ordered" }, { list: "bullet" }]
                    ]
                }
            });

            quill.root.innerHTML = hiddenInput.value || "";

            quill.on("text-change", () => {
                hiddenInput.value = quill.root.innerHTML;
            });
        }
    }
</script>