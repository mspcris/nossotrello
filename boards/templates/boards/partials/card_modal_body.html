{% load tag_helpers %}

{% if card.cover_image %}
  <div class="px-4 pt-4">
    <div class="group relative rounded-xl overflow-hidden border border-white/20">
      <a href="{{ card.cover_image.url }}" target="_blank" rel="noopener" class="block">
        <img src="{{ card.cover_image.url }}" alt="Capa do card" class="w-full object-cover" style="max-height: 260px;">
      </a>

      <button type="button"
              class="absolute top-2 right-2 px-2 py-1 rounded text-xs bg-black/60 text-white
                     opacity-0 group-hover:opacity-100 transition"
              hx-post="{% url 'boards:remove_card_cover' card.id %}"
              hx-target="#modal-body"
              hx-swap="innerHTML"
              aria-label="Remover capa"
              title="Remover capa">
        ✕
      </button>
    </div>
  </div>
{% endif %}

<style>
  /* ============================================================
     CM MODAL (card_modal_body.html) — Light/Dark legível e moderno
     - Sem blur (base.css força backdrop-filter:none)
     - Contraste forte em checklist/anexos
     - Fallback: se o root não estiver com .theme-dark, usa html.dark
     ============================================================ */

  /* ---------- Tokens ---------- */
  #cm-root{
    --cm-radius: 14px;
    --cm-radius-sm: 10px;
    --cm-pad: 14px;

    /* Light (default) */
    --cm-bg: rgba(255,255,255,0.86);
    --cm-surface: rgba(255,255,255,0.92);
    --cm-surface-2: rgba(250,250,250,0.95);
    --cm-border: rgba(15,23,42,0.12);
    --cm-border-2: rgba(15,23,42,0.08);
    --cm-text: rgba(15,23,42,0.92);
    --cm-muted: rgba(15,23,42,0.62);
    --cm-placeholder: rgba(15,23,42,0.45);

    --cm-accent: rgb(37 99 235);
    --cm-accent-2: rgba(37,99,235,0.12);
    --cm-danger: rgb(220 38 38);

    --cm-shadow: 0 10px 30px rgba(2,6,23,0.10);
    --cm-shadow-sm: 0 6px 18px rgba(2,6,23,0.08);
    --cm-ring: 0 0 0 3px rgba(37,99,235,0.22);
  }

  /* Dark override (quando o root estiver certo) */
  #card-modal-root.theme-dark #cm-root,
  #card-modal-root.card-theme-dark #cm-root{
    --cm-bg: rgba(2,6,23,0.55);
    --cm-surface: rgba(2,6,23,0.62);
    --cm-surface-2: rgba(15,23,42,0.56);
    --cm-border: rgba(255,255,255,0.14);
    --cm-border-2: rgba(255,255,255,0.10);
    --cm-text: rgba(241,245,249,0.94);
    --cm-muted: rgba(226,232,240,0.70);
    --cm-placeholder: rgba(226,232,240,0.50);

    --cm-shadow: 0 14px 40px rgba(0,0,0,0.35);
    --cm-shadow-sm: 0 10px 26px rgba(0,0,0,0.30);
    --cm-ring: 0 0 0 3px rgba(59,130,246,0.25);
  }

  /* Fallback caso o root NÃO esteja com theme-dark, mas o site esteja em dark */
  html.dark #cm-root{
    --cm-bg: rgba(2,6,23,0.55);
    --cm-surface: rgba(2,6,23,0.62);
    --cm-surface-2: rgba(15,23,42,0.56);
    --cm-border: rgba(255,255,255,0.14);
    --cm-border-2: rgba(255,255,255,0.10);
    --cm-text: rgba(241,245,249,0.94);
    --cm-muted: rgba(226,232,240,0.70);
    --cm-placeholder: rgba(226,232,240,0.50);
    --cm-shadow: 0 14px 40px rgba(0,0,0,0.35);
    --cm-shadow-sm: 0 10px 26px rgba(0,0,0,0.30);
    --cm-ring: 0 0 0 3px rgba(59,130,246,0.25);
  }

  /* ---------- Layout base ---------- */
  .cm-wrap{
    padding: 16px;
    width: 100%;
    min-width: 0;
    color: var(--cm-text) !important;
  }

  .cm-card{
    border-radius: var(--cm-radius);
    border: 1px solid var(--cm-border);
    background: var(--cm-surface);
    box-shadow: var(--cm-shadow-sm);
    padding: var(--cm-pad);
  }

  .cm-muted{
    font-size: 12px;
    color: var(--cm-muted) !important;
  }

  /* ---------- Topbar / Tabs ---------- */
  .cm-topbar{
    position: sticky;
    top: 0;
    z-index: 10;

    border-radius: var(--cm-radius);
    border: 1px solid var(--cm-border);
    background: var(--cm-bg);
    box-shadow: var(--cm-shadow);
    padding: 10px;
    margin-bottom: 12px;
  }

  .cm-tabs{
    display:flex;
    flex-wrap:wrap;
    gap: 8px;
    align-items:center;
  }

  .cm-tabbtn{
    padding: 8px 12px;
    border-radius: 999px;
    font-size: 13px;
    border: 1px solid var(--cm-border-2);
    background: var(--cm-surface-2);
    color: var(--cm-text) !important;
    cursor: pointer;
    user-select: none;
    transition: transform .12s ease, border-color .12s ease, background .12s ease;
  }
  .cm-tabbtn:hover{
    transform: translateY(-1px);
    border-color: var(--cm-border);
  }
  .cm-tabbtn.is-active{
    background: linear-gradient(180deg, rgba(37,99,235,0.16), rgba(37,99,235,0.10));
    border-color: rgba(37,99,235,0.38);
    box-shadow: 0 0 0 1px rgba(37,99,235,0.12) inset;
  }

  .cm-actions{
    margin-left:auto;
    display:flex;
    gap:8px;
  }

  .cm-btn{
    padding: 8px 12px;
    border-radius: 999px;
    border: 1px solid var(--cm-border-2);
    background: var(--cm-surface-2);
    color: var(--cm-text) !important;
    cursor:pointer;
    font-size: 13px;
    transition: transform .12s ease, filter .12s ease, border-color .12s ease;
  }
  .cm-btn:hover{ transform: translateY(-1px); border-color: var(--cm-border); }
  .cm-btn.primary{
    background: var(--cm-accent);
    border-color: rgba(37,99,235,0.85);
    color: #fff !important;
    box-shadow: 0 10px 22px rgba(37,99,235,0.22);
  }
  .cm-btn.primary:hover{ filter: brightness(1.05); }

  /* ---------- Campos ---------- */
  .cm-label{
    display:block;
    font-size: 12px;
    margin: 0 0 6px 2px;
    color: var(--cm-muted) !important;
  }

  .cm-input, .cm-textarea, .cm-select{
    width:100%;
    border-radius: var(--cm-radius-sm);
    border: 1px solid var(--cm-border-2);
    background: var(--cm-surface-2);
    color: var(--cm-text) !important;
    padding: 10px 12px;
    outline: none;
    transition: box-shadow .12s ease, border-color .12s ease, background .12s ease;
  }
  .cm-input::placeholder,
  .cm-textarea::placeholder{
    color: var(--cm-placeholder) !important;
  }
  .cm-input:focus,
  .cm-textarea:focus,
  .cm-select:focus{
    border-color: rgba(37,99,235,0.55);
    box-shadow: var(--cm-ring);
    background: var(--cm-surface);
  }

  .cm-textarea{ min-height: 220px; resize: vertical; }

  /* ---------- Panel toggling ---------- */
  .cm-panel{ display:none; }
  .cm-panel.is-active{ display:block; }

  /* ---------- Checklist ---------- */
  #cm-root .checklists-container,
  #cm-root .checklist-block,
  #cm-root .checklist-items{
    color: var(--cm-text) !important;
  }

  #cm-root .checklist-head{
    padding: 8px 10px;
    border-radius: var(--cm-radius-sm);
    border: 1px solid var(--cm-border-2);
    background: var(--cm-surface-2);
  }

  #cm-root .checklist-title{
    width: 100%;
    border-radius: 10px;
    border: 1px solid transparent;
    background: transparent;
    color: var(--cm-text) !important;
    padding: 8px 10px;
    outline: none;
  }
  #cm-root .checklist-title:focus{
    border-color: rgba(37,99,235,0.55);
    box-shadow: var(--cm-ring);
    background: var(--cm-surface);
  }

  #cm-root .checklist-item{
    border-radius: 10px;
    border: 1px solid transparent;
  }
  #cm-root .checklist-item:hover{
    background: rgba(2,6,23,0.04);
    border-color: var(--cm-border-2);
  }
  #card-modal-root.theme-dark #cm-root .checklist-item:hover,
  #card-modal-root.card-theme-dark #cm-root .checklist-item:hover,
  html.dark #cm-root .checklist-item:hover{
    background: rgba(255,255,255,0.06);
    border-color: rgba(255,255,255,0.10);
  }

  #cm-root .checklist-input{
    color: var(--cm-text) !important;
    background: transparent !important;
  }
  #cm-root .checklist-input:focus{
    background: var(--cm-surface) !important;
    border-color: rgba(37,99,235,0.55) !important;
    box-shadow: var(--cm-ring) !important;
  }

  #cm-root .checklist-empty{
    margin: 6px 2px 0 2px;
    color: var(--cm-muted) !important;
    font-size: 12px;
  }

  #cm-root .checklist-icon-btn,
  #cm-root .item-del{ border-radius: 10px; }

  #cm-root .checklist-icon-btn.danger{
    color: var(--cm-danger) !important;
    border: 1px solid rgba(220,38,38,0.22);
    background: rgba(220,38,38,0.06);
    padding: 6px 10px;
  }
  #cm-root .checklist-icon-btn.danger:hover{
    background: rgba(220,38,38,0.10);
    border-color: rgba(220,38,38,0.35);
  }

  #cm-root .checklist-add{
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px dashed var(--cm-border-2);
  }
  #cm-root .checklist-add-open{
    background: transparent;
    border: 1px solid var(--cm-border-2);
    color: var(--cm-text) !important;
    padding: 8px 10px;
    border-radius: 10px;
    cursor: pointer;
  }
  #cm-root .checklist-add-open:hover{
    border-color: var(--cm-border);
    background: rgba(37,99,235,0.06);
  }
  #cm-root .checklist-add-input{
    width: 100%;
    border-radius: 10px;
    border: 1px solid var(--cm-border-2);
    background: var(--cm-surface-2);
    color: var(--cm-text) !important;
    padding: 10px 12px;
    outline: none;
  }
  #cm-root .checklist-add-actions{ display:flex; gap:8px; margin-top: 8px; }
  #cm-root .checklist-add-btn{
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid rgba(37,99,235,0.85);
    background: var(--cm-accent);
    color: #fff !important;
    cursor: pointer;
  }
  #cm-root .checklist-add-cancel{
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid var(--cm-border-2);
    background: var(--cm-surface-2);
    color: var(--cm-text) !important;
    cursor: pointer;
  }

  /* ---------- Anexos ---------- */
  #cm-root #attachments-list a{
    color: var(--cm-accent) !important;
    text-decoration: none;
    font-weight: 600;
  }
  #cm-root #attachments-list a:hover{
    text-decoration: underline;
    filter: brightness(1.05);
  }

  /* ---------- Foco ---------- */
  .cm-tabbtn:focus-visible,
  .cm-btn:focus-visible,
  .cm-input:focus-visible,
  .cm-textarea:focus-visible,
  .cm-select:focus-visible{
    outline: none;
    box-shadow: var(--cm-ring);
  }

  @media (max-width: 1024px){
    .cm-topbar{ padding: 8px; }
    .cm-tabbtn, .cm-btn{ padding: 8px 10px; }
    .cm-wrap{ padding: 12px; }
  }

  /* Hard override: checklist item SEM depender de CSS global */
  #cm-root .checklist-item{
    display: flex !important;
    align-items: center !important;
    justify-content: flex-start !important;
    gap: 8px !important;
  }

  #cm-root .checklist-item form{
    flex: 1 1 auto !important;
    min-width: 0 !important;
  }

  #cm-root .checklist-input{
    width: 100% !important;
    min-width: 0 !important;
    color: var(--cm-text) !important;
    background: transparent !important;
  }

  .hidden{ display:none !important; }

</style>

<div class="cm-wrap" id="cm-root" data-card-id="{{ card.id }}">

  <div class="cm-topbar">
    <div class="cm-tabs" role="tablist" aria-label="Abas do card">
      <button type="button" class="cm-tabbtn is-active" data-cm-tab="desc">Descrição</button>
      <button type="button" class="cm-tabbtn" data-cm-tab="tags">Etiquetas</button>
      <button type="button" class="cm-tabbtn" data-cm-tab="check">Checklists</button>
      <button type="button" class="cm-tabbtn" data-cm-tab="ativ">Atividade</button>
      <button type="button" class="cm-tabbtn" data-cm-tab="files">Anexos</button>

      <div class="cm-actions hidden" id="cm-actions">
        <button type="button" class="cm-btn primary" id="cm-save-btn">Salvar</button>
      </div>
    </div>
  </div>

  <form id="cm-main-form"
        method="post"
        enctype="multipart/form-data"
        hx-post="{% url 'boards:update_card' card.id %}"
        hx-target="#modal-body"
        hx-swap="innerHTML">
    {% csrf_token %}

    <section class="cm-panel is-active" data-cm-panel="desc" role="tabpanel">
      <div class="cm-card space-y-3">
        <div>
          <label class="cm-label">Título</label>
          <input type="text" name="title" value="{{ card.title }}" class="cm-input">
        </div>

        <div>
          <label class="cm-label">Descrição</label>
          <textarea name="description" class="cm-textarea">{{ card.description|default_if_none:"" }}</textarea>
          <div class="cm-muted" style="margin-top:8px;">
            Observação: aqui vai texto/HTML simples. Se quiser voltar com Quill depois, dá pra plugar em cima disso.
          </div>
        </div>
      </div>
    </section>

    <section class="cm-panel" data-cm-panel="tags" role="tabpanel">
      <div class="cm-card space-y-3">
        <div>
          <label class="cm-label">Etiquetas (separadas por vírgula)</label>
          <input type="text" name="tags" value="{{ card.tags|default_if_none:"" }}" class="cm-input">
        </div>

        {% if card.tags %}
          <div class="cm-muted">Pré-visualização:</div>
          <div class="flex flex-wrap gap-2">
            {% for tag in card.tags|split_tags %}
              {% with tag|tag_color as color %}
                <span class="px-2 py-1 rounded-md text-xs font-semibold"
                      style="background-color: {{ color }}20; color: {{ color }}; border: 1px solid {{ color }};">
                  {{ tag }}
                </span>
              {% endwith %}
            {% endfor %}
          </div>
        {% else %}
          <div class="cm-muted">Nenhuma etiqueta ainda.</div>
        {% endif %}
      </div>
    </section>
  </form>

  <section class="cm-panel" data-cm-panel="check" role="tabpanel">
    <div class="cm-card space-y-3">
      <form method="post"
            hx-post="{% url 'boards:checklist_add' card.id %}"
            hx-target="#checklist-list"
            hx-swap="innerHTML">
        {% csrf_token %}
        <label class="cm-label">Novo checklist</label>
        <div class="flex gap-2">
          <input type="text" name="title" class="cm-input" placeholder="Ex: Tarefas da semana">
          <button type="submit" class="cm-btn primary">Adicionar</button>
        </div>
      </form>

      <div id="checklist-list" class="space-y-4">
        {% include "boards/partials/checklist_list.html" with checklists=checklists %}
      </div>
    </div>
  </section>

  <section class="cm-panel" data-cm-panel="ativ" role="tabpanel">
    <div class="cm-card space-y-3">
      <form method="post"
            hx-post="{% url 'boards:add_activity' card.id %}"
            hx-target="#cm-activity-panel"
            hx-swap="innerHTML">
        {% csrf_token %}
        <label class="cm-label">Nova atividade</label>
        <textarea name="content" class="cm-textarea" style="min-height:140px;" placeholder="Escreva aqui..."></textarea>

        <div class="flex gap-2">
          <button type="submit" class="cm-btn primary">Incluir</button>
          <button type="button" class="cm-btn"
                  onclick="this.closest('form')?.querySelector('textarea[name=content]')?.value='';">
            Limpar
          </button>
        </div>
      </form>

      <div id="cm-activity-panel">
        {% include "boards/partials/card_activity_panel.html" %}
      </div>
    </div>
  </section>

  <section class="cm-panel" data-cm-panel="files" role="tabpanel">
    <div class="cm-card space-y-3">

      <!-- ✅ NOVO: caixa de erro amigável para upload (413 etc.) -->
      <div id="attachments-error"
           class="hidden mb-2 px-3 py-2 rounded-md text-sm border
                  border-red-500/30 bg-red-500/10 text-red-200">
      </div>

      <div>
        <label class="cm-label">Enviar novo anexo</label>
        <input type="file" name="file"
               class="cm-input"
               hx-post="{% url 'boards:add_attachment' card.id %}"
               hx-target="#attachments-list"
               hx-swap="beforeend"
               hx-trigger="change"
               hx-encoding="multipart/form-data" />
      </div>

      <div id="attachments-list" class="space-y-3">
        {% for attachment in card.attachments.all %}
          {% include "boards/partials/attachment_item.html" %}
        {% empty %}
          <div class="cm-muted">Nenhum anexo ainda.</div>
        {% endfor %}
      </div>
    </div>
  </section>

</div>

<script>
(function () {

  function syncModalTheme() {
    const modalRoot = document.getElementById("card-modal-root");
    if (!modalRoot) return;

    const isDark = document.documentElement.classList.contains("dark");

    modalRoot.classList.remove(
      "theme-dark","theme-glass","card-theme-dark","card-theme-white","card-theme-aero"
    );

    modalRoot.classList.add(isDark ? "theme-dark" : "theme-glass");
  }

  function initRadicalTabs(root) {
    if (!root) return;

    const tabs = root.querySelectorAll("[data-cm-tab]");
    const panels = root.querySelectorAll("[data-cm-panel]");
    if (!tabs.length || !panels.length) return;

    function activate(name) {
      tabs.forEach(b => b.classList.toggle("is-active", b.getAttribute("data-cm-tab") === name));
      panels.forEach(p => p.classList.toggle("is-active", p.getAttribute("data-cm-panel") === name));

      // Salvar só em Descrição e Etiquetas
      const actions = root.querySelector("#cm-actions");
      if (actions) {
        const shouldShowSave = (name === "desc" || name === "tags");
        actions.classList.toggle("hidden", !shouldShowSave);
      }
    }

    tabs.forEach(b => {
      if (b.dataset.cmBound === "1") return;
      b.dataset.cmBound = "1";

      b.addEventListener("click", () => {
        const name = b.getAttribute("data-cm-tab");
        sessionStorage.setItem("cmActiveTab", name);
        activate(name);
      });
    });

    activate(sessionStorage.getItem("cmActiveTab") || "desc");

    const saveBtn = root.querySelector("#cm-save-btn");
    const form = root.querySelector("#cm-main-form");
    if (saveBtn && form && saveBtn.dataset.cmBound !== "1") {
      saveBtn.dataset.cmBound = "1";
      saveBtn.addEventListener("click", () => {
        try { form.requestSubmit(); } catch (e) { form.submit(); }
      });
    }
  }

  // ✅ NOVO: UX de erro amigável pro upload (413)
  function initAttachmentErrors(root) {
    if (!root) return;
    if (root.dataset.cmAttachBound === "1") return;
    root.dataset.cmAttachBound = "1";

    function showAttachmentError(msg) {
      const box = root.querySelector("#attachments-error");
      if (!box) return;
      box.textContent = msg;
      box.classList.remove("hidden");
    }

    function clearAttachmentError() {
      const box = root.querySelector("#attachments-error");
      if (!box) return;
      box.textContent = "";
      box.classList.add("hidden");
    }

    root.addEventListener("change", function (e) {
      if (e.target && e.target.matches('input[type="file"][name="file"]')) {
        clearAttachmentError();
      }
    });

    document.body.addEventListener("htmx:responseError", function (evt) {
      const xhr = evt.detail.xhr;
      const elt = evt.detail.elt;

      // só trata o input de anexo desse modal
      if (!elt || !elt.matches || !elt.matches('#cm-root input[type="file"][name="file"]')) return;

      if (xhr && xhr.status === 413) {
        showAttachmentError("Arquivo acima de 50MB. O limite de anexo é 50MB. Comprima o arquivo ou envie um link (Drive/Dropbox) e tente novamente.");
        elt.value = ""; // limpa o nome do arquivo (evita parecer bug)
        return;
      }

      showAttachmentError("Não foi possível enviar o anexo agora. Tente novamente.");
      elt.value = "";
    });
  }

  function boot() {
    syncModalTheme();
    const root = document.getElementById("cm-root");
    initRadicalTabs(root);
    initAttachmentErrors(root);
  }

  document.addEventListener("DOMContentLoaded", boot);

  document.body.addEventListener("htmx:afterSwap", function (evt) {
    const t = evt.target;
    if (!t) return;
    if (t.id === "modal-body") boot();
  });

})();
</script>
