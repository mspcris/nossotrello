{% load tag_helpers %}

{% if card.cover_image %}
  <div class="px-4 pt-4">
    <div class="group relative rounded-xl overflow-hidden border border-white/20">
      <a href="{{ card.cover_image.url }}" target="_blank" rel="noopener" class="block">
        <img src="{{ card.cover_image.url }}" alt="Capa do card" class="w-full object-cover" style="max-height: 260px;">
      </a>

      <button type="button"
              class="absolute top-2 right-2 px-2 py-1 rounded text-xs bg-black/60 text-white
                     opacity-0 group-hover:opacity-100 transition"
              hx-post="{% url 'boards:remove_card_cover' card.id %}"
              hx-target="#modal-body"
              hx-swap="innerHTML"
              aria-label="Remover capa"
              title="Remover capa">
        ✕
      </button>
    </div>
  </div>
{% endif %}

<style>
  .cm-wrap { padding: 16px; width: 100%; min-width: 0; }
  .cm-topbar {
    position: sticky; top: 0; z-index: 10;
    background: rgba(15,15,15,.55);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 14px;
    padding: 10px;
    margin-bottom: 12px;
  }
  .cm-tabs { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .cm-tabbtn {
    padding: 8px 10px;
    border-radius: 10px;
    font-size: 13px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: rgba(255,255,255,.92);
    cursor: pointer;
    user-select: none;
  }
  .cm-tabbtn.is-active {
    background: rgba(255,255,255,.16);
    border-color: rgba(255,255,255,.30);
  }
  .cm-actions { margin-left:auto; display:flex; gap:8px; }
  .cm-btn {
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.08);
    color: rgba(255,255,255,.92);
    cursor:pointer;
    font-size: 13px;
  }
  .cm-btn.primary { background: rgba(37, 99, 235, .92); border-color: rgba(37, 99, 235, 1); }

  .cm-panel { display:none; }
  .cm-panel.is-active { display:block; }

  .cm-label { display:block; font-size: 12px; opacity:.85; margin: 0 0 6px 2px; color:#fff; }
  .cm-input, .cm-textarea, .cm-select {
    width:100%;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: rgba(255,255,255,.92);
    padding: 10px 12px;
    outline: none;
  }
  .cm-textarea { min-height: 220px; }
  .cm-card {
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.05);
    padding: 12px;
  }
  .cm-muted { font-size: 12px; opacity: .75; color:#fff; }
</style>

<div class="cm-wrap" id="cm-root" data-card-id="{{ card.id }}">

  <div class="cm-topbar">
    <div class="cm-tabs" role="tablist" aria-label="Abas do card">
      <button type="button" class="cm-tabbtn is-active" data-cm-tab="desc">Descrição</button>
      <button type="button" class="cm-tabbtn" data-cm-tab="tags">Etiquetas</button>
      <button type="button" class="cm-tabbtn" data-cm-tab="check">Checklists</button>
      <button type="button" class="cm-tabbtn" data-cm-tab="ativ">Atividade</button>
      <button type="button" class="cm-tabbtn" data-cm-tab="files">Anexos</button>

      <div class="cm-actions">
        <button type="button" class="cm-btn primary" id="cm-save-btn">Salvar</button>
        <button type="button" class="cm-btn" onclick="(window.closeModal ? window.closeModal() : null);">Fechar</button>
      </div>
    </div>
  </div>

  <form id="cm-main-form"
        method="post"
        enctype="multipart/form-data"
        hx-post="{% url 'boards:update_card' card.id %}"
        hx-target="#modal-body"
        hx-swap="innerHTML">

    {% csrf_token %}

    <section class="cm-panel is-active" data-cm-panel="desc" role="tabpanel">

      <div class="cm-card space-y-3">
        <div>
          <label class="cm-label">Título</label>
          <input type="text" name="title" value="{{ card.title }}" class="cm-input">
        </div>

        <div>
          <label class="cm-label">Descrição</label>
          <textarea name="description" class="cm-textarea">{{ card.description|default_if_none:"" }}</textarea>
          <div class="cm-muted" style="margin-top:8px;">
            Observação: aqui vai texto/HTML simples. Se quiser voltar com Quill depois, dá pra plugar em cima disso.
          </div>
        </div>
      </div>
    </section>

    <section class="cm-panel" data-cm-panel="tags" role="tabpanel">
      <div class="cm-card space-y-3">
        <div>
          <label class="cm-label">Etiquetas (separadas por vírgula)</label>
          <input type="text" name="tags" value="{{ card.tags|default_if_none:"" }}" class="cm-input">
        </div>

        {% if card.tags %}
          <div class="cm-muted">Pré-visualização:</div>
          <div class="flex flex-wrap gap-2">
            {% for tag in card.tags|split_tags %}
              {% with tag|tag_color as color %}
                <span class="px-2 py-1 rounded-md text-xs font-semibold"
                      style="background-color: {{ color }}20; color: {{ color }}; border: 1px solid {{ color }};">
                  {{ tag }}
                </span>
              {% endwith %}
            {% endfor %}
          </div>
        {% else %}
          <div class="cm-muted">Nenhuma etiqueta ainda.</div>
        {% endif %}
      </div>
    </section>

  </form>

  <section class="cm-panel" data-cm-panel="check" role="tabpanel">
    <div class="cm-card space-y-3">

      <form method="post"
            hx-post="{% url 'boards:checklist_add' card.id %}"
            hx-target="#checklist-list"
            hx-swap="innerHTML">
        {% csrf_token %}
        <label class="cm-label">Novo checklist</label>
        <div class="flex gap-2">
          <input type="text" name="title" class="cm-input" placeholder="Ex: Tarefas da semana">
          <button type="submit" class="cm-btn primary">Adicionar</button>
        </div>
      </form>

      <div id="checklist-list" class="space-y-4">
        {% include "boards/partials/checklist_list.html" with checklists=checklists %}
      </div>

    </div>
  </section>

  <section class="cm-panel" data-cm-panel="ativ" role="tabpanel">
    <div class="cm-card space-y-3">

      <form method="post"
            hx-post="{% url 'boards:add_activity' card.id %}"
            hx-target="#cm-activity-panel"
            hx-swap="innerHTML">
        {% csrf_token %}
        <label class="cm-label">Nova atividade</label>
        <textarea name="content" class="cm-textarea" style="min-height:140px;" placeholder="Escreva aqui..."></textarea>

        <div class="flex gap-2">
          <button type="submit" class="cm-btn primary">Incluir</button>
          <button type="button" class="cm-btn"
                  onclick="this.closest('form')?.querySelector('textarea[name=content]')?.value='';">
            Limpar
          </button>
        </div>
      </form>

      <div id="cm-activity-panel">
        {% include "boards/partials/card_activity_panel.html" %}
      </div>

    </div>
  </section>

  <section class="cm-panel" data-cm-panel="files" role="tabpanel">
    <div class="cm-card space-y-3">

      <div>
        <label class="cm-label">Enviar novo anexo</label>
        <input type="file" name="file"
               class="cm-input"
               hx-post="{% url 'boards:add_attachment' card.id %}"
               hx-target="#attachments-list"
               hx-swap="beforeend"
               hx-trigger="change"
               hx-encoding="multipart/form-data" />
      </div>

      <div id="attachments-list" class="space-y-3">
        {% for attachment in card.attachments.all %}
          {% include "boards/partials/attachment_item.html" %}
        {% empty %}
          <div class="cm-muted">Nenhum anexo ainda.</div>
        {% endfor %}
      </div>

    </div>
  </section>

</div>

<script>
(function () {
  // ============================================================
  // HTMX + Django CSRF (cobre hx-post fora de <form> com csrf_token)
  // ============================================================
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  function bindHtmxCsrfOnce() {
    if (document.body.dataset.cmHtmxCsrfBound === "1") return;
    document.body.dataset.cmHtmxCsrfBound = "1";

    document.body.addEventListener("htmx:afterSwap", function (evt) {
  const t = evt.target;
  if (!t) return;

  // Só reinicializa quando o swap foi do modal inteiro
  if (t.id === "modal-body") boot();
});

  }

  function initRadicalTabs(root) {
    if (!root) return;

    const tabs = root.querySelectorAll("[data-cm-tab]");
    const panels = root.querySelectorAll("[data-cm-panel]");
    if (!tabs.length || !panels.length) return;

    function activate(name) {
      tabs.forEach(b => b.classList.toggle("is-active", b.getAttribute("data-cm-tab") === name));
      panels.forEach(p => p.classList.toggle("is-active", p.getAttribute("data-cm-panel") === name));
    }

    tabs.forEach(b => {
      if (b.dataset.cmBound === "1") return;
      b.dataset.cmBound = "1";
      b.addEventListener("click", () => activate(b.getAttribute("data-cm-tab")));
    });

    activate("desc");

    const saveBtn = root.querySelector("#cm-save-btn");
    const form = root.querySelector("#cm-main-form");
    if (saveBtn && form && saveBtn.dataset.cmBound !== "1") {
      saveBtn.dataset.cmBound = "1";
      saveBtn.addEventListener("click", () => {
        try { form.requestSubmit(); } catch (e) { form.submit(); }
      });
    }
  }

  function boot() {
    bindHtmxCsrfOnce();
    initRadicalTabs(document.getElementById("cm-root"));
  }

  document.addEventListener("DOMContentLoaded", boot);

  document.body.addEventListener("htmx:afterSwap", function (evt) {
    const t = evt.target;
    if (!t) return;
    if (t.id === "modal-body" || t.closest?.("#modal-body")) boot();
  });
})();
</script>
