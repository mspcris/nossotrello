{% load tag_helpers %}

<div id="card-modal-root" class="flex flex-col max-h-[80vh]">

    <div class="flex items-center justify-between px-4 py-3 border-b bg-white/80 backdrop-blur-md">

        <div class="flex gap-2">
            <button type="button" class="w-4 h-4 rounded-full border border-gray-300 bg-white"
                onclick="cardSetTheme('white')"></button>
            <button type="button" class="w-4 h-4 rounded-full border border-gray-300 bg-white/10 backdrop-blur-md"
                onclick="cardSetTheme('aero')"></button>
            <button type="button" class="w-4 h-4 rounded-full border border-gray-300 bg-[#1e1e1e]"
                onclick="cardSetTheme('dark')"></button>
        </div>

        <div class="flex items-center gap-3"></div>

    </div>


    <div class="flex border-b bg-white/80 backdrop-blur">
        <button type="button" class="card-tab-btn card-tab-active" data-tab-target="card-tab-desc"
            onclick="cardOpenTab('card-tab-desc')">Descrição</button>

        <button type="button" class="card-tab-btn" data-tab-target="card-tab-check"
            onclick="cardOpenTab('card-tab-check')">Checklists</button>

        <button type="button" class="card-tab-btn" data-tab-target="card-tab-ativ"
            onclick="cardOpenTab('card-tab-ativ')">Atividade</button>
    </div>


    <div class="flex-1 overflow-y-auto p-5 space-y-6">

        <div id="card-tab-desc" class="card-tab-panel block">

            <!-- FORM SEM hx-on::after-request -->
            <form method="post" enctype="multipart/form-data" hx-post="{% url 'boards:update_card' card.id %}"
                hx-target="#modal-body" hx-swap="innerHTML">

                {% csrf_token %}

                <label class="block text-sm font-medium mb-1">Título</label>
                <input type="text" name="title" value="{{ card.title }}" class="w-full border rounded px-3 py-2 mb-4">

                <label class="block text-sm font-medium mb-1">Descrição</label>
                <div id="quill-editor" class="border rounded mb-2"></div>
                <input type="hidden" id="description-input" name="description"
                    value="{{ card.description|default_if_none:'' }}">

                <label class="block text-sm font-medium mb-1 mt-4">Etiquetas</label>
                <input type="text" name="tags" value="{{ card.tags|default_if_none:'' }}"
                    class="w-full border rounded px-3 py-2 mb-2">

                {% if card.tags %}
                <div id="tags-preview" class="flex flex-wrap gap-1 mb-4">
                    {% for tag in card.tags|split_tags %}
                    {% with tag|tag_color as color %}
                    <span class="group relative flex items-center text-xs font-semibold px-2 py-1 rounded-md"
                        style="background-color: {{ color }}20; color: {{ color }}; border: 1px solid {{ color }};"
                        data-tag="{{ tag }}">
                        {{ tag }}
                        <button type="button"
                            class="ml-1 text-red-600 hover:text-red-900 font-bold opacity-0 group-hover:opacity-100 transition"
                            onclick="removeTagInstant({{ card.id }}, '{{ tag }}')">✕</button>
                    </span>
                    {% endwith %}
                    {% endfor %}
                </div>
                {% endif %}

                <label class="block text-sm font-medium mb-1 mt-4">Anexos</label>
                <input type="file" name="attachment" class="mb-4">

                {% if card.attachment %}
                <div class="mt-3 relative">
                    <p class="text-sm font-medium mb-1">Arquivo atual:</p>

                    <a href="{{ card.attachment.url }}" target="_blank"
                        class="text-blue-600 hover:underline text-sm block mb-1">
                        {{ card.attachment.name }}
                    </a>

                    {% with ext=card.attachment.url|lower %}
                    {% if ext|slice:"-4:" == ".png" or ext|slice:"-4:" == ".jpg" or ext|slice:"-5:" == ".jpeg" %}
                    <img src="{{ card.attachment.url }}" class="mt-2 max-h-40 rounded">
                    {% endif %}
                    {% endwith %}
                </div>
                {% endif %}

                <div class="mt-6 flex gap-3">

                    <!-- SALVAR atualiza card -->
                    <button type="submit" onclick="refreshCardSnippet({{ card.id }})"
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Salvar
                    </button>

                    <!-- FECHAR atualiza card -->
                    <button type="button" onclick="refreshCardSnippet({{ card.id }}); closeModal();"
                        class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
                        Fechar
                    </button>

                </div>

            </form>
        </div>


        <div id="card-tab-check" class="card-tab-panel hidden opacity-60 text-gray-500">
            Checklists serão implementados depois.
        </div>


        <div id="card-tab-ativ" class="card-tab-panel hidden">

            <h3 class="text-lg font-semibold mb-2">Atividade</h3>

            <div class="space-y-3">
                {% for log in card.logs.all %}
                <div class="p-3 border rounded bg-gray-50">
                    <div class="text-sm text-gray-600 mb-1">{{ log.created_at|date:"d/m/Y H:i" }}</div>
                    <div class="text-sm">{{ log.content|safe }}</div>
                </div>
                {% empty %}
                <p class="text-gray-400 text-sm">Nenhuma atividade ainda.</p>
                {% endfor %}
            </div>

        </div>

    </div>

</div>

<script>
    window.currentCardId = {{ card.id }};

    function cardOpenTab(panelId) {
        document.querySelectorAll('.card-tab-btn').forEach(btn => {
            btn.classList.toggle('card-tab-active', btn.getAttribute('data-tab-target') === panelId);
        });

        document.querySelectorAll('.card-tab-panel').forEach(p => {
            p.classList.toggle('hidden', p.id !== panelId);
        });

        sessionStorage.setItem('modalActiveTab', panelId);
    }

    function cardSetTheme(mode) {
        const root = document.getElementById('card-modal-root');
        root.classList.remove('card-theme-white', 'card-theme-aero', 'card-theme-dark');

        if (mode === 'white') root.classList.add('card-theme-white');
        else if (mode === 'aero') root.classList.add('card-theme-aero');
        else if (mode === 'dark') root.classList.add('card-theme-dark');
    }

    function cardToggleFull() {
        const root = document.getElementById('card-modal-root');
        root.classList.toggle('max-h-[80vh]');
        root.classList.toggle('h-[90vh]');
    }
</script>