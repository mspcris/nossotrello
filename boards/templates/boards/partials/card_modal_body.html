{% load tag_helpers %}

{# CAPA DO CARD #}
{% if card.cover_image %}
  <div class="px-4 pt-4">
    <div class="group relative rounded-xl overflow-hidden border border-white/20 card-cover-wrap">
      <a href="{{ card.cover_image.url }}" target="_blank" rel="noopener" class="block">
        <img
          src="{{ card.cover_image.url }}"
          alt="Capa do card"
          class="card-cover-img w-full object-cover"
        >
      </a>

      <button
        type="button"
        class="card-cover-remove absolute top-2 right-2 px-2 py-1 rounded text-xs
               opacity-0 group-hover:opacity-100 transition"
        hx-post="{% url 'boards:remove_card_cover' card.id %}"
        hx-target="#modal-body"
        hx-swap="innerHTML"
        aria-label="Remover capa"
        title="Remover capa"
      >
        ✕
      </button>
    </div>
  </div>
{% endif %}

{# CONTEÚDO DO MODAL #}
{% include "boards/partials/card_modal_content.html" %}

<script>
(function () {
  // evita registrar listener múltiplas vezes
  if (window.__activityClearHookInstalled) return;
  window.__activityClearHookInstalled = true;

  document.body.addEventListener("htmx:afterRequest", function (evt) {
    if (!evt?.detail?.successful) return;

    // garante que foi o POST de "add_activity"
    const responseURL = evt.detail?.xhr?.responseURL || "";
    if (!responseURL.includes("/activity/add/")) return;

    // limpa APENAS o editor dentro do form que disparou o request
    const trigger = evt.target;
    const form = trigger?.closest?.("form");
    if (!form) return;

    // limpa Quill (conteúdo visual)
    const qlEditor = form.querySelector(".ql-editor");
    if (qlEditor) qlEditor.innerHTML = "";

    // limpa campos de payload comuns
    const contentField =
      form.querySelector('input[name="content"]') ||
      form.querySelector('textarea[name="content"]') ||
      form.querySelector('input[name="description"]') ||
      form.querySelector('textarea[name="description"]');

    if (contentField) contentField.value = "";
  });
})();
</script>
