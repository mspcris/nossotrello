{% load tag_helpers %}

<li
  id="card-{{ card.id }}"
  data-card-id="{{ card.id }}"
  data-tag-colors='{{ card.tag_colors|default:"{}"|escapejs }}'
  data-card-open-url="{% url 'boards:card_modal' card.id %}"
  data-term-due="{% if card.due_date %}{{ card.due_date|date:'Y-m-d' }}{% endif %}"
  data-term-warn="{% if card.due_warn_date %}{{ card.due_warn_date|date:'Y-m-d' }}{% endif %}"
  data-term-notify="{{ card.due_notify|default_if_none:True|yesno:'1,0' }}"
  class="card-item p-3 bg-white/80 rounded-xl shadow-sm mb-3 cursor-pointer overflow-hidden"
>

<!-- BOTÃƒO DE EXCLUSÃƒO (aparece apenas no modo "Excluir cards") -->
<button type="button"
        class="delete-card-btn hidden absolute top-1 right-1 bg-red-600 text-white text-xs px-2 py-1 rounded"
        onpointerdown="event.stopPropagation();"
        ontouchstart="event.stopPropagation();"
        onclick="event.stopPropagation();"
        hx-post="{% url 'boards:delete_card' card.id %}"
        hx-target="#card-{{ card.id }}"
        hx-swap="outerHTML">
  X
</button>

<!-- BOTÃƒO DE ARQUIVAR (aparece apenas no modo "Arquivar cards") -->
<button type="button"
        class="archive-card-btn hidden absolute top-1 right-1 bg-slate-800 text-white text-xs px-2 py-1 rounded"
        onpointerdown="event.stopPropagation();"
        ontouchstart="event.stopPropagation();"
        onclick="event.stopPropagation();"
        hx-post="{% url 'boards:archive_card' card.id %}"
        hx-swap="none"
        hx-confirm="Arquivar este card? Ele vai sair do quadro e ir para Arquivados.">
  ğŸ—ƒï¸
</button>


  {# CAPA #}
  {% if card.cover_image %}
    <div class="mb-2 card-cover-wrap">

      <!-- Fundo espelhado (blur) -->
      <div
        class="card-cover-blur"
        style="
          background-image: url('{{ card.cover_image.url }}');
        ">
      </div>

      <!-- Imagem principal (nÃ£o corta) -->
      <img
        src="{{ card.cover_image.url }}"
        alt="Capa do card"
        class="card-cover-img"
        loading="lazy">
    </div>
  {% endif %}



  {# ğŸ”´ BADGE + ğŸ‘ï¸ (lado direito) â€” BADGE continua 100% controlado pelo POLL #}
<div class="card-follow-icon">
  <span
    data-card-unread-badge
    class="hidden inline-flex items-center justify-center
           min-w-[18px] h-[18px]
           px-1 text-[10px] font-bold
           rounded-full bg-red-600 text-white">
  </span>

  <button type="button"
          class="card-follow-btn inline-flex items-center justify-center h-7 w-7 rounded-full bg-black/40 text-white {% if card.is_following %}is-following{% endif %}"
          aria-label="Seguir card"
          title="Seguir card"
          onpointerdown="event.stopPropagation();"
          ontouchstart="event.stopPropagation();"
          onclick="event.stopPropagation();"
          hx-post="{% url 'boards:toggle_card_follow' card.id %}"
          hx-swap="none"
          hx-include="input[name='csrfmiddlewaretoken']">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
         width="18" height="18" fill="none" stroke="currentColor"
         stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7z"/>
      <circle cx="12" cy="12" r="3"/>
    </svg>
  </button>
</div>


  {# TAGS #}
  {% if card.tags %}
    <div class="flex flex-wrap gap-1 mb-2">
      {% for tag in card.tags|split_tags %}
        {% with tag|tag_color:card.tag_colors as color %}
          <span
            data-tag="{{ tag }}"
            class="text-xs font-semibold px-2 py-1 rounded-md"
            style="background-color: {{ color }}20;
                   color: {{ color }};
                   border: 1px solid {{ color }};">
            {{ tag }}
          </span>
        {% endwith %}
      {% endfor %}
    </div>
  {% endif %}

  {# TÃTULO #}
  <div class="text-sm font-semibold">
    {{ card.title }}
  </div>

  {# META #}
  <div class="mt-2 flex flex-col items-start gap-1">
    <div class="flex items-center gap-2 flex-wrap">
      <span class="term-badge hidden text-[10px] font-semibold px-2 py-0.5 rounded-md border"></span>

      {% if card.due_date %}
        <span class="text-[10px] font-semibold px-2 py-0.5 rounded-md border bg-white/60">
          {{ card.due_date|date:"d/m/Y" }}
        </span>
      {% endif %}
    </div>

    <div class="tt-slot"></div>
  </div>

</li>
