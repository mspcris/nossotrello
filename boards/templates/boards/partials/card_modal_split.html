{# templates/boards/partials/card_modal_split.html #}
{% load tag_helpers %}

{% comment %} 
{% if card.cover_image %}
  <div class="px-4 pt-4">
    <div class="group relative rounded-xl overflow-hidden border border-white/20">
      <a href="{{ card.cover_image.url }}" target="_blank" rel="noopener" class="block">
        <img src="{{ card.cover_image.url }}" alt="Capa do card" class="w-full object-cover" style="max-height: 260px;">
      </a>

      <button type="button"
              class="absolute top-2 right-2 px-2 py-1 rounded text-xs bg-black/60 text-white
                     opacity-0 group-hover:opacity-100 transition"
              hx-post="{% url 'boards:remove_card_cover' card.id %}"
              hx-target="#modal-body"
              hx-swap="innerHTML"
              aria-label="Remover capa"
              title="Remover capa">
        ‚úï
      </button>
    </div>
  </div>
{% endif %} 
{% endcomment %}

<style>
/* ============================================================
   LAYOUT: SPLIT (√öNICO CSS INLINE PERMITIDO)
   Objetivo: manter ‚ÄúAtividade‚Äù √† direita e o resto √† esquerda
   N√ÉO COLOCAR CSS AQUI! USAR MODAL.CSS, A MENOS QUE SEJA EXCLUSIVO DO MODAL SPLIT
   ============================================================ */
#cm-root .cm-split{
  display: flex;
  gap: 16px;
  align-items: stretch;
  width: 100%;
  min-width: 0;
}

#cm-root .cm-main{
  flex: 1 1 auto;
  min-width: 0;
}

#cm-root .cm-activity{
  flex: 0 0 40%;
  min-width: 0;
  border-left: 1px solid rgba(15,23,42,0.12);
  padding-left: 16px;
}

/* Responsivo */
@media (max-width: 1024px){
  #cm-root .cm-split{ flex-direction: column; }
  #cm-root .cm-activity{
    flex-basis: auto;
    border-left: 0;
    border-top: 1px solid rgba(15,23,42,0.12);
    padding-left: 0;
    padding-top: 16px;
  }
}

</style>

<div class="cm-wrap"
     id="cm-root"
     data-cm-mode="split"
     data-card-id="{{ card.id }}"
     data-cm-active="desc"
     data-tag-colors='{{ card.tag_colors|default_if_none:"{}"|escape }}'
     {% if term_status %}data-term-status="{{ term_status }}"{% endif %}
     data-term-notify="{% if card.due_notify %}1{% else %}0{% endif %}">









     

  <div class="cm-split">

    <!-- COLUNA ESQUERDA -->
    <div class="cm-main">

      {% if card.cover_image %}
  <div class="px-4 pt-4">
    <div class="group relative rounded-xl overflow-hidden border border-white/20">
      <a href="{{ card.cover_image.url }}" target="_blank" rel="noopener" class="block">
        <img
          src="{{ card.cover_image.url }}"
          alt="Capa do card"
          class="w-full object-cover"
          style="height: 220px; max-height: 220px;"
        >
      </a>

      <button type="button"
              class="absolute top-2 right-2 px-2 py-1 rounded text-xs bg-black/60 text-white
                     opacity-0 group-hover:opacity-100 transition"
              hx-post="{% url 'boards:remove_card_cover' card.id %}"
              hx-target="#modal-body"
              hx-swap="innerHTML"
              aria-label="Remover capa"
              title="Remover capa">
        ‚úï
      </button>
    </div>
  </div>
{% endif %}


      <div class="cm-topbar">
        <div class="cm-bar" role="tablist" aria-label="Abas do card">
          <div class="cm-tabs">

            <button type="button" class="cm-tabbtn is-active" data-cm-tab="desc"> üìÑ Descri√ß√£o</button>
            <button type="button" class="cm-tabbtn" data-cm-tab="tags"> üè∑Ô∏è Etiquetas</button>
            <button type="button" class="cm-tabbtn" data-cm-tab="check"> ‚òëÔ∏è Checklists</button>
            <button type="button" class="cm-tabbtn" data-cm-tab="files"> üìé Anexos</button>
            <button type="button" class="cm-tabbtn" data-cm-tab="track"> ‚è±Ô∏è Track-time</button>
          </div>
{% comment %} 
           <div class="cm-actions" id="cm-actions">
            <button type="submit" form="cm-main-form" class="cm-btn primary" id="cm-save-btn">Salvar</button>
          </div> {% endcomment %}
        </div>
      </div> 

      <div id="cm-tags-wrap">
        {% include "boards/partials/card_tags_bar.html" %}
      </div>

          <div id="cm-tag-color-popover"
              class="hidden"
              style="position:absolute; z-index:99999; padding:12px; border-radius:12px;
                      background: rgba(255,255,255,0.98); border:1px solid rgba(15,23,42,0.12);
                      box-shadow: 0 10px 30px rgba(2,6,23,0.18);">
            <div class="flex flex-col gap-3">
              <input type="color"
                    id="cm-tag-color-picker"
                    class="w-12 h-12 border rounded cursor-pointer">

              <div class="flex gap-2 justify-end">
                <button type="button" class="cm-btn primary" id="cm-float-save-btn">
  <span class="underline font-semibold">S</span>alvar
</button>

              </div>
            </div>
          </div>


      <form id="cm-cover-form"
            class="hidden"
            method="post"
            enctype="multipart/form-data"
            action="{% url 'boards:set_card_cover' card.id %}">
        {% csrf_token %}
      </form>

      <form id="cm-checklist-create-form"
            method="post"
            hx-post="{% url 'boards:checklist_add' card.id %}"
            hx-target="#checklist-list"
            hx-swap="innerHTML">
        {% csrf_token %}
      </form>

<form id="cm-main-form"
      method="post"
      enctype="multipart/form-data"
      hx-post="{% url 'boards:update_card' card.id %}"
      hx-target="#modal-body"
      hx-swap="innerHTML"
      hx-include="#cm-is-delivered, input[name='is_delivered']"
      hx-on::config-request="
        (function(){
          try { if (typeof syncActiveDesc === 'function') syncActiveDesc(); } catch(_e){}
        })();
      "
>


        {% csrf_token %}

        <div id="cm-panels">

          <!-- Aba: Descri√ß√£o -->
          <section class="cm-panel is-active" data-cm-panel="desc" role="tabpanel">
            <div class="cm-card space-y-3">
              <div>
                <label class="cm-label">T√≠tulo</label>
                <input type="text" name="card_title" form="cm-main-form" value="{{ card.title }}" class="cm-input">
              </div>

              <div>
                <label class="cm-label">Descri√ß√£o</label>

                <textarea
                  id="cm-description"
                  name="description"
                  class="cm-textarea cm-textarea-resizable"
                  hx-preserve
                >{{ card.description|default_if_none:""|safe }}</textarea>



                <div class="cm-muted" style="margin-top:8px;"></div>
              </div>
            </div>

            <div class="cm-card space-y-3" style="margin:10px 0;">
              <div class="flex items-center justify-between gap-2 flex-wrap">
                <div>
                  <div class="cm-label" style="margin:0;">Prazo</div>
                  <div class="cm-muted">
                    Se preencher vencimento, o aviso vira obrigat√≥rio (default: 5 dias antes).
                  </div>
                </div>

                <div class="flex items-center gap-3 flex-wrap">
                  <div class="flex items-center gap-3 flex-wrap">
                    <label class="cm-muted cm-due-color" style="display:flex;align-items:center;gap:8px;">
                      <input type="color" name="due_color_ok" value="{{ board_due_colors.ok|default:'#16a34a' }}">
                      OK
                      <span class="cm-color-dot" aria-hidden="true"></span>
                    </label>

                    <label class="cm-muted cm-due-color" style="display:flex;align-items:center;gap:8px;">
                      <input type="color" name="due_color_warn" value="{{ board_due_colors.warn|default:'#f59e0b' }}">
                      Alerta
                      <span class="cm-color-dot" aria-hidden="true"></span>
                    </label>

                    <label class="cm-muted cm-due-color" style="display:flex;align-items:center;gap:8px;">
                      <input type="color" name="due_color_overdue" value="{{ board_due_colors.overdue|default:'#dc2626' }}">
                      Vencido
                      <span class="cm-color-dot" aria-hidden="true"></span>
                    </label>
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="min-w-0">
                  <div class="cm-label">Data de in√≠cio</div>
                  <div class="relative">
                    <input type="text"
                           id="cm-start-date-display"
                           class="cm-input pr-10"
                           inputmode="numeric"
                           placeholder="DD/MM/AAAA"
                           value="{% if card.start_date %}{{ card.start_date|date:'d/m/Y' }}{% endif %}">
                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none">üìÖ</span>

                    <input type="date"
                           id="cm-start-date-picker"
                           class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 opacity-0 cursor-pointer z-10"
                           value="{% if card.start_date %}{{ card.start_date|date:'Y-m-d' }}{% endif %}">

                    <input type="hidden"
                           name="start_date"
                           id="cm-start-date"
                           value="{% if card.start_date %}{{ card.start_date|date:'Y-m-d' }}{% endif %}">
                  </div>
                </div>

                <div class="min-w-0">
                  <div class="cm-label">Vencimento</div>
                  <div class="relative">
                    <input type="text"
                           id="cm-due-date-display"
                           class="cm-input pr-10"
                           inputmode="numeric"
                           placeholder="DD/MM/AAAA"
                           value="{% if card.due_date %}{{ card.due_date|date:'d/m/Y' }}{% endif %}">
                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none">üìÖ</span>

                    <input type="date"
                           id="cm-due-date-picker"
                           class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 opacity-0 cursor-pointer z-10"
                           value="{% if card.due_date %}{{ card.due_date|date:'Y-m-d' }}{% endif %}">

                    <input type="hidden"
                           name="due_date"
                           id="cm-due-date"
                           value="{% if card.due_date %}{{ card.due_date|date:'Y-m-d' }}{% endif %}">
                  </div>
                </div>

                <div class="min-w-0">
                  <div class="cm-label">Avisar em</div>
                  <div class="relative">
                    <input type="text"
                           id="cm-due-warn-date-display"
                           class="cm-input pr-10"
                           inputmode="numeric"
                           placeholder="DD/MM/AAAA"
                           value="{% if card.due_warn_date %}{{ card.due_warn_date|date:'d/m/Y' }}{% endif %}">
                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none">üìÖ</span>

                    <input type="date"
                           id="cm-due-warn-date-picker"
                           class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 opacity-0 cursor-pointer z-10"
                           value="{% if card.due_warn_date %}{{ card.due_warn_date|date:'Y-m-d' }}{% endif %}">

                    <input type="hidden"
                           name="due_warn_date"
                           id="cm-due-warn-date"
                           value="{% if card.due_warn_date %}{{ card.due_warn_date|date:'Y-m-d' }}{% endif %}">
                  </div>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <input type="hidden" name="due_notify" value="0">
                <label class="cm-muted" style="display:flex;align-items:center;gap:8px;white-space:nowrap;">
                  <input type="checkbox"
                         name="due_notify"
                         value="1"
                         {% if card.due_notify|default_if_none:True %}checked{% endif %}>
                  Notificar com cores
                </label>
              </div>
            </div>

            <div class="cm-card" style="margin-bottom:10px;">
              <div class="flex items-center justify-between gap-2 flex-wrap">
                <div>
                  <div class="cm-label" style="margin:0;">Capa do card</div>
                  <div class="cm-muted">Dica: na aba Descri√ß√£o, voc√™ pode colar uma imagem (Ctrl+V) para virar capa.</div>
                </div>

                <div class="flex gap-2 items-center">
                  <button type="button"
                          class="cm-btn"
                          id="cm-cover-pick-btn"
                          onclick="document.getElementById('cm-cover-file')?.click();">
                    Escolher imagem‚Ä¶
                  </button>

                  <input type="file"
                         id="cm-cover-file"
                         name="cover"
                         form="cm-cover-form"
                         accept="image/*"
                         style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;">
                </div>
              </div>

              <div id="cm-cover-error"
                   class="hidden mt-2 px-3 py-2 rounded-md text-sm border border-red-500/30 bg-red-500/10 text-red-200"></div>
            </div>
          </section>

          <!-- Aba: Tags -->
          <section class="cm-panel" data-cm-panel="tags" role="tabpanel">
            <div class="cm-card space-y-3">
              <div>
                <label>Digite neste campo as etiquetas separadas por v√≠rgula.</label>
                
                  <textarea
                    name="tags"
                    id="cm-tags-input"
                    class="cm-input"
                    rows="2"
                    autocomplete="off"
                    style="min-height:56px; resize:vertical;"
                    placeholder="Digite as etiquetas separadas por v√≠rgula">{{ card.tags|default_if_none:"" }}</textarea>


                  <div class="cm-tag-catalog">
                    <label>Cadastre etiquetas fixas para utilizar quando quiser. Digite uma por vez e Enter (ou clique em Incluir). Ap√≥s, clique nelas para adicionar ao quadro.</label>

                    <div class="cm-tag-create flex gap-2 items-center flex-wrap">
                      <input
                        type="text"
                        id="cm-tag-new"
                        class="cm-input"
                        placeholder="Digite a etiqueta"/>

                      <input
                        type="color"
                        id="cm-tag-new-color"
                        value="#888888"
                        style="height:44px; width:44px; padding:0;"/>

                      <button type="button" id="cm-tag-add" class="cm-btn primary">Incluir</button>

                      <button type="button" id="cm-tag-delete-toggle" class="cm-btn">Excluir etiquetas</button>
                    </div>

                    <div class="cm-tag-list" id="cm-tag-list"></div>
                  </div>



              </div>

              <div class="cm-muted">
                Dica: as etiquetas ficam sempre vis√≠veis no topo do modal (clique nelas para escolher a cor).
              </div>
            </div>
          </section>

          <!-- Aba: Checklists -->
          <section class="cm-panel" data-cm-panel="check" role="tabpanel">
            <div class="cm-card space-y-3">
              <div class="space-y-3">
                <label class="cm-label">Novo checklist</label>

                <div class="flex gap-2">
                  <input id="cm-checklist-create-input"
                         type="text"
                         name="title"
                         form="cm-checklist-create-form"
                         class="cm-input"
                         placeholder="Ex: Tarefas da semana">

                  <button type="submit"
                          form="cm-checklist-create-form"
                          class="cm-btn primary">
                    <span class="underline font-semibold">A</span>dicionar
                  </button>
                </div>
              </div>

              <div id="checklist-list" class="space-y-4">
                {% include "boards/partials/checklist_list.html" with checklists=checklists %}
              </div>
            </div>
          </section>

          <!-- Aba: Anexos -->
          <section class="cm-panel" data-cm-panel="files" role="tabpanel">
            <div class="cm-card space-y-3">
              <div id="attachments-error"
                   class="hidden mb-2 px-3 py-2 rounded-md text-sm border border-red-500/30 bg-red-500/10 text-red-200"></div>

              <div>
                <label class="cm-label">
                  Enviar novo anexo clicando em 'Choose File' ou, se for uma imagem em print, CTRL-V. Voc√™ tamb√©m pode arrastar o arquivo para o campo Choose File, segure por um segundo e solte
                </label>

                <!-- wrapper flex RESTAURADO (isso mant√©m o DOM v√°lido e o layout split funcionando) -->
                <div class="flex gap-2 flex-wrap">
                  <input type="text"
                         id="attachment-desc"
                         name="attachment_desc"
                         class="cm-input"
                         style="max-width: 420px;"
                         placeholder="Descri√ß√£o do anexo (opcional)">

                  <input type="file"
                         name="file"
                         id="attachment-file"
                         class="cm-input"
                         style="max-width: 520px;"
                         hx-post="{% url 'boards:add_attachment' card.id %}"
                         hx-target="#attachments-list"
                         hx-swap="beforeend"
                         hx-trigger="change"
                         hx-encoding="multipart/form-data"
                         hx-include="#attachment-desc, input[name='csrfmiddlewaretoken']"
                         hx-on::after-request="
                           if (event.detail && event.detail.successful) {
                             htmx.ajax('GET', '{% url 'boards:activity_panel' card.id %}', '#cm-activity-panel');
                             if (typeof window.refreshCardSnippet === 'function') { window.refreshCardSnippet({{ card.id }}); }
                           }
                         ">
                </div>

                <div class="cm-muted" style="margin-top:6px;">Limite: 50MB por arquivo.</div>
              </div>

              <div id="attachments-list" class="space-y-3">
                {% for attachment in card.attachments.all %}
                  {% include "boards/partials/attachment_item.html" %}
                {% empty %}
                  <div class="cm-muted">Nenhum anexo ainda.</div>
                {% endfor %}
              </div>
            </div>
          </section>

          <!-- Aba: Track-time -->
          <section class="cm-panel" data-cm-panel="track" role="tabpanel">
            <div id="cm-tracktime-panel"
                 data-track-url="{% url 'tracktime:card_panel' card.id %}"
                 data-track-loaded="0">
              <div class="cm-card cm-muted">
                Clique na aba Track-time para carregar‚Ä¶
              </div>
            </div>
          </section>

        </div>
      </form>

      <div id="cm-floatbar" class="cm-floatbar hidden" aria-live="polite">
        <div class="cm-floatbar-inner">
          {% comment %} <button type="submit" form="cm-main-form" class="cm-btn primary" id="cm-float-save-btn"> {% endcomment %}
          <button type="submit" form="cm-main-form" class="cm-btn primary" id="cm-tag-color-save-btn">
  <span class="underline font-semibold">S</span>alvar
</button>

          <button type="button" class="cm-btn" id="cm-close-btn">Fechar</button>
        </div>
      </div>

    </div>

    <!-- COLUNA DIREITA -->
    <aside class="cm-activity">
  <section class="cm-activity-panel cm-activity-panel--split" role="region">


          <div class="cm-activity-togglebar" role="tablist" aria-label="Atividade">
  <div class="flex items-center justify-between gap-2 flex-wrap">
    <div class="cm-activity-tabs">
      <button type="button"
              id="cm-activity-tab-feed"
              class="cm-btn cm-activity-tab is-active"
              role="tab"
              aria-selected="true"
              aria-controls="cm-activity-feed">
        Feed
        <span id="cm-activity-feed-count" class="cm-activity-badge hidden" aria-label="Total de itens no feed"></span>
      </button>

      <button type="button"
              id="cm-activity-tab-new"
              class="cm-btn cm-activity-tab"
              role="tab"
              aria-selected="false"
              aria-controls="cm-activity-composer">
        Nova Atividade
      </button>
    </div>





    
    <div class="flex items-center gap-2">
<form id="cm-delivered-form"
      method="post"
      hx-post="{% url 'boards:update_card' card.id %}"
      hx-trigger="change"
      hx-target="#modal-body"
      hx-swap="innerHTML">
  {% csrf_token %}

  <!-- garante envio de 0 quando desmarcar -->
  <input type="hidden" name="is_delivered" value="0">

  <label class="cm-delivered-toggle" title="Marcar como entregue (para de notificar por prazo/cores)">
    <input
      type="checkbox"
      id="cm-is-delivered"
      name="is_delivered"
      value="1"
      {% if card.is_delivered %}checked{% endif %}
    >
    <span class="cm-delivered-ui">
      <span class="cm-delivered-dot" aria-hidden="true"></span>
      <span class="cm-delivered-text">Entregue</span>
    </span>
  </label>
</form>

</div>






        <div id="cm-activity-composer" class="cm-card space-y-3 is-hidden">
          <form id="cm-activity-form"
                method="post"
                hx-post="{% url 'boards:add_activity' card.id %}"
                hx-target="#cm-activity-panel"
                hx-swap="innerHTML">
            {% csrf_token %}

            <div id="activity-error"
                 class="hidden mb-2 px-3 py-2 rounded-md text-sm border border-red-500/30 bg-red-500/10 text-red-200"></div>

            <label class="cm-label">Nova atividade</label>

            <div class="cm-activity-quill">
              <div id="cm-activity-editor"></div>
            </div>

            <input type="hidden" name="content" id="cm-activity-content">

            <div class="flex gap-2">
              {% comment %} 
              <button
                type="button"
                class="cm-btn primary"
                onclick="
                  const form = document.getElementById('cm-activity-form');
                  if (!form) return;

                  // sem feedback visual de clique (trava r√°pido)
                  this.disabled = true;

                  // d√° tempo do Quill/mention aplicar a inser√ß√£o no hidden antes do submit
                  setTimeout(() => {
                    try {
                      if (form.requestSubmit) form.requestSubmit();
                      else form.submit();
                    } catch (_e) {
                      try { form.submit(); } catch (_e2) {}
                    } finally {
                      setTimeout(() => { try { this.disabled = false; } catch (_e3) {} }, 800);
                    }
                  }, 250);
                "
              >
                <span class="underline font-semibold">I</span>ncluir
              </button> 
              {% endcomment %}

<button
  id="cm-activity-submit"
  type="button"
  class="cm-btn primary"
  data-busy-text="Enviando‚Ä¶"
  onclick="
    event.preventDefault();

    const form = this.form;
    if (!form) return;

    // trava at√© o HTMX finalizar (sem timeout)
    this.disabled = true;
    this.dataset.origHtml = this.dataset.origHtml || this.innerHTML;
    this.innerHTML = this.getAttribute('data-busy-text') || 'Enviando‚Ä¶';

    // evita duplo clique
    form.dataset.cmBusy = '1';

    // mant√©m o micro-delay pro Quill/mention sincronizar
    setTimeout(() => {
      try {
        if (form.requestSubmit) form.requestSubmit();
        else {
          const ev = new Event('submit', { bubbles: true, cancelable: true });
          if (form.dispatchEvent(ev)) form.submit();
        }
      } catch (_e) {}
    }, 150);
  "
>
  <span class="underline font-semibold">I</span>ncluir
</button>



              <button type="button" class="cm-btn" onclick="resetActivityQuill()">Limpar</button>
            </div>
          </form>
        </div>

        <div id="cm-activity-gap" style="height: 10px;" class="is-hidden"></div>

        <div class="cm-card" id="cm-activity-feed" role="tabpanel" aria-labelledby="cm-activity-tab-feed">
          <div id="cm-activity-panel">
            {% include "boards/partials/card_activity_panel.html" %}
          </div>
        </div>


      </section>
    </aside>

  </div>

  <div id="cm-action-dock" aria-label="A√ß√µes do card">
    <div class="dock-wrap">
      <button type="button"
              id="cm-dock-toggle"
              class="dock-toggle"
              aria-expanded="false"
              aria-haspopup="true"
              aria-controls="cm-dock-menu">
        ‚ãÆ
      </button>

      <div id="cm-dock-menu" class="hidden" role="menu" aria-label="Menu de a√ß√µes">
        <button type="button"
                class="dock-action"
                id="cm-dock-duplicate"
                role="menuitem"
                data-url-duplicate="{% url 'boards:duplicate_card' card.id %}">
          <span>üìÑ</span> <span class="label">Duplicar</span>
        </button>

        <button type="button"
                class="dock-action"
                id="cm-dock-move"
                role="menuitem"
                data-url-move="{% url 'boards:card_move_options' card.id %}">
          <span>‚ÜîÔ∏è</span> <span class="label">Mover</span>
        </button>

        <button type="button"
                class="dock-action"
                id="cm-dock-copylink"
                role="menuitem">
          <span>üîó</span> <span class="label">Copiar link</span>
        </button>

            <button type="button"
            class="dock-action"
            role="menuitem"
            hx-post="{% url 'boards:archive_card' card.id %}"
            hx-swap="none"
            hx-include="#cm-main-form input[name='csrfmiddlewaretoken']"
            hx-confirm="Arquivar este card? Ele vai sair do quadro e ir para Arquivados."
            >
      <span>üóÉÔ∏è</span> <span class="label">Arquivar card</span>
    </button>

    <button type="button"
            class="dock-action"
            role="menuitem"
            hx-post="{% url 'boards:trash_card' card.id %}"
            hx-swap="none"
            hx-include="#cm-main-form input[name='csrfmiddlewaretoken']"
            hx-confirm="Enviar este card para a Lixeira?"
            >
      <span>üóëÔ∏è</span> <span class="label">Excluir card</span>
    </button>

      </div>
    </div>





    <div id="cm-action-dock-panel" role="dialog" aria-label="Painel de a√ß√£o" class="hidden">
      <div id="cm-dock-panel-body"></div>
    </div>
  </div>

</div>


<script>
(function () {
  const root = document.getElementById("cm-root");
  if (!root) return;

  const cardId = (root.getAttribute("data-card-id") || "").trim() || "x";
  const ALLOWED = ["desc", "tags", "check", "ativ", "files", "track"];
  const STORAGE_KEY = `cm_active_tab_${cardId}`;

  function clampTab(tab) {
    const t = String(tab || "").trim();
    return ALLOWED.includes(t) ? t : "desc";
  }

  function getActiveTab() {
    return clampTab(root.getAttribute("data-cm-active") || root.dataset.cmActive || "desc");
  }

  function setActiveTab(tab) {
    const t = clampTab(tab);

    const btn = root.querySelector(`.cm-tabbtn[data-cm-tab="${CSS.escape(t)}"]`);
    if (btn) {
      root.setAttribute("data-cm-active", t);
      root.dataset.cmActive = t;

      root.querySelectorAll(".cm-tabbtn[data-cm-tab]").forEach((b) => {
        b.classList.toggle("is-active", b.getAttribute("data-cm-tab") === t);
      });

      root.querySelectorAll(".cm-panel[data-cm-panel]").forEach((p) => {
        p.classList.toggle("is-active", p.getAttribute("data-cm-panel") === t);
      });

      try { root.dispatchEvent(new CustomEvent("cm:tabchange", { detail: { tab: t } })); } catch (_e) {}
      return;
    }


    root.setAttribute("data-cm-active", t);
    root.dataset.cmActive = t;

    root.querySelectorAll(".cm-tabbtn[data-cm-tab]").forEach((b) => {
      b.classList.toggle("is-active", b.getAttribute("data-cm-tab") === t);
    });

    root.querySelectorAll(".cm-panel[data-cm-panel]").forEach((p) => {
      p.classList.toggle("is-active", p.getAttribute("data-cm-panel") === t);
    });

    try { root.dispatchEvent(new CustomEvent("cm:tabchange", { detail: { tab: t } })); } catch (_e) {}
  }

  function hasStoredTab() {
    try { return sessionStorage.getItem(STORAGE_KEY) !== null; } catch (_e) { return false; }
  }

  function loadStoredTab() {
    try { return clampTab(sessionStorage.getItem(STORAGE_KEY) || "desc"); }
    catch (_e) { return "desc"; }
  }

  function storeTab(tab) {
    try { sessionStorage.setItem(STORAGE_KEY, clampTab(tab)); } catch (_e) {}
  }

  (function initTabPersistence() {
    const initial = hasStoredTab() ? loadStoredTab() : "desc";
    storeTab(initial);

    setTimeout(() => setActiveTab(initial), 0);
    setTimeout(() => setActiveTab(loadStoredTab()), 50);

    root.addEventListener("cm:tabchange", function (e) {
      const t = clampTab(e.detail && e.detail.tab);
      storeTab(t);
    });

    if (window.__cmTabKeepBound === true) return;
    window.__cmTabKeepBound = true;

    document.body.addEventListener("htmx:beforeRequest", function () {
      const r = document.getElementById("cm-root");
      if (!r) return;

      const mode = r.dataset.cmMode || "legacy";
      if (mode === "legacy") return;

      const cid = (r.getAttribute("data-card-id") || "").trim() || "x";
      const key = `cm_active_tab_${cid}`;
      const t = clampTab(r.dataset.cmActive || r.getAttribute("data-cm-active") || "desc");
      try { sessionStorage.setItem(key, t); } catch (_e) {}
    });

    document.body.addEventListener("htmx:afterSwap", function (evt) {
      const target = evt.target;
      if (!target) return;

      if (target.id === "modal-body") {
        const r = document.getElementById("cm-root");
        if (!r) return;

        const cid = (r.getAttribute("data-card-id") || "").trim() || "x";
        const key = `cm_active_tab_${cid}`;
        let t = "desc";
        try { t = clampTab(sessionStorage.getItem(key) || "desc"); } catch (_e) {}

        setTimeout(() => {
          const rr = document.getElementById("cm-root");
          if (rr && (rr.getAttribute("data-card-id") || "").trim() === cid) {
            const btn = rr.querySelector(`.cm-tabbtn[data-cm-tab="${CSS.escape(t)}"]`);
            if (btn) btn.click();
          }
        }, 0);

        setTimeout(() => {
          const rr = document.getElementById("cm-root");
          if (rr && (rr.getAttribute("data-card-id") || "").trim() === cid) {
            const btn = rr.querySelector(`.cm-tabbtn[data-cm-tab="${CSS.escape(t)}"]`);
            if (btn) btn.click();
          }
        }, 50);
      }
    });
  })();

  (function initPreventEnterSubmit() {
    const form = document.getElementById("cm-main-form");
    if (!form) return;

    form.addEventListener("keydown", function (ev) {
      if (ev.key !== "Enter") return;
      if (ev.isComposing) return;

      const el = ev.target;
      if (!el) return;

      if (el.tagName === "TEXTAREA") return;

      const shouldBlock = el.matches(
        'input[name="title"], input[name="tags"], #cm-due-date-display, #cm-due-warn-date-display, #cm-start-date-display'
      );

      if (shouldBlock) {
        ev.preventDefault();
        ev.stopPropagation();
        try { el.blur(); } catch (_e) {}
      }
    }, true);
  })();

  (function initFloatbarDirty() {
    const form = document.getElementById("cm-main-form");
    const floatbar = document.getElementById("cm-floatbar");
    const floatSave = document.getElementById("cm-save-btn");
    const closeBtn = document.getElementById("cm-close-btn");

    if (!form || !floatbar) return;

    const WATCH = [
      "card_title",
      "description",
      "tags",
      "due_color_ok",
      "due_color_warn",
      "due_color_overdue",
      "due_date",
      "due_warn_date",
      "due_notify",
      "start_date",
      "is_delivered",
    ];


    function snapshot() {
      const fd = new FormData(form);
      const obj = {};
      WATCH.forEach((k) => { obj[k] = ""; });

      for (const [k, v] of fd.entries()) {
        if (!WATCH.includes(k)) continue;
        // √∫ltimo valor vence (resolve hidden+checkbox)
        obj[k] = String(v ?? "");
      }

      return obj;
    }


    let base = snapshot();

    function isDirty() {
      const now = snapshot();
      for (const k of WATCH) {
        if (String(now[k] ?? "") !== String(base[k] ?? "")) return true;
      }
      return false;
    }

    function isActionsTabActive() {
      const t = getActiveTab();
      return t === "desc" || t === "tags";
    }

    function syncFloatbar() {
      const show = isActionsTabActive() && isDirty();
      floatbar.classList.toggle("hidden", !show);
    }

    form.addEventListener("input", syncFloatbar, true);
    form.addEventListener("change", syncFloatbar, true);
    root.addEventListener("cm:tabchange", syncFloatbar);

    form.addEventListener("htmx:afterRequest", function (evt) {
      if (evt.target !== form) return;
      if (!evt.detail || !evt.detail.successful) return;

      base = snapshot();
      syncFloatbar();

      if (typeof window.refreshCardSnippet === "function") {
        try { window.refreshCardSnippet(cardId); } catch (_e) {}
      }
    });

    if (floatSave) {
      floatSave.addEventListener("click", function (e) {
        e.preventDefault();
        e.stopPropagation();
        storeTab(getActiveTab());
        try { form.requestSubmit ? form.requestSubmit() : form.submit(); }
        catch (_e) { try { form.submit(); } catch (_e2) {} }
      });
    }

    if (closeBtn) {
      closeBtn.addEventListener("click", function () {
        if (typeof window.closeModal === "function") return window.closeModal();
        const x = document.querySelector("#modal .modal-top-x");
        if (x) x.click();
      });
    }

    syncFloatbar();
  })();

  (function initDueDatePickers() {
    const form = document.getElementById("cm-main-form");
    if (!form) return;

    function parseBRtoISO(s) {
      const v = String(s || "").trim();
      const m = v.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (!m) return "";
      const dd = parseInt(m[1], 10);
      const mm = parseInt(m[2], 10);
      const yy = parseInt(m[3], 10);
      if (!yy || mm < 1 || mm > 12 || dd < 1 || dd > 31) return "";
      const dt = new Date(yy, mm - 1, dd);
      if (dt.getFullYear() !== yy || (dt.getMonth() + 1) !== mm || dt.getDate() !== dd) return "";
      return `${String(yy).padStart(4, "0")}-${String(mm).padStart(2, "0")}-${String(dd).padStart(2, "0")}`;
    }

    function formatISOtoBR(iso) {
      const v = String(iso || "").trim();
      const m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return "";
      return `${m[3]}/${m[2]}/${m[1]}`;
    }

    function digitsOnly(s) { return String(s || "").replace(/\D+/g, ""); }

    function maskDDMMYYYY(raw) {
      const d = digitsOnly(raw).slice(0, 8);
      const p1 = d.slice(0, 2);
      const p2 = d.slice(2, 4);
      const p3 = d.slice(4, 8);
      let out = p1;
      if (p2) out += "/" + p2;
      if (p3) out += "/" + p3;
      return out;
    }

    function openPicker(picker) {
      if (!picker) return;
      if (typeof picker.showPicker === "function") {
        try { picker.showPicker(); return; } catch (_e) {}
      }
      try { picker.click(); } catch (_e) {}
    }

    function wire(prefix) {
      const display = document.getElementById(`cm-${prefix}-display`);
      const picker = document.getElementById(`cm-${prefix}-picker`);
      const hidden = document.getElementById(`cm-${prefix}`);
      if (!display || !picker || !hidden) return;

      if (display.dataset.cmDateBound === "1") return;
      display.dataset.cmDateBound = "1";

      display.addEventListener("input", function () {
        const masked = maskDDMMYYYY(display.value);
        if (display.value !== masked) display.value = masked;
      });

      display.addEventListener("blur", function () {
        const iso = parseBRtoISO(display.value);
        hidden.value = iso;
        if (iso) {
          picker.value = iso;
          display.value = formatISOtoBR(iso);
        }
      });

      display.addEventListener("click", function () { openPicker(picker); });

      const icon = display.parentElement && display.parentElement.querySelector
        ? display.parentElement.querySelector("span")
        : null;

      if (icon) { icon.addEventListener("click", function () { openPicker(picker); }); }

      picker.addEventListener("input", function () {
        const iso = String(picker.value || "").trim();
        hidden.value = iso;
        display.value = iso ? formatISOtoBR(iso) : "";
      });

      picker.addEventListener("change", function () {
        const iso = String(picker.value || "").trim();
        hidden.value = iso;
        display.value = iso ? formatISOtoBR(iso) : "";
      });

      const iso0 = String(hidden.value || "").trim() || String(picker.value || "").trim();
      hidden.value = iso0;
      picker.value = iso0;
      display.value = iso0 ? formatISOtoBR(iso0) : "";
    }

    wire("start-date");
    wire("due-date");
    wire("due-warn-date");
  })();

  (function initDueColorDots() {
    root.querySelectorAll("label.cm-due-color").forEach((label) => {
      const input = label.querySelector('input[type="color"]');
      const dot = label.querySelector(".cm-color-dot");
      if (!input || !dot) return;

      const sync = () => {
        dot.style.backgroundColor = input.value || "transparent";
        dot.style.borderColor = input.value || "transparent";
      };

      if (input.dataset.cmDotBound === "1") return;
      input.dataset.cmDotBound = "1";

      sync();
      input.addEventListener("input", sync);
      input.addEventListener("change", sync);
    });
  })();
})();
</script>

<script>
(function () {
  const root = document.getElementById("cm-root");
  if (!root) return;

  if (root.dataset.cmHotkeysBound === "1") return;
  root.dataset.cmHotkeysBound = "1";

  function clampKey(e) {
    const code = (e.code || "").toLowerCase();
    if (code === "keys") return "s";
    if (code === "keyi") return "i";
    if (code === "keya") return "a";
    return (e.key || "").toLowerCase();
  }

  function gotoTab(tab) {
    const btn = root.querySelector(`.cm-tabbtn[data-cm-tab="${CSS.escape(tab)}"]`);
    if (!btn) return false;
    btn.click();
    return true;
  }

  function submitFormById(id) {
    const form = document.getElementById(id);
    if (!form) return false;

    try {
      if (form.requestSubmit) form.requestSubmit();
      else form.submit();
      return true;
    } catch (_e) {
      try { form.submit(); return true; } catch (_e2) {}
    }
    return false;
  }

  root.addEventListener("keydown", function (e) {
    if (!e.altKey) return;
    if (e.ctrlKey || e.metaKey) return;

    const k = clampKey(e);
    if (k !== "s" && k !== "i" && k !== "a") return;

    e.preventDefault();
    e.stopPropagation();

    if (k === "s") {
      const btn = document.getElementById("cm-float-save-btn") || document.getElementById("cm-save-btn");
      if (btn) { btn.click(); return; }
      submitFormById("cm-main-form");
      return;
    }


    if (k === "i") {
      gotoTab("ativ");
      setTimeout(() => submitFormById("cm-activity-form"), 0);
      return;
    }

    if (k === "a") {
      gotoTab("check");
      setTimeout(() => submitFormById("cm-checklist-create-form"), 0);
      return;
    }
  }, true);
})();
</script>

<script>
(function () {
  function getRoot() { return document.getElementById("cm-root"); }

  function getActiveTab() {
    const r = getRoot();
    if (!r) return "desc";

    const attr = (r.dataset.cmActive || r.getAttribute("data-cm-active") || "").trim();
    if (attr) return attr;

    const btn = r.querySelector(".cm-tabbtn.is-active[data-cm-tab]");
    if (btn) return (btn.getAttribute("data-cm-tab") || "desc").trim();

    const panel = r.querySelector(".cm-panel.is-active[data-cm-panel]");
    if (panel) return (panel.getAttribute("data-cm-panel") || "desc").trim();

    return "desc";
  }

  function randomName(ext) {
    const now = new Date();
    const stamp =
      String(now.getFullYear()) +
      String(now.getMonth() + 1).padStart(2, "0") +
      String(now.getDate()).padStart(2, "0") + "-" +
      String(now.getHours()).padStart(2, "0") +
      String(now.getMinutes()).padStart(2, "0") +
      String(now.getSeconds()).padStart(2, "0");

    let rnd = "";
    try { rnd = crypto.getRandomValues(new Uint32Array(2)).join(""); }
    catch (_e) { rnd = String(Math.random()).slice(2); }

    return `print-${stamp}-${rnd}${ext}`;
  }

  if (window.__cmAttachPasteBound !== true) {
    window.__cmAttachPasteBound = true;

    document.addEventListener("paste", function (e) {
      if (getActiveTab() !== "files") return;

      const r = getRoot();
      if (!r) return;

      const fileInput = r.querySelector("#attachment-file");
      if (!fileInput) return;

      const cd = e.clipboardData;
      if (!cd || !cd.items || !cd.items.length) return;

      let imgItem = null;
      for (const it of cd.items) {
        if (it && it.kind === "file" && String(it.type || "").startsWith("image/")) { imgItem = it; break; }
      }
      if (!imgItem) return;

      const blob = imgItem.getAsFile();
      if (!blob) return;

      e.preventDefault();
      e.stopPropagation();

      const mime = String(blob.type || "image/png");
      const ext = mime === "image/jpeg" ? ".jpg" : (mime === "image/webp" ? ".webp" : ".png");
      const file = new File([blob], randomName(ext), { type: mime });

      const desc = r.querySelector("#attachment-desc");
      const focused = document.activeElement === desc;
      if (desc && !focused && !String(desc.value || "").trim()) { desc.value = "Print (Ctrl+V)"; }

      const dt = new DataTransfer();
      dt.items.add(file);

      try { fileInput.files = dt.files; } catch (_e) { return; }
      fileInput.dispatchEvent(new Event("change", { bubbles: true }));
      setTimeout(() => { try { fileInput.value = ""; } catch (_e) {} }, 0);
    }, true);
  }

  function initAttachmentDragDrop() {
    const r = getRoot();
    if (!r) return;
    if (r.dataset.cmDropBound === "1") return;
    r.dataset.cmDropBound = "1";

    const modalRoot = document.getElementById("card-modal-root") || r;
    const fileInput = r.querySelector("#attachment-file");
    if (!fileInput) return;

    function setDragUI(on) { modalRoot.classList.toggle("cm-dragover", !!on); }

    function onDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      if (e.dataTransfer) e.dataTransfer.dropEffect = "copy";
      setDragUI(true);
    }

    function onDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      setDragUI(false);

      const files = e.dataTransfer && e.dataTransfer.files ? e.dataTransfer.files : null;
      if (!files || !files.length) return;

      const dt = new DataTransfer();
      dt.items.add(files[0]);

      try { fileInput.files = dt.files; } catch (_e) { return; }
      fileInput.dispatchEvent(new Event("change", { bubbles: true }));
    }

    modalRoot.addEventListener("dragenter", onDragOver, true);
    modalRoot.addEventListener("dragover", onDragOver, true);
    modalRoot.addEventListener("drop", onDrop, true);
    modalRoot.addEventListener("dragleave", () => setDragUI(false), true);
  }

  function bootAttach() { initAttachmentDragDrop(); }

  document.addEventListener("DOMContentLoaded", bootAttach);
  document.body.addEventListener("htmx:afterSwap", function (evt) {
    if (evt.target && evt.target.id === "modal-body") bootAttach();
  });
})();
</script>



<!-- TRACK-TIME (HOTFIX: n√£o depende de cm:tabchange) -->
<script>
(function () {
  function getRoot() { return document.getElementById("cm-root"); }

  function loadTrack(root) {
    if (!root) return;

    const panel = root.querySelector("#cm-tracktime-panel");
    if (!panel) return;

    if (panel.getAttribute("data-track-loaded") === "1") return;

    const url = (panel.getAttribute("data-track-url") || "").trim();
    if (!url) return;

    panel.setAttribute("data-track-loaded", "1");

    if (window.htmx && typeof window.htmx.ajax === "function") {
      window.htmx.ajax("GET", url, { target: "#cm-tracktime-panel", swap: "innerHTML" });
      return;
    }

    fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }, credentials: "same-origin" })
      .then((r) => r.text())
      .then((html) => { panel.innerHTML = html; })
      .catch(() => {
        panel.setAttribute("data-track-loaded", "0");
        panel.innerHTML = '<div class="cm-card cm-muted">Falha ao carregar Track-time.</div>';
      });
  }

  document.addEventListener("click", function (e) {
    const root = getRoot();
    if (!root) return;

    const el = (e.target && e.target.nodeType === 1) ? e.target : e.target?.parentElement;
    const btn = el && typeof el.closest === "function"
      ? el.closest(".cm-tabbtn[data-cm-tab]")
      : null;
    if (!btn) return;


    const tab = String(btn.getAttribute("data-cm-tab") || "").trim();
    if (tab !== "track" && tab !== "tracktime") return;

    setTimeout(() => loadTrack(root), 0);
  }, true);

  document.addEventListener("DOMContentLoaded", function () {
    const root = getRoot();
    if (!root) return;
    const active = (root.getAttribute("data-cm-active") || root.dataset.cmActive || "desc").trim();
    if (active === "track" || active === "tracktime") loadTrack(root);
  });

  document.body.addEventListener("htmx:afterSwap", function (evt) {
    if (!evt.target || evt.target.id !== "modal-body") return;

    const root = getRoot();
    if (!root) return;
    const active = (root.getAttribute("data-cm-active") || root.dataset.cmActive || "desc").trim();
    if (active === "track" || active === "tracktime") loadTrack(root);
  });
})();
</script>

{% comment %} Capture e restaure o scroll do textarea durante swaps: {% endcomment %}
<script>
(function(){
  function getTA(){
    const r = document.getElementById("cm-root");
    return r ? r.querySelector("#cm-description") : null;
  }

  document.body.addEventListener("htmx:beforeSwap", function(evt){
    if (!evt.target || evt.target.id !== "modal-body") return;
    const ta = getTA();
    if (!ta) return;
    try{
      sessionStorage.setItem("cm_desc_scroll", String(ta.scrollTop || 0));
      sessionStorage.setItem("cm_desc_sel", String(ta.selectionStart || 0));
    }catch(_e){}
  });

  document.body.addEventListener("htmx:afterSwap", function(evt){
    if (!evt.target || evt.target.id !== "modal-body") return;
    const ta = getTA();
    if (!ta) return;
    try{
      const st = parseInt(sessionStorage.getItem("cm_desc_scroll") || "0", 10);
      const ss = parseInt(sessionStorage.getItem("cm_desc_sel") || "0", 10);
      ta.scrollTop = st;

      ta.setSelectionRange(ss, ss);
    }catch(_e){}
  });
})();
</script>

<script>
(function () {
  function getScrollContainer() {
    return document.querySelector("#modal-body.card-modal-scroll")
      || document.querySelector("#card-modal-root .card-modal-scroll")
      || document.getElementById("modal-body")
      || document.scrollingElement;
  }

  function lockScrollWhileEditing(root) {
    if (!root || root.dataset.cmScrollLock2Bound === "1") return;
    root.dataset.cmScrollLock2Bound = "1";

    const sc = getScrollContainer();
    if (!sc) return;

    let lastTop = 0;
    let raf1 = 0;
    let raf2 = 0;

    function capture() {
      lastTop = sc.scrollTop || 0;
    }

    function restore() {
      // 2 frames = p√≥s layout/reflow do Chromium
      cancelAnimationFrame(raf1);
      cancelAnimationFrame(raf2);

      raf1 = requestAnimationFrame(() => {
        sc.scrollTop = lastTop;
        raf2 = requestAnimationFrame(() => {
          sc.scrollTop = lastTop;
        });
      });
    }

    // textarea descri√ß√£o
    const ta = root.querySelector("#cm-description");
    if (ta && ta.dataset.cmScrollLock2 === "1") return;
    if (ta) {
      ta.dataset.cmScrollLock2 = "1";

      ta.addEventListener("keydown", function () { capture(); restore(); }, true);
      ta.addEventListener("input", function () { capture(); restore(); }, true);
      ta.addEventListener("compositionupdate", function () { capture(); restore(); }, true);
      ta.addEventListener("compositionend", function () { capture(); restore(); }, true);

      // se algum CSS/JS mudar altura, segura tamb√©m
      try {
        const ro = new ResizeObserver(() => { restore(); });
        ro.observe(ta);
      } catch (_e) {}
    }

    // Quill (se existir no modal)
    root.querySelectorAll(".ql-editor").forEach((ed) => {
      if (ed.dataset.cmScrollLock2 === "1") return;
      ed.dataset.cmScrollLock2 = "1";

      ed.addEventListener("keydown", function () { capture(); restore(); }, true);
      ed.addEventListener("input", function () { capture(); restore(); }, true);
      ed.addEventListener("compositionupdate", function () { capture(); restore(); }, true);
      ed.addEventListener("compositionend", function () { capture(); restore(); }, true);

      try {
        const ro = new ResizeObserver(() => { restore(); });
        ro.observe(ed);
      } catch (_e) {}
    });
  }

  function boot() {
    const root = document.getElementById("cm-root");
    if (!root) return;
    //lockScrollWhileEditing(root);
  }

  document.addEventListener("DOMContentLoaded", boot);
  document.body.addEventListener("htmx:afterSwap", function (evt) {
    if (evt.target && evt.target.id === "modal-body") boot();
  });
})();
</script>

<script>
  (function () {
  function boot() {
    const root = document.getElementById("cm-root");
    if (!root) return;

    const ta = root.querySelector("#cm-description");
    if (!ta) return;

    if (ta.dataset.cmTaScrollLock === "1") return;
    ta.dataset.cmTaScrollLock = "1";

    let last = 0;
    function capture() { last = ta.scrollTop || 0; }
    function restore() {
      requestAnimationFrame(() => {
        ta.scrollTop = last;
        requestAnimationFrame(() => { ta.scrollTop = last; });
      });
    }

    // captura antes e restaura depois (2 frames)
    ta.addEventListener("keydown", capture, true);
    ta.addEventListener("input", function () { restore(); }, true);
    ta.addEventListener("compositionstart", capture, true);
    ta.addEventListener("compositionupdate", function () { restore(); }, true);
    ta.addEventListener("compositionend", function () { restore(); }, true);
  }

  document.addEventListener("DOMContentLoaded", boot);
  document.body.addEventListener("htmx:afterSwap", function (evt) {
    if (evt.target && evt.target.id === "modal-body") boot();
  });
})();
</script>











<script>
(function(){
  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  function bootFeed(){
    const root = document.getElementById("cm-root");
    if (!root) return;

    const feedRoot = $("#card-activity-panel", root);
    if (!feedRoot) return;

    if (feedRoot.dataset.cmFeedBound === "1") return;
    feedRoot.dataset.cmFeedBound = "1";

    const feed = $("#cm-feed", feedRoot);
    const q = $("#cm-feed-q", feedRoot);
    const filter = $("#cm-feed-filter", feedRoot);

    const preview = $("#cm-hover-preview", feedRoot);
    const pImg = $("#cm-hover-img", feedRoot);
    const pOpen = $("#cm-hover-open", feedRoot);

    const wrap = $("#activity-panel-wrapper", feedRoot);
    const pill = $("#cm-newmsg-pill", feedRoot);

    function norm(s){ return String(s||"").toLowerCase(); }

    function apply(){
      if (!feed) return;

      const query = norm(q && q.value).trim();
      const f = String(filter && filter.value || "comments");

      $all(".cm-feed-item", feed).forEach((it) => {
        const t = String(it.getAttribute("data-type") || "comments");
        const text = norm(it.getAttribute("data-text") || it.textContent || "");

        const okType = (f === "all") ? true : (t === f);
        const okQ = !query || text.includes(query);

        it.style.display = (okType && okQ) ? "" : "none";
      });

      $all(".cm-feed-day", feed).forEach((day) => {
        const anyVisible = $all(".cm-feed-item", day).some((it) => it.style.display !== "none");
        day.style.display = anyVisible ? "" : "none";
      });
    }

    if (q) q.addEventListener("input", apply);
    if (filter) filter.addEventListener("change", apply);
    apply();

    function hidePreview(){
      if (!preview) return;
      preview.classList.remove("is-on");
      preview.setAttribute("aria-hidden", "true");
    }

    if (feed){
      feed.addEventListener("mouseover", function(e){
        const thumb = e.target && e.target.closest ? e.target.closest(".cm-attach-thumb[data-preview-src]") : null;
        if (!thumb || !preview || !pImg) return;

        const src = thumb.getAttribute("data-preview-src");
        if (!src) return;

        pImg.src = src;
        if (pOpen) pOpen.href = src;

        preview.classList.add("is-on");
        preview.setAttribute("aria-hidden", "false");
      }, true);

      feed.addEventListener("mouseout", function(e){
        const thumb = e.target && e.target.closest ? e.target.closest(".cm-attach-thumb[data-preview-src]") : null;
        if (!thumb) return;

        // ‚úÖ Se o mouse est√° indo para dentro do preview, N√ÉO fecha
        const to = e.relatedTarget;
        if (to && preview && (to === preview || (preview.contains && preview.contains(to)))) return;

        hidePreview();
      }, true);


    document.addEventListener("keydown", function(e){
      if (e.key === "Escape") hidePreview();
    });

      if (preview) {
        preview.addEventListener("mouseenter", function(){
          preview.classList.add("is-on");
          preview.setAttribute("aria-hidden", "false");
        }, true);

        preview.addEventListener("mouseleave", function(){
          hidePreview();
        }, true);
      }


    if (pill && wrap){
      pill.addEventListener("click", function(){
        try { wrap.scrollTop = wrap.scrollHeight; } catch(_e){}
      });
    }
  }

  document.addEventListener("DOMContentLoaded", bootFeed);
  document.body.addEventListener("htmx:afterSwap", function(evt){
    if (!evt.target) return;

    // 1) Quando o modal inteiro troca
    if (evt.target.id === "modal-body") {
      bootFeed();
      return;
    }

    // 2) Quando SOMENTE o painel de atividade troca (ex.: etiqueta, anexo, etc.)
    if (evt.target.id === "cm-activity-panel") {
      bootFeed();
      return;
    }
  });

})();
</script>



<script>
(function () {
  if (window.__cmActivitySubmitBound === true) return;
  window.__cmActivitySubmitBound = true;

  function getForm() { return document.getElementById("cm-activity-form"); }
  function getBtn() { return document.getElementById("cm-activity-submit"); }

  function unlock() {
    const form = getForm();
    const btn = getBtn();
    if (form) form.dataset.cmBusy = "0";
    if (!btn) return;

    btn.disabled = false;
    if (btn.dataset.origHtml) btn.innerHTML = btn.dataset.origHtml;
  }

  // Quando terminar o request (sucesso OU falha)
  document.body.addEventListener("htmx:afterRequest", function (evt) {
    const elt = evt.detail && evt.detail.elt;
    if (elt && elt.id === "cm-activity-form") unlock();
  });

  document.body.addEventListener("htmx:responseError", function (evt) {
    const elt = evt.detail && evt.detail.elt;
    if (elt && elt.id === "cm-activity-form") unlock();
  });

  document.body.addEventListener("htmx:sendError", function (evt) {
    const elt = evt.detail && evt.detail.elt;
    if (elt && elt.id === "cm-activity-form") unlock();
  });
})();
</script>

<script>
  function bindActivityToggle() {
    const btn = document.getElementById("cm-activity-toggle");
    const composer = document.getElementById("cm-activity-composer");
    if (!btn || !composer) return;

    function setOpen(open) {
      if (open) {
        composer.classList.remove("is-hidden");

        // ‚úÖ monta toolbar/comandos do Quill quando o composer aparece
        try { window.ensureActivityQuill?.(); } catch (_e) {}

      } else {
        composer.classList.add("is-hidden");
      }

      btn.setAttribute("aria-expanded", open ? "true" : "false");
      try { composer.scrollIntoView({ behavior: "smooth", block: "start" }); } catch (_e) {}
    }

    btn.addEventListener("click", function (e) {
      e.preventDefault();
      const isHidden = composer.classList.contains("is-hidden");
      setOpen(isHidden);
    });
  }

  // mant√©m seu bootstrap existente
  document.addEventListener("DOMContentLoaded", bindActivityToggle);
</script>

<script>
  document.addEventListener("click", function (e) {
  const btn = e.target?.closest?.("#cm-float-save-btn, #cm-save-btn");
  if (!btn) return;

  const form = document.getElementById("cm-main-form");
  if (!form) return;

  // garante flush do Quill antes do submit
  try { window.__cmQuillHtmxSyncInstalled && (window.Modal?.quill?._descQuill?.update?.("silent")); } catch (_e) {}
  try {
    const root = document.getElementById("cm-root");
    const ta = root?.querySelector("#cm-description");
    const q = window.Modal?.quill?._descQuill;
    if (ta && q?.root) ta.value = q.root.innerHTML || "";
  } catch (_e) {}

  // agora submete
  try { form.requestSubmit ? form.requestSubmit() : form.submit(); } catch (_e) {}
}, true);
</script>





{# END templates/boards/partials/card_modal_split.html #}
