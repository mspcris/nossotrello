{# boards/templates/boards/index.html #}
{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% url 'boards:home_wallpaper_css' %}">
<link rel="stylesheet" href="{% static 'boards/home.css' %}">
<script src="{% static 'boards/home_groups.js' %}"></script>
{% endblock %}

{% block title %}NossoTrello - Boards{% endblock %}

{% block drawer_items %}
  <li>
    <button class="nt-link" type="button"
            hx-get="{% url 'boards:update_home_wallpaper' %}"
            hx-target="body" hx-swap="beforeend">
      Trocar papel de parede
    </button>
  </li>

  <li>
    <button class="nt-link" type="button"
            hx-post="{% url 'boards:remove_home_wallpaper' %}"
            hx-target="body" hx-swap="beforeend">
      Remover papel de parede
    </button>
  </li>

  <li>
    <button id="toggle-delete-mode" type="button" class="nt-link">
      Excluir quadros
    </button>
  </li>
{% endblock %}

{% block content %}

  <div id="home-groups-area" class="mb-8">

    {# ===================== FAVORITOS ===================== #}
    <div class="mb-6">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">⭐ Favoritos</h2>
        <span class="text-xs text-white/80">Marque a estrela em um quadro para aparecer aqui.</span>
      </div>

      <div class="home-group-dropzone" data-group-id="{{ favorites_group.id }}">
        <div class="flex flex-wrap gap-6" id="home-group-items-{{ favorites_group.id }}">
          {% for it in favorites_group_items %}
            {% include "boards/partials/home_board_card.html" with board=it.board favorite_board_ids=favorite_board_ids subtitle="Organizado aqui" %}
          {% empty %}
            <div class="text-gray-300 backdrop-blur-lg px-4 py-2 rounded-lg">
              Sem favoritos ainda.
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    {# ===================== CRIAR NOVO AGRUPAMENTO ===================== #}
    <div class="mb-4">
      <form class="flex gap-2 items-center"
            hx-post="{% url 'boards:home_group_create' %}"
            hx-target="#home-custom-groups"
            hx-swap="afterbegin">
        {% csrf_token %}
        <input type="text" name="name" class="rounded-lg px-3 py-2 w-64" placeholder="Novo agrupamento (ex: Clínicas RJ)">
        <button type="submit" class="px-3 py-2 bg-white/70 rounded-lg font-semibold">+ Criar agrupamento</button>
      </form>
    </div>

    {# ===================== GRUPOS CUSTOM ===================== #}
    <div id="home-custom-groups" class="flex flex-col gap-6">
      {% for row in custom_groups %}
        {% include "boards/partials/home_group_block.html" with g=row.group items=row.items favorite_board_ids=favorite_board_ids %}
      {% empty %}
        {# sem grupos custom ainda #}
      {% endfor %}
    </div>

  </div>

  {# ===================== LISTAS BASE (NÃO MEXER) ===================== #}
  <div class="pt-2 pr-4">
    <h1 class="text-2xl font-bold mb-6 home-title">Quadros</h1>

    <h2 class="text-lg font-semibold mb-3">Meus quadros</h2>
    <div class="flex flex-wrap gap-6 mb-10 home-source-list">
      {% for board in owned_boards %}
        {# usa o mesmo card padrão #}
        <div class="relative">
          {% include "boards/partials/home_board_card.html" with board=board favorite_board_ids=favorite_board_ids subtitle="Clique para abrir" %}
          <button
            hx-post="{% url 'boards:delete_board' board.id %}"
            hx-target="closest .relative"
            hx-swap="outerHTML"
            class="delete-button hidden text-red-600 text-sm underline hover:text-red-800 mt-2 text-left"
            type="button">
            Excluir quadro
          </button>
        </div>
      {% empty %}
        <p class="text-gray-300 backdrop-blur-lg px-4 py-2 rounded-lg">Nenhum quadro criado ainda.</p>
      {% endfor %}

      <div
        hx-get="{% url 'boards:add_board' %}"
        hx-target="body"
        hx-swap="beforeend"
        class="new-board-button cursor-pointer p-6 rounded-lg w-64 flex items-center justify-center font-semibold">
        + Criar novo quadro
      </div>
    </div>

    {% if shared_boards %}
      <h2 class="text-lg font-semibold mb-3">Compartilhados comigo</h2>
      <div class="flex flex-wrap gap-6 home-source-list">
        {% for board in shared_boards %}
          {# IMPORTANTE: mesmo card padrão + show_owner #}
          {% include "boards/partials/home_board_card.html" with board=board favorite_board_ids=favorite_board_ids subtitle="Compartilhado com você" show_owner=True owner_email=board.owner_email %}
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <script>
    (function () {
      const toggleBtn = document.getElementById("toggle-delete-mode");
      let deleteMode = false;

      toggleBtn?.addEventListener("click", () => {
        deleteMode = !deleteMode;

        document.querySelectorAll(".delete-button").forEach(btn => {
          btn.classList.toggle("hidden", !deleteMode);
        });

        if (toggleBtn) {
          toggleBtn.innerText = deleteMode ? "Sair do modo de exclusão" : "Excluir quadros";
        }
      });

      document.body.addEventListener("htmx:afterRequest", function () {
        if (!deleteMode) return;

        deleteMode = false;
        document.querySelectorAll(".delete-button").forEach(btn => btn.classList.add("hidden"));
        if (toggleBtn) toggleBtn.innerText = "Excluir quadros";
      });

      window.addEventListener("pageshow", function (event) {
        if (event.persisted) window.location.reload();
      });
    })();
  </script>

{% endblock %}
