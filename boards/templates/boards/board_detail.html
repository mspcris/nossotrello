{% extends "base.html" %}
{% load static %}
{% load tag_helpers %}

{% block title %}{{ board.name }}{% endblock %}

{% block content %}

<a href="{% url 'boards:boards_index' %}" class="text-blue-600 hover:underline mb-6 block">
    ‚Üê Voltar aos Quadros
</a>

<div class="flex items-center gap-4 mb-6">

    {% if board.image %}
    <div class="relative group inline-block">
        <div
            class="h-28 w-48 border border-gray-300 rounded-lg overflow-hidden bg-white flex items-center justify-center">
            <img src="{{ board.image.url }}" class="h-full w-auto object-contain">
        </div>

        <button class="absolute top-1 right-1 bg-red-600 text-white text-xs px-2 py-1 rounded
                       opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer"
            hx-post="{% url 'boards:update_board_image' board.id %}?delete=1" hx-target="body" hx-swap="beforeend">
            X
        </button>
    </div>
    {% else %}
    <div class="h-28 w-48 flex items-center justify-center rounded-lg border border-gray-300 
               bg-gray-100 text-gray-400 text-3xl cursor-pointer hover:bg-gray-200"
        hx-get="{% url 'boards:update_board_image' board.id %}" hx-target="body" hx-swap="beforeend">
        +
    </div>
    {% endif %}

    <!-- <h1 class="text-2xl font-bold">{{ board.name }}</h1> -->

    <h1 id="board-title" contenteditable="true" class="text-2xl font-semibold inline-block"
        onblur="updateBoardTitle({{ board.id }})"
        onkeypress="if(event.key==='Enter'){ event.preventDefault(); this.blur(); }">
        {{ board.name }}
    </h1>


</div>

<!-- üîç FILTRO POR ETIQUETA -->
<div class="mb-6 flex flex-wrap items-center gap-2">
    <span class="text-sm font-semibold text-gray-600">Filtrar por etiquetas:</span>

    <input type="text" id="tag-filter" placeholder="Ex: urgente" class="border rounded px-3 py-2 text-sm w-60"
        oninput="filterByTag(this.value)">
</div>

<h3 class="text-lg font-semibold mb-3">Colunas:</h3>

<div id="columns-wrapper" class="flex gap-6 overflow-x-auto pb-6 pr-4">
    <div id="columns-list" class="flex gap-6">
        {% for column in board.columns.all %}
        {% include "boards/partials/column_item.html" %}
        {% endfor %}
    </div>

    <div id="add-column-box"
        class="w-64 bg-white/60 backdrop-blur-md border border-gray-300 rounded-xl p-4 h-fit shrink-0 shadow-md">

        <h3 class="font-semibold mb-2">Adicionar nova coluna</h3>

        <form method="post" hx-post="{% url 'boards:add_column' board.id %}" hx-target="#columns-list"
            hx-swap="beforeend">

            {% csrf_token %}
            <label class="block text-sm font-medium mb-1">Nome:</label>
            <input type="text" name="name" class="w-full border rounded px-3 py-2 mb-3" placeholder="Nome da coluna">

            <button class="px-3 py-2 bg-blue-600 text-white rounded w-full">
                Adicionar Coluna
            </button>
        </form>
    </div>
</div>

<script>

    function filterByTag(text) {
        text = text.trim().toLowerCase();

        document.querySelectorAll('[id^="cards-col-"] li[data-card-id]')
            .forEach(card => {

                const tags = card.querySelectorAll('span.text-xs');
                let match = false;

                tags.forEach(t => {
                    if (t.innerText.toLowerCase().includes(text)) {
                        match = true;
                    }
                });

                card.style.display = (text === "" || match) ? "" : "none";
            });
    }

    function initSortable() {
        document.querySelectorAll("[id^='cards-col-']").forEach(listEl => {

            if (listEl.dataset.sortableApplied === "1") return;
            listEl.dataset.sortableApplied = "1";

            new Sortable(listEl, {
                group: "cards",
                animation: 150,
                ghostClass: "drag-ghost",

                onEnd: evt => {
                    const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]")?.value;

                    fetch("{% url 'boards:move_card' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrftoken
                        },
                        body: JSON.stringify({
                            card_id: Number(evt.item.dataset.cardId),
                            new_column_id: Number(evt.to.id.replace("cards-col-", "")),
                            new_position: Number(evt.newIndex)
                        })
                    });
                }
            });
        });
    }

    document.addEventListener("DOMContentLoaded", initSortable);
    document.body.addEventListener("htmx:afterSwap", initSortable);

</script>
<script>
    document.body.addEventListener("card-updated", function (ev) {
        const cardId = ev.detail.card_id;

        // elemento do card na coluna
        const cardEl = document.querySelector(`li[data-card-id="${cardId}"]`);

        if (!cardEl) return;

        // Atualiza o card fazendo GET no endpoint que renderiza apenas o card
        htmx.ajax("GET",
            `/card/${cardId}/snippet/`,   // vamos criar isso
            { target: cardEl, swap: "outerHTML" }
        );
    });





    function updateBoardTitle(boardId) {
        const titleEl = document.getElementById("board-title");
        const newTitle = titleEl.innerText.trim();

        const formData = new FormData();
        formData.append("name", newTitle);

        fetch(`/board/${boardId}/rename/`, {
            method: "POST",
            headers: { "X-CSRFToken": document.querySelector("meta[name='csrf-token']").content },
            body: formData
        });

    }

    function renameColumn(columnId) {
        const el = document.getElementById(`column-title-${columnId}`);
        if (!el) return;

        const newName = el.innerText.trim();
        if (!newName) return;

        const formData = new FormData();
        formData.append("name", newName);

        fetch(`/column/${columnId}/rename/`, {
            method: "POST",
            headers: { "X-CSRFToken": document.querySelector("meta[name='csrf-token']").content },
            body: formData
        })
            .then(res => res.text())
            .then(html => {
                document.querySelector(`#column-${columnId}`).outerHTML = html;
            });
    }




</script>



<style>
    .drag-ghost {
        opacity: 0.35;
        background: #cfcfcf;
    }
</style>

{% endblock %}