{% extends "base.html" %}
{% load static %}

{% block title %}{{ board.name }}{% endblock %}

{% block content %}

<h1 class="text-2xl font-bold mb-4">{{ board.name }}</h1>

<h3 class="text-lg font-semibold mb-2">Colunas:</h3>

<!-- WRAPPER PRINCIPAL -->
<div id="columns-wrapper" class="flex gap-6 overflow-x-auto pb-4">

    <!-- LISTA DE COLUNAS -->
    <div id="columns-list" class="flex gap-6">

        {% for column in board.columns.all %}
        {% include "boards/partials/column_item.html" %}
        {% endfor %}

    </div>

    <!-- FORMULÃRIO FIXO NA DIREITA -->
    <div id="add-column-box" class="w-64 bg-gray-100 p-4 rounded border h-fit shrink-0">

        <h3 class="font-semibold mb-2">Adicionar nova coluna</h3>

        <form method="post" hx-post="{% url 'boards:add_column' board.id %}" hx-target="#columns-list"
            hx-swap="beforeend">

            {% csrf_token %}

            <label class="block text-sm font-medium">Nome:</label>
            <input type="text" name="name" class="w-full border rounded px-3 py-2 mb-3" placeholder="Nome da coluna">

            <button class="px-3 py-2 bg-blue-600 text-white rounded">
                Adicionar Coluna
            </button>

        </form>

    </div>

</div>


<!-- SORTABLE JS -->
<script>
    function initSortable() {
        document.querySelectorAll("[id^='cards-col-']").forEach(function (listEl) {

            if (listEl.dataset.sortableApplied === "1") {
                return;
            }

            listEl.dataset.sortableApplied = "1";

            new Sortable(listEl, {
                group: "cards",
                animation: 150,
                ghostClass: "drag-ghost",

                onEnd: function (evt) {

                    const csrftoken =
                        document.querySelector("[name=csrfmiddlewaretoken]")?.value;

                    fetch("{% url 'boards:move_card' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrftoken
                        },
                        body: JSON.stringify({
                            card_id: Number(evt.item.dataset.cardId),
                            new_column_id: Number(evt.to.id.replace("cards-col-", "")),
                            new_position: Number(evt.newIndex)
                        })
                    });
                }
            });
        });
    }

    document.addEventListener("DOMContentLoaded", initSortable);

    document.body.addEventListener("htmx:afterSwap", () => {
        initSortable();
    });
</script>

<style>
    .drag-ghost {
        opacity: 0.3;
        background: #d0d0d0;
    }
</style>

{% endblock %}