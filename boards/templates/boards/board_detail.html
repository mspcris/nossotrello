<!-- BOARD_DETAIL.HTML -->
{% extends "base.html" %}
{% load static %}
{% load tag_helpers %}
{% block extra_css %}
<link rel="stylesheet" href="{% url 'boards:board_wallpaper_css' board.id %}">
<link rel="stylesheet" href="{% static 'boards/board_detail.css' %}">
{% endblock %}


{% block title %}{{ board.name }}{% endblock %}
{% block header_left %}
<div class="flex items-start gap-3">

    <!-- MENU HAMBÚRGUER (topo esquerdo) -->
    <div class="relative">
        <button id="board-menu-btn"
                class="text-xl text-gray-900 bg-white/80 border border-gray-400 rounded-md px-2 py-1 shadow-md hover:bg-white transition">
            ☰
        </button>

        <div id="board-menu"
             class="hidden absolute left-0 mt-2 bg-white shadow-lg rounded-md border p-2 w-48 z-50">
            <a href="{% url 'boards:boards_index' %}" class="block px-4 py-2 hover:bg-gray-100 rounded">
                ← Voltar aos Quadros
            </a>

{% if can_share_board %}
<button class="block text-left w-full px-4 py-2 hover:bg-gray-100 rounded"
        hx-get="{% url 'boards:board_share' board.id %}"
        hx-target="body" hx-swap="beforeend">
    Compartilhar quadro
</button>
{% elif can_leave_board %}
<form method="post" action="{% url 'boards:board_leave' board.id %}">
    {% csrf_token %}
    <button type="submit"
            class="block text-left w-full px-4 py-2 hover:bg-gray-100 text-red-600 rounded"
            onclick="return confirm('Sair deste quadro? Ele vai sumir da sua lista.')">
        Sair do quadro
    </button>
</form>
{% endif %}


            <button class="block text-left w-full px-4 py-2 hover:bg-gray-100 rounded"
                    hx-get="{% url 'boards:update_board_wallpaper' board.id %}"
                    hx-target="body" hx-swap="beforeend">
                Trocar Wallpaper
            </button>

            <button class="block text-left w-full px-4 py-2 hover:bg-gray-100 text-red-600"
                    hx-post="{% url 'boards:remove_board_wallpaper' board.id %}"
                    hx-target="body" hx-swap="beforeend">
                Remover papel de parede
            </button>

            <button id="toggle-delete-columns"
                    class="block text-left w-full px-4 py-2 hover:bg-gray-100 text-red-600 rounded">
                Excluir colunas
            </button>

            <button id="toggle-delete-cards"
                    class="block text-left w-full px-4 py-2 hover:bg-gray-100 text-red-600 rounded">
                Excluir cards
            </button>

            <form method="post" action="{% url 'logout' %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="px-4 py-2 w-full text-left hover:bg-gray-100 rounded">
                    Sair
                </button>
            </form>
        </div>
    </div>

    <!-- IMAGEM DO QUADRO (à direita do menu) -->
    {% if board.image %}
        <div class="relative group inline-block">
            <div class="h-16 w-28 border border-gray-300 rounded-lg overflow-hidden bg-white flex items-center justify-center">
                <img src="{{ board.image.url }}" class="h-full w-auto object-contain">
            </div>

            <button class="absolute top-1 right-1 bg-red-600 text-white text-xs px-2 py-0.5 rounded
                           opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer"
                    hx-post="{% url 'boards:remove_board_image' board.id %}"
                    hx-target="body" hx-swap="beforeend">
                X
            </button>
        </div>
    {% else %}
        <div class="h-16 w-28 flex items-center justify-center rounded-lg border border-gray-300
                    bg-gray-100 text-gray-400 text-2xl cursor-pointer hover:bg-gray-200"
             hx-get="{% url 'boards:update_board_image' board.id %}"
             hx-target="body" hx-swap="beforeend">
            +
        </div>
    {% endif %}

    <!-- NOME DO QUADRO (à direita da imagem) -->
    <h1 id="board-title" contenteditable="true"
        class="text-2xl font-semibold inline-block bg-white/70 px-2 py-1 rounded"
        onblur="updateBoardTitle({{ board.id }})"
        onkeypress="if(event.key==='Enter'){ event.preventDefault(); this.blur(); }">
        {{ board.name }}
    </h1>

</div>
{% endblock %}


{% block header_right_under_logo %}
<div class="w-64">
  <div class="flex items-center justify-between">
    <span id="filter-label" class="text-sm font-semibold text-gray-600 board-label">
      Filtrar por:
    </span>

    <!-- Segmented control: Tags | Texto -->
    <div class="inline-flex rounded-md border border-gray-300 bg-white/80 overflow-hidden">
      <button
        type="button"
        id="filter-mode-tags"
        class="px-3 py-1 text-xs font-semibold bg-gray-900 text-white"
        onclick="setFilterMode('tags')"
      >
        Tags
      </button>
      <button
        type="button"
        id="filter-mode-text"
        class="px-3 py-1 text-xs font-semibold text-gray-700"
        onclick="setFilterMode('text')"
      >
        Texto
      </button>
    </div>
  </div>

  <input
    type="text"
    id="board-filter"
    placeholder="Ex: urgente"
    class="border rounded px-3 py-2 text-sm w-full mt-2"
    oninput="applyBoardFilter(this.value)"
  >
</div>
{% endblock %}


{% block content %}





<script>
const menuBtn = document.getElementById("board-menu-btn");
const menu = document.getElementById("board-menu");

menuBtn?.addEventListener("click", () => menu.classList.toggle("hidden"));

document.addEventListener("click", (ev) => {
  if (!menu || !menuBtn) return;
  if (!menu.contains(ev.target) && !menuBtn.contains(ev.target)) menu.classList.add("hidden");
});
</script>



<!-- ======================== LISTA DE COLUNAS ======================== -->
<div id="columns-wrapper" class="flex gap-6 overflow-x-auto overflow-y-hidden pb-6 pr-4 h-[calc(100vh-140px)]">


    <div id="columns-list" class="flex gap-6">
        {% for column in columns %}
            {% include "boards/partials/column_item.html" %}
        {% endfor %}

    </div>

    <div id="add-column-box"
        class="w-64 bg-white/60 backdrop-blur-md border border-gray-300 rounded-xl p-4 h-fit shrink-0 shadow-md">

        <h3 class="font-semibold mb-2">Adicionar nova coluna</h3>

        <form method="post"
      id="add-column-form"
      hx-post="{% url 'boards:add_column' board.id %}"
      hx-target="#columns-list"
      hx-swap="beforeend"
      hx-on="submit: if(!validateAddColumnForm(this,event)) return false;
             htmx:afterRequest: if (event.detail.successful) { this.reset(); hideAddColumnError(); }">

  {% csrf_token %}

  <label class="block text-sm font-medium mb-1">Nome:</label>

  <input type="text"
         name="name"
         id="add-column-name"
         class="w-full border rounded px-3 py-2 mb-2"
         placeholder="Nome da coluna">

  <div id="add-column-error"
       class="hidden text-sm text-red-700 bg-red-50 border border-red-200 rounded px-3 py-2 mb-3">
    Digite o nome da coluna antes.
  </div>

  <button class="px-3 py-2 bg-blue-600 text-white rounded w-full" type="submit">
    Adicionar Coluna
  </button>
</form>

    </div>
</div>



<!-- ======================== SCRIPTS ======================== -->

<script>
  // ============================================================
  // FILTER (Tags = frontend | Texto = backend)
  // ============================================================

  // state
  window.__boardFilterMode = "tags"; // "tags" | "text"

  function debounce(fn, wait) {
    let t;
    return function (...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  function resetSearchUI() {
    // volta tudo (cards + colunas)
    document.querySelectorAll('li[data-card-id]').forEach((card) => (card.style.display = ""));
    document.querySelectorAll(".column-item[data-column-id]").forEach((col) => (col.style.display = ""));
  }

  function applySearchResult(cardIds, columnIds) {
    const cardSet = new Set((cardIds || []).map((x) => Number(x)));
    const colSet = new Set((columnIds || []).map((x) => Number(x)));

    // cards
    document.querySelectorAll('li[data-card-id]').forEach((card) => {
      const id = Number(card.dataset.cardId);
      card.style.display = cardSet.has(id) ? "" : "none";
    });

    // colunas
    document.querySelectorAll(".column-item[data-column-id]").forEach((col) => {
      const id = Number(col.getAttribute("data-column-id"));
      col.style.display = colSet.has(id) ? "" : "none";
    });
  }

  const runBackendSearch = debounce(async function (raw) {
    const q = (raw || "").trim();
    if (!q) {
      resetSearchUI();
      return;
    }

    try {
      const resp = await fetch(`/board/{{ board.id }}/search/?q=${encodeURIComponent(q)}`, {
        method: "GET",
        credentials: "same-origin",
        headers: { "Accept": "application/json" }
      });

      if (!resp.ok) {
        resetSearchUI();
        return;
      }

      const data = await resp.json();
      applySearchResult(data.card_ids || [], data.column_ids || []);
    } catch (e) {
      resetSearchUI();
    }
  }, 250);

  function setFilterMode(mode) {
    window.__boardFilterMode = (mode === "text") ? "text" : "tags";

    const btnTags = document.getElementById("filter-mode-tags");
    const btnText = document.getElementById("filter-mode-text");
    const input = document.getElementById("board-filter");

    // UI states
    if (btnTags && btnText) {
      btnTags.classList.toggle("bg-gray-900", window.__boardFilterMode === "tags");
      btnTags.classList.toggle("text-white", window.__boardFilterMode === "tags");
      btnTags.classList.toggle("text-gray-700", window.__boardFilterMode !== "tags");

      btnText.classList.toggle("bg-gray-900", window.__boardFilterMode === "text");
      btnText.classList.toggle("text-white", window.__boardFilterMode === "text");
      btnText.classList.toggle("text-gray-700", window.__boardFilterMode !== "text");
    }

    // placeholder
    if (input) {
      input.placeholder = (window.__boardFilterMode === "text")
        ? "Buscar em cards…"
        : "Ex: urgente";

      // reaplica o filtro com o valor atual
      applyBoardFilter(input.value || "");
      if (!window.matchMedia || !window.matchMedia("(pointer: coarse)").matches) input.focus();
    }
  }

  function applyBoardFilter(raw) {
    const q = (raw || "").trim().toLowerCase();

    // sem query: reset total (cards + colunas)
    if (!q) {
      resetSearchUI();
      return;
    }

    // TAGS MODE (frontend)
    if (window.__boardFilterMode === "tags") {
      const cards = document.querySelectorAll('[id^="cards-col-"] li[data-card-id]');
      cards.forEach((card) => {
        const tags = Array.from(card.querySelectorAll("[data-tag]"))
          .map(t => (t.textContent || "").toLowerCase());

        const match = tags.some(t => t.includes(q));
        card.style.display = match ? "" : "none";
      });

      // oculta colunas que ficaram sem cards visíveis
      document.querySelectorAll(".column-item[data-column-id]").forEach((col) => {
        const anyVisible = col.querySelector('li[data-card-id]:not([style*="display: none"])');
        col.style.display = anyVisible ? "" : "none";
      });

      return;
    }

    // TEXT MODE (backend)
    runBackendSearch(raw);
  }

  // default
  document.addEventListener("DOMContentLoaded", () => setFilterMode("tags"));
</script>


<script>
  // ============================================================
  // SORTABLE (cards)
  // ============================================================
  function initSortable() {
    document.querySelectorAll("[id^='cards-col-']").forEach(listEl => {
      if (listEl.dataset.sortableApplied === "1") return;
      listEl.dataset.sortableApplied = "1";

      new Sortable(listEl, {
        group: "cards",
        animation: 150,
        ghostClass: "drag-ghost",

        // MOBILE UX: só inicia drag após "press and hold"
        delay: 280,
        delayOnTouchOnly: true,

        // tolerância: movimento pequeno vira scroll, não drag
        touchStartThreshold: 10,

        // evita disparar drag ao tocar em botões/inputs dentro do card
        filter: "button, a, input, textarea, select, label",
        preventOnFilter: false,

        onEnd: (evt) => {
          const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]")?.value || "";

          fetch("{% url 'boards:move_card' %}", {
            method: "POST",
            credentials: "same-origin",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({
              card_id: Number(evt.item.dataset.cardId),
              new_column_id: Number(evt.to.id.replace("cards-col-", "")),
              new_position: Number(evt.newIndex)
            })
          });
        }
      });
    });
  }

  document.addEventListener("DOMContentLoaded", initSortable);
  document.body.addEventListener("htmx:afterSwap", initSortable);
</script>


<script>
  // ============================================================
  // SORTABLE (columns)
  // ============================================================
  function initSortableColumns() {
    const columnsList = document.getElementById("columns-list");
    if (!columnsList) return;

    if (columnsList.dataset.sortableColumnsApplied === "1") return;
    columnsList.dataset.sortableColumnsApplied = "1";

    new Sortable(columnsList, {
      animation: 150,
      ghostClass: "drag-ghost",

      // arrasta SOMENTE pelo header
      handle: ".column-header",

      // garante que só os wrappers de coluna são “draggables”
      draggable: ".column-item",

      // evita treta ao clicar em botões/inputs
      filter: "button, a, input, textarea, select, [contenteditable='true']",
      preventOnFilter: false,

      onEnd: () => {
        const order = Array.from(columnsList.querySelectorAll(".column-item"))
          .map(el => el.getAttribute("data-column-id"))
          .filter(Boolean)
          .map(Number);

        fetch("{% url 'boards:reorder_columns' board.id %}", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")?.value || ""
          },
          body: JSON.stringify({ order })
        });
      }
    });
  }

  document.addEventListener("DOMContentLoaded", initSortableColumns);
  document.body.addEventListener("htmx:afterSwap", initSortableColumns);
</script>


<script>
  // ============================================================
  // BOARD TITLE
  // ============================================================
  function updateBoardTitle(boardId) {
    const titleEl = document.getElementById("board-title");
    const newTitle = (titleEl?.innerText || "").trim();

    const formData = new FormData();
    formData.append("name", newTitle);

    fetch(`/board/${boardId}/rename/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")?.value || ""
      },
      body: formData
    });
  }
</script>


<script>
  // ============================================================
  // DELETE CARDS MODE
  // ============================================================
  let deleteCardsMode = false;
  const toggleDeleteCardsBtn = document.getElementById("toggle-delete-cards");

  toggleDeleteCardsBtn?.addEventListener("click", () => {
    deleteCardsMode = !deleteCardsMode;

    document.querySelectorAll(".delete-card-btn").forEach(btn => {
      btn.classList.toggle("hidden", !deleteCardsMode);
    });

    toggleDeleteCardsBtn.innerText = deleteCardsMode
      ? "Sair do modo de exclusão"
      : "Excluir cards";
  });

  document.body.addEventListener("htmx:afterRequest", function () {
    if (deleteCardsMode) {
      deleteCardsMode = false;

      document.querySelectorAll(".delete-card-btn").forEach(btn => {
        btn.classList.add("hidden");
      });

      toggleDeleteCardsBtn.innerText = "Excluir cards";
    }
  });
</script>


<script>
  // ============================================================
  // DELETE COLUMNS MODE
  // ============================================================
  let deleteColumnsMode = false;
  const toggleDeleteColumnsBtn = document.getElementById("toggle-delete-columns");

  toggleDeleteColumnsBtn?.addEventListener("click", () => {
    deleteColumnsMode = !deleteColumnsMode;

    document.querySelectorAll(".delete-column-btn").forEach(btn => {
      btn.classList.toggle("hidden", !deleteColumnsMode);
    });

    toggleDeleteColumnsBtn.innerText = deleteColumnsMode
      ? "Sair do modo de exclusão"
      : "Excluir colunas";
  });

  document.body.addEventListener("htmx:afterRequest", function () {
    if (deleteColumnsMode) {
      deleteColumnsMode = false;

      document.querySelectorAll(".delete-column-btn").forEach(btn => {
        btn.classList.add("hidden");
      });

      toggleDeleteColumnsBtn.innerText = "Excluir colunas";
    }
  });
</script>


<script>
  // ============================================================
  // TAG COLORS (saved)
  // ============================================================
  window.applySavedTagColorsToBoard = function (scope) {
    const root = scope || document;

    root.querySelectorAll('li[data-card-id][data-tag-colors]').forEach((cardEl) => {
      let colors = {};
      try {
        colors = JSON.parse(cardEl.getAttribute("data-tag-colors") || "{}");
        if (!colors || typeof colors !== "object") colors = {};
      } catch (e) {
        colors = {};
      }

      cardEl.querySelectorAll("[data-tag]").forEach((tagEl) => {
        const tag = tagEl.getAttribute("data-tag");
        const c = colors[tag];
        if (!c) return;

        tagEl.style.backgroundColor = c + "20";
        tagEl.style.color = c;
        tagEl.style.borderColor = c;
      });
    });
  };

  document.addEventListener("DOMContentLoaded", () => {
    window.applySavedTagColorsToBoard(document);
  });

  document.body.addEventListener("htmx:afterSwap", (evt) => {
    window.applySavedTagColorsToBoard(evt.target);
  });
</script>



<script>
  // ============================================================
  // ADD COLUMN (client-side validation)
  // ============================================================
  function showAddColumnError(msg) {
    const el = document.getElementById("add-column-error");
    if (!el) return;
    el.textContent = msg || "Digite o nome da coluna antes.";
    el.classList.remove("hidden");
  }

  function hideAddColumnError() {
    const el = document.getElementById("add-column-error");
    if (!el) return;
    el.classList.add("hidden");
  }

  function validateAddColumnForm(form, ev) {
    const input = form.querySelector('input[name="name"]');
    const value = (input?.value || "").trim();

    if (!value) {
      ev.preventDefault();
      ev.stopPropagation();
      showAddColumnError("Digite o nome da coluna antes.");
      input?.focus();
      return false;
    }

    hideAddColumnError();
    return true;
  }

  // limpa o erro ao digitar
  document.addEventListener("input", (e) => {
    if (e.target && e.target.id === "add-column-name") hideAddColumnError();
  });
</script>



{% endblock %}