{# templates/boards/board_detail.html #}
{% extends "base.html" %}
{% load static %}
{% load tag_helpers %}

{% block title %}{{ board.name }}{% endblock %}
{% block header_left %}
  {{ block.super }}
{% endblock %}

{% block body_class %}is-board has-header-search{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% url 'boards:board_wallpaper_css' board.id %}">
<link rel="stylesheet" href="{% static 'boards/board_detail.css' %}">
<link rel="stylesheet" href="{% static 'boards/calendar.css' %}">
{% endblock %}



{% block body_attrs %}style="overflow:hidden;"{% endblock %}






{% block header_right_under_logo %}
  <div id="cm-search-desktop-home" class="w-full hidden md:flex justify-center">
    <div class="w-full max-w-[980px]">
      <div id="cm-search-panel"
           class="cm-search-panel w-full rounded-xl bg-emerald-200/70 backdrop-blur-md border border-white/30 shadow px-3 py-2">
        <div class="flex items-center gap-3">

          <!-- THUMB (larga, sem aumentar altura) -->
          <div class="shrink-0 hidden md:block">
            {% if board and board.image %}
              <div class="relative group">
                <div class="h-10 w-24 border border-gray-300 rounded-lg overflow-hidden bg-white">
                  <img src="{{ board.image.url }}" class="h-full w-full object-cover">
                </div>

                <button class="absolute -top-2 -right-2 h-6 w-6 rounded-full
                               bg-black/60 text-white text-xs flex items-center justify-center
                               opacity-0 group-hover:opacity-100 transition-opacity"
                        hx-post="{% url 'boards:remove_board_image' board.id %}"
                        hx-target="body" hx-swap="beforeend"
                        aria-label="Remover imagem do quadro"
                        title="Remover imagem">
                  ‚úñ
                </button>
              </div>
            {% else %}
              <div class="h-10 w-24 flex items-center justify-center rounded-lg border border-gray-300
                          bg-gray-100 text-gray-500 text-xl cursor-pointer hover:bg-gray-200"
                   {% if board %}hx-get="{% url 'boards:update_board_image' board.id %}"{% endif %}
                   hx-target="body" hx-swap="beforeend"
                   aria-label="Adicionar imagem do quadro"
                   title="Adicionar imagem">
                +
              </div>
            {% endif %}
          </div>

          <!-- INPUT (1 linha, sem ‚ÄúFiltrar por:‚Äù consumindo altura) -->
          <div class="flex-1 min-w-0">
            <input type="text"
                   id="board-filter"
                   placeholder="Filtrar‚Ä¶ (ex: urgente)"
                   class="w-full h-10 rounded-lg px-3 text-sm bg-white/80 border border-gray-300"
                   oninput="applyBoardFilter(this.value)"
                   onclick="event.stopPropagation();"
                   onpointerdown="event.stopPropagation();">
          </div>

          <!-- TOGGLE (compacto) -->
          <div class="shrink-0 inline-flex rounded-lg border border-gray-300 bg-white/80 overflow-hidden h-10">
            <button type="button"
                    id="filter-mode-tags"
                    class="px-3 text-xs font-semibold bg-gray-900 text-white"
                    onclick="setFilterMode('tags')">
              Tags
            </button>
            <button type="button"
                    id="filter-mode-text"
                    class="px-3 text-xs font-semibold text-gray-700"
                    onclick="setFilterMode('text')">
              Texto
            </button>
          </div>

        </div>
      </div>
    </div>
  </div>
{% endblock %}








{% block drawer_items %}
<li>
  <a class="nt-link flex items-center gap-2" href="{% url 'boards:boards_index' %}">
    <!-- arrow-left -->
    <svg class="h-5 w-5 opacity-90" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M10 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M3 12h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span>Voltar aos Quadros</span>
  </a>
</li>

{% if can_share_board %}
<li>
  <button class="nt-link flex items-center gap-2" type="button"
          hx-get="{% url 'boards:board_share' board.id %}"
          hx-target="body" hx-swap="beforeend">
    <!-- share -->
    <svg class="h-5 w-5 opacity-90" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M16 8a3 3 0 10-2.8-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M6 14a3 3 0 100 6 3 3 0 000-6z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M18 13a3 3 0 100 6 3 3 0 000-6z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M8.6 15.2l6.8-3.4M15.4 8.2L8.6 11.6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <span>Compartilhar quadro</span>
  </button>
</li>

<li>
  <button class="nt-link flex items-center gap-2" type="button"
          hx-get="{% url 'boards:transfer_owner_start' board.id %}"
          hx-target="#modal-body" hx-swap="innerHTML"
          hx-on="htmx:beforeRequest: try{ if(window.Modal&&Modal.open){Modal.open();} }catch(e){}">
    <!-- user-switch / transfer -->
    <svg class="h-5 w-5 opacity-90" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0z" stroke="currentColor" stroke-width="2"/>
      <path d="M4 21a8 8 0 0116 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M20 10h-5m5 0l-2-2m2 2l-2 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <span>Transferir titularidade</span>
  </button>
</li>

{% elif can_leave_board %}
<li>
  <form method="post" action="{% url 'boards:board_leave' board.id %}">
    {% csrf_token %}
    <button type="submit" class="nt-link flex items-center gap-2"
            onclick="return confirm('Sair deste quadro? Ele vai sumir da sua lista.')">
      <!-- log-out -->
      <svg class="h-5 w-5 opacity-90" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M10 17l-1 0a4 4 0 01-4-4V7a4 4 0 014-4h1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M16 12H7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M13 9l3 3-3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span>Sair do quadro</span>
    </button>
  </form>
</li>
{% endif %}

<li>
  <button class="nt-link flex items-center gap-2" type="button"
          hx-get="{% url 'boards:update_board_wallpaper' board.id %}"
          hx-target="body" hx-swap="beforeend">
    <!-- image -->
    <svg class="h-5 w-5 opacity-90" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M4 7a3 3 0 013-3h10a3 3 0 013 3v10a3 3 0 01-3 3H7a3 3 0 01-3-3V7z" stroke="currentColor" stroke-width="2"/>
      <path d="M8 11a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" fill="currentColor"/>
      <path d="M20 16l-5-5-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <span>Trocar Wallpaper</span>
  </button>
</li>

<li>
  <button class="nt-link flex items-center gap-2" type="button"
          hx-post="{% url 'boards:remove_board_wallpaper' board.id %}"
          hx-target="body" hx-swap="beforeend">
    <!-- image-off -->
    <svg class="h-5 w-5 opacity-90" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M4 7a3 3 0 013-3h10a3 3 0 013 3v10a3 3 0 01-3 3H7a3 3 0 01-3-3V7z" stroke="currentColor" stroke-width="2"/>
      <path d="M4 4l16 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M14.5 12.5L20 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M9 15l3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span>Remover Wallpaper</span>
  </button>
</li>

<li>
  <button id="toggle-delete-columns" type="button" class="nt-link flex items-center gap-2">
    <!-- columns -->
    <svg class="h-5 w-5 opacity-90" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M4 6a2 2 0 012-2h3a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" stroke="currentColor" stroke-width="2"/>
      <path d="M13 6a2 2 0 012-2h3a2 2 0 012 2v12a2 2 0 01-2 2h-3a2 2 0 01-2-2V6z" stroke="currentColor" stroke-width="2"/>
    </svg>
    <span>Excluir colunas</span>
  </button>
</li>

<li>
  <button id="toggle-delete-cards" type="button" class="nt-link flex items-center gap-2">
    <!-- cards -->
    <svg class="h-5 w-5 opacity-90" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M7 7h10M7 11h10M7 15h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M6 4h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2z" stroke="currentColor" stroke-width="2"/>
    </svg>
    <span>Excluir cards</span>
  </button>
</li>

<li>
  {% include "boards/partials/aggregator_toggle_button.html" %}
</li>

<li>
  <button class="nt-link relative flex items-center gap-2" type="button"
          hx-get="{% url 'boards:board_history_modal' board.id %}"
          hx-target="#modal-body" hx-swap="innerHTML"
          hx-on="htmx:beforeRequest: try{ if(window.Modal&&Modal.open){Modal.open();} }catch(e){}">
    <!-- history -->
    <svg class="h-5 w-5 opacity-90" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M3 12a9 9 0 101.8-5.4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M3 4v5h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M12 7v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>

    <span>Hist√≥rico do quadro</span>

    {% if request.user.is_authenticated and request.user.profile.activity_counts %}
      <span id="board-history-badge"
            class="ml-2 inline-flex items-center justify-center text-xs font-semibold
                   rounded-full px-2 py-0.5 bg-red-600 text-white hidden">0</span>
    {% endif %}
  </button>
</li>

<li>
  <a class="nt-link flex items-center gap-2" href="{% url 'boards:archived' board.id %}">
    <!-- archive -->
    <svg class="h-5 w-5 opacity-90" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M4 7a2 2 0 012-2h12a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V7z" stroke="currentColor" stroke-width="2"/>
      <path d="M6 11v9a2 2 0 002 2h8a2 2 0 002-2v-9" stroke="currentColor" stroke-width="2"/>
      <path d="M10 15h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span>Arquivados</span>
  </a>
</li>

<li>
  <a class="nt-link flex items-center gap-2" href="{% url 'boards:trash' board.id %}">
    <!-- trash -->
    <svg class="h-5 w-5 opacity-90" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M9 3h6m-8 4h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M8 7l1 14h6l1-14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M10 11v7M14 11v7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span>Lixeira</span>
  </a>
</li>

<li>
  <button class="nt-link flex items-center gap-2" data-action="toggle-calendar">
    <!-- calendar -->
    <svg class="h-5 w-5 opacity-90" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M7 3v3M17 3v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M4 8h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M6 5h12a2 2 0 012 2v13a2 2 0 01-2 2H6a2 2 0 01-2-2V7a2 2 0 012-2z" stroke="currentColor" stroke-width="2"/>
      <path d="M8 12h4M8 16h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span>Modo calend√°rio</span>
  </button>
</li>


{% endblock %}










  <!-- IMAGEM DO QUADRO NO CENTRO D HEADER -->
{% block header_center %}
  {% if board and board.image %}
    <div class="cm-cover cm-cover--header"
         style="--cm-cover-url: url('{{ board.image.url }}');">
      <img
        src="{{ board.image.url }}"
        alt="{{ board.name }}"
        class="cm-cover__img"
        loading="lazy"
      >
    </div>
  {% else %}
    <div class="cm-cover cm-cover--header" style="--cm-cover-url: none;">
      <div style="position:relative; z-index:1; padding:0 14px; display:flex; align-items:center; height:100%; font-weight:700;">
        {{ board.name }}
      </div>
    </div>
  {% endif %}
{% endblock %}












{% block content %}
<div class="mt-2 mb-4">

<!-- DESKTOP / PAISAGEM (>= 768px) ‚Äî breadcrumb + membros na MESMA LINHA -->
<div class="hidden md:flex items-center justify-between gap-4">
  <!-- breadcrumb -->
  <div class="text-sm font-semibold text-white/90 drop-shadow truncate min-w-0">
    <a href="{% url 'boards:boards_index' %}"
       class="underline underline-offset-2">
      Todos os Quadros
    </a>
    <span class="opacity-70">‚Üí</span>
    <span class="board-breadcrumb-name">
      {{ board.name }}
    </span>
  </div>








  
  <!-- membros (direita) -->
  <div id="board-members-bar"
       class="board-members-bar flex items-center gap-1 shrink-0"
       aria-label="Usu√°rios do quadro">
    {% for member in board_members %}
  {% if member.id != request.user.id %}
    {% with p=member.profile %}
      <button
        type="button"
        class="board-member-avatar"
        title="{{ p.display_name|default:member.get_full_name|default:member.email }}"
        aria-label="Ver perfil de {{ p.display_name|default:member.get_full_name|default:member.email }}"
        data-user-id="{{ member.id }}"
        data-display-name="{{ p.display_name|default:member.get_full_name|default:member.email }}"
        data-handle="{{ p.handle|default:'' }}"
        data-email="{{ member.email|default:'' }}"
        data-avatar-url="{% if p and p.avatar %}{{ p.avatar.url }}{% elif p and p.avatar_choice %}{% static 'images/avatar/' %}{{ p.avatar_choice }}{% endif %}"
        onclick="openReadonlyUserProfile({{ member.id }})">

        {% if p and p.avatar %}
          <img src="{{ p.avatar.url }}"
               alt="{{ p.display_name|default:member.get_full_name|default:member.email }}"
               loading="lazy">
        {% elif p and p.avatar_choice %}
          <img src="{% static 'images/avatar/' %}{{ p.avatar_choice }}"
               alt="{{ p.display_name|default:member.get_full_name|default:member.email }}"
               loading="lazy">
        {% else %}
          <span class="avatar-fallback">
            {{ p.display_name|default:member.get_full_name|default:member.email|first|upper }}
          </span>
        {% endif %}
      </button>
    {% endwith %}
  {% endif %}
{% endfor %}

  </div>
</div>




{% if can_share_board and board.access_requests.exists %}
  <div class="cm-accessreq-wrap mt-4">
    <div class="cm-accessreq-card">
      <div class="cm-accessreq-head">
        <h4 class="cm-accessreq-title">Solicita√ß√µes de acesso</h4>
        <div class="cm-accessreq-sub">
          Pend√™ncias para este quadro (aprove ou negue).
        </div>
      </div>

      <div class="cm-accessreq-list">
        {% for req in board.access_requests.all %}
          <div class="cm-accessreq-row">
            <div class="cm-accessreq-user">
              <div class="cm-accessreq-email">{{ req.user.email }}</div>
              <div class="cm-accessreq-meta">
                solicitado em {{ req.created_at|date:"d/m/Y H:i" }}
              </div>
            </div>

            <div class="cm-accessreq-actions">
              <button
                class="cm-btn cm-btn-ok"
                hx-post="{% url 'boards:board_approve_access' board.id req.user.id %}"
                hx-target="closest .cm-accessreq-row"
                hx-swap="outerHTML"
                hx-headers='{"X-CSRFToken":"{{ csrf_token }}"}'>
                Aprovar
              </button>

              <button
                class="cm-btn cm-btn-no"
                hx-post="{% url 'boards:board_deny_access' board.id req.user.id %}"
                hx-target="closest .cm-accessreq-row"
                hx-swap="outerHTML"
                hx-headers='{"X-CSRFToken":"{{ csrf_token }}"}'>
                Negar
              </button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endif %}











  <!-- MOBILE RETRATO (< 768px) ‚Äî SLOT DIN√ÇMICO -->
<div class="md:hidden">
  <div class="flex items-center justify-between gap-3">

    <!-- breadcrumb -->
    <div id="cm-mobile-breadcrumb"
         class="text-sm font-semibold text-white/90 drop-shadow truncate min-w-0">
      <a href="{% url 'boards:boards_index' %}" class="underline underline-offset-2">Todos os Quadros</a>
      <span class="opacity-70">‚Üí</span>
      <span class="board-breadcrumb-name">{{ board.name }}</span>
    </div>

    <!-- avatares + lupa (direita) -->
    <div class="flex items-center gap-2 shrink-0">
      <div id="board-members-bar-mobile"
           class="board-members-bar flex items-center gap-1 shrink-0"
           aria-label="Usu√°rios do quadro">
        {% for member in board_members %}
          {% with p=member.profile %}
            <button type="button"
                    class="board-member-avatar"
                    onclick="openReadonlyUserProfile({{ member.id }})"
                    aria-label="Ver perfil">
              {% if p and p.avatar %}
                <img src="{{ p.avatar.url }}" alt="" loading="lazy">
              {% elif p and p.avatar_choice %}
                <img src="{% static 'images/avatar/' %}{{ p.avatar_choice }}" alt="" loading="lazy">
              {% else %}
                <span class="avatar-fallback">
                  {{ p.display_name|default:member.get_full_name|default:member.email|first|upper }}
                </span>
              {% endif %}
            </button>
          {% endwith %}
        {% endfor %}
      </div>

      <button id="cm-search-icon" aria-label="Buscar" class="cm-search-icon" onclick="event.stopPropagation();">üîç</button>
    </div>

  </div>

  <!-- slot da busca aberta continua igual -->
  <div
  id="cm-mobile-search-wrapper"
  class="cm-mobile-search-wrapper hidden"
  onclick="event.stopPropagation();"
>
</div>

</div>



      <!-- ‚¨áÔ∏è A BARRA ORIGINAL, SEM ALTERAR UMA LINHA ‚¨áÔ∏è -->
      
      
    </div>

  </div>
</div>



{# ======================== LISTA DE COLUNAS ======================== #}
<div id="cm-board-root" data-card-id="" data-tag-colors="{}">

  <div id="board-root" data-can-edit="{{ can_edit|yesno:'1,0' }}">

    <div id="calendar-root" class="hidden"></div>

      <div
      id="columns-wrapper"
      class="columns-wrapper"
      style="--col-base:
        {% if request.user.is_authenticated %}
          {{ request.user.profile.board_col_width|default:240 }}px
        {% else %}
          240px
        {% endif %}
      ;"
    >



      {# üîë √öNICO columns-list do sistema #}
      {% include "boards/partials/columns_list.html" %}

      {# ‚ûï adicionar coluna #}
      <div id="add-column-box"
           class="w-64 bg-white/60 backdrop-blur-md border border-gray-300 rounded-xl p-4 h-fit shrink-0 shadow-md">

        <h3 class="font-semibold mb-2">Adicionar nova coluna</h3>

        <form method="post"
              id="add-column-form"
              hx-post="{% url 'boards:add_column' board.id %}"
              hx-target="#columns-list"
              hx-swap="beforeend"
              hx-on="
                submit: if(!validateAddColumnForm(this,event)) return false;
                htmx:afterRequest: if (event.detail.successful) {
                  this.reset();
                  hideAddColumnError();
                }
              ">
          {% csrf_token %}

          <label class="block text-sm font-medium mb-1">Nome:</label>

          <input type="text"
                 name="name"
                 id="add-column-name"
                 class="w-full border rounded px-3 py-2 mb-2"
                 placeholder="Nome da coluna">

          <div id="add-column-error"
               class="hidden text-sm text-red-700 bg-red-50 border border-red-200 rounded px-3 py-2 mb-3">
            Digite o nome da coluna antes.
          </div>

          <button class="px-3 py-2 bg-blue-600 text-white rounded w-full hover:bg-blue-700 transition">
            Adicionar Coluna
          </button>
        </form>
      </div>

    </div>
  </div>
</div>




{% if request.user.is_authenticated and not my_membership %}
  <div class="mt-6 p-4 rounded-xl bg-yellow-50 border border-yellow-300">
    <p class="text-sm font-semibold mb-3">
      Voc√™ n√£o tem acesso a este quadro.
    </p>

    <button
      class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
      hx-post="{% url 'boards:board_request_access' board.id %}"
      hx-swap="none"
      hx-headers='{"X-CSRFToken":"{{ csrf_token }}"}'
      hx-on="htmx:afterRequest: this.innerText='Pedido enviado'; this.disabled=true;"
    >
      Solicitar acesso
    </button>
  </div>
{% endif %}










{# ======================== BOOT GLOBAL ======================== #}
<script>
  window.BOARD_ID = {{ board.id }};
  window.BOARD_VERSION = {{ board.version }};
  window.CURRENT_USER_ID = {{ request.user.id }};
  window.__isDraggingCard = false;
</script>

{# templates/boards/board_detail.html #}

{{ board.due_colors|default:"{}"|json_script:"board-due-colors" }}
<script>
  window.BOARD_TERM_COLORS = JSON.parse(
    document.getElementById("board-due-colors")?.textContent || "{}"
  );
</script>




<script defer src="{% static 'boards/calendar.js' %}"></script>






<script>
  // ============================================================
  // FILTER (Tags = frontend | Texto = backend)
  // - Tags: filtra no DOM (tags + TERM: Vencido/A vencer/Em dia)
  // - Texto: busca no backend (/search/)
  // - Contador: sempre recalcula ap√≥s qualquer altera√ß√£o de visibilidade
  // ============================================================

  window.__boardFilterMode = "tags"; // "tags" | "text"

  function debounce(fn, wait) {
    let t = null;
    function debounced(...args) {
      if (t) clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    }
    debounced.cancel = function () {
      if (t) clearTimeout(t);
      t = null;
    };
    return debounced;
  }

  function getFilterInputValue() {
    return (document.getElementById("board-filter")?.value || "").trim();
  }

  // Recalcula contadores considerando o filtro atual
  // Recalcula contadores considerando o filtro atual

  function refreshCounters() {
    document.querySelectorAll(".column-item[data-column-id]").forEach((col) => {
      const counter = col.querySelector("[data-column-counter]");
      if (!counter) return;

      const n = col.querySelectorAll(
        'li[data-card-id]:not([style*="display: none"]):not([hidden]):not(.hidden)'
      ).length;

      counter.textContent = `${n} card${n !== 1 ? "s" : ""}`;
    });
  }



  function resetSearchUI() {
    // volta tudo (cards + colunas)
    document.querySelectorAll('li[data-card-id]').forEach((card) => (card.style.display = ""));
    document.querySelectorAll(".column-item[data-column-id]").forEach((col) => (col.style.display = ""));

    refreshCounters();
  }

  function applySearchResult(cardIds, columnIds) {
    const cardSet = new Set((cardIds || []).map((x) => Number(x)));
    const colSet  = new Set((columnIds || []).map((x) => Number(x)));

    // cards
    document.querySelectorAll('li[data-card-id]').forEach((card) => {
      const id = Number(card.dataset.cardId);
      card.style.display = cardSet.has(id) ? "" : "none";
    });

    // colunas
    document.querySelectorAll(".column-item[data-column-id]").forEach((col) => {
      const id = Number(col.getAttribute("data-column-id"));
      col.style.display = colSet.has(id) ? "" : "none";
    });

    refreshCounters();
  }

  // -------- TAGS MODE: tags + TERM (Vencido/A vencer/Em dia) --------
  function normalize(s) {
    return (s || "").toString().trim().toLowerCase();
  }

  function getCardTagsText(cardEl) {
    const byDataTag = Array.from(cardEl.querySelectorAll("[data-tag]"))
      .map(el => normalize(el.textContent));

    const byClassTag = Array.from(cardEl.querySelectorAll(".tag, .cm-tag, .badge-tag, [data-tag-name]"))
      .map(el => normalize(el.textContent));

    return [...byDataTag, ...byClassTag].filter(Boolean);
  }

  function getCardTermText(cardEl) {
    const badgeText =
      normalize(cardEl.querySelector(".term-badge")?.textContent) ||
      normalize(cardEl.querySelector("[data-term-status]")?.textContent);

    const st = normalize(cardEl.getAttribute("data-term-status"));
    const due  = normalize(cardEl.getAttribute("data-term-due"));
    const warn = normalize(cardEl.getAttribute("data-term-warn"));

    return [badgeText, st, due, warn].filter(Boolean);
  }

  function applyTagsFilter(raw) {
    const q = normalize(raw);
    if (!q) {
      resetSearchUI();
      return;
    }

    const cards = document.querySelectorAll('[id^="cards-col-"] li[data-card-id]');

    cards.forEach((card) => {
      const tags = getCardTagsText(card);
      const terms = getCardTermText(card);

      const hay = [...tags, ...terms];
      const match = hay.some(t => t.includes(q));

      card.style.display = match ? "" : "none";
    });

    // colunas: mostra s√≥ se tiver algum card vis√≠vel
    document.querySelectorAll(".column-item[data-column-id]").forEach((col) => {
      const anyVisible = col.querySelector('li[data-card-id]:not([style*="display: none"])');
      col.style.display = anyVisible ? "" : "none";
    });

    refreshCounters();
  }

  // -------- BACKEND MODE (texto) com anti-resposta velha --------
  let __searchSeq = 0;

  const runBackendSearch = debounce(async function (raw) {
    const modeAtStart = window.__boardFilterMode;
    const mySeq = ++__searchSeq;

    const q = (raw || "").trim();
    if (!q) {
      resetSearchUI();
      return;
    }

    try {
      const resp = await fetch(`/board/{{ board.id }}/search/?q=${encodeURIComponent(q)}`, {
        method: "GET",
        credentials: "same-origin",
        headers: { "Accept": "application/json" }
      });

      if (mySeq !== __searchSeq) return;
      if (window.__boardFilterMode !== modeAtStart) return;
      if (getFilterInputValue() !== q) return;

      if (!resp.ok) {
        resetSearchUI();
        return;
      }

      const data = await resp.json();

      if (mySeq !== __searchSeq) return;
      if (window.__boardFilterMode !== modeAtStart) return;
      if (getFilterInputValue() !== q) return;

      applySearchResult(data.card_ids || [], data.column_ids || []);
    } catch (_e) {
      if (mySeq !== __searchSeq) return;
      resetSearchUI();
    }
  }, 250);

  function setFilterMode(mode) {
    window.__boardFilterMode = (mode === "text") ? "text" : "tags";

    runBackendSearch.cancel?.();
    __searchSeq++;

    const btnTags = document.getElementById("filter-mode-tags");
    const btnText = document.getElementById("filter-mode-text");
    const input = document.getElementById("board-filter");

    if (btnTags && btnText) {
      btnTags.classList.toggle("bg-gray-900", window.__boardFilterMode === "tags");
      btnTags.classList.toggle("text-white", window.__boardFilterMode === "tags");
      btnTags.classList.toggle("text-gray-700", window.__boardFilterMode !== "tags");

      btnText.classList.toggle("bg-gray-900", window.__boardFilterMode === "text");
      btnText.classList.toggle("text-white", window.__boardFilterMode === "text");
      btnText.classList.toggle("text-gray-700", window.__boardFilterMode !== "text");
    }

    if (input) {
      input.placeholder = (window.__boardFilterMode === "text")
        ? "Buscar em cards‚Ä¶"
        : "Ex: urgente / vencido / em dia";

      applyBoardFilter(input.value || "");
      if (!window.matchMedia || !window.matchMedia("(pointer: coarse)").matches) input.focus();
    }
  }

  function applyBoardFilter(raw) {
    const q = (raw || "").trim();

    if (!q) {
      runBackendSearch.cancel?.();
      __searchSeq++;
      resetSearchUI();
      return;
    }

    if (window.__boardFilterMode === "tags") {
      runBackendSearch.cancel?.();
      __searchSeq++;
      applyTagsFilter(q);
      return;
    }

    runBackendSearch(q);
  }

  document.addEventListener("DOMContentLoaded", () => {
    setFilterMode("tags");

    // Se o BoardUI carregar depois, garante 1 recalculo com base no estado atual
    setTimeout(() => {
      refreshCounters();
      const input = document.getElementById("board-filter");
      if (input && (input.value || "").trim()) applyBoardFilter(input.value);
    }, 0);
  });
</script>















<script>
  // ============================================================
  // SORTABLE (columns)
  // ============================================================
  window.initSortableColumns = function initSortableColumns() {
    const columnsList = document.getElementById("columns-list");
    if (!columnsList) return;

    if (columnsList.dataset.sortableColumnsApplied === "1") return;
    columnsList.dataset.sortableColumnsApplied = "1";

    new Sortable(columnsList, {
      animation: 150,
      ghostClass: "drag-ghost",

      handle: ".column-header",
      draggable: ".column-item",

      filter: "button, a, input, textarea, select, [contenteditable='true']",
      preventOnFilter: false,

      onEnd: () => {
        const order = Array.from(columnsList.querySelectorAll(".column-item"))
          .map(el => el.getAttribute("data-column-id"))
          .filter(Boolean)
          .map(Number);

        fetch("{% url 'boards:reorder_columns' board.id %}", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")?.value || ""
          },
          body: JSON.stringify({ order })
        });
      }
    });
  }

  document.addEventListener("DOMContentLoaded", window.initSortableColumns);
  document.body.addEventListener("htmx:afterSwap", window.initSortableColumns);
</script>

<script>
  // ============================================================
  // BOARD TITLE
  // ============================================================
  function updateBoardTitle(boardId) {
    const titleEl = document.getElementById("board-title");
    const newTitle = (titleEl?.innerText || "").trim();

    const formData = new FormData();
    formData.append("name", newTitle);

    fetch(`/board/${boardId}/rename/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")?.value || ""
      },
      body: formData
    });
  }
</script>

<script>
  // ============================================================
  // DELETE CARDS MODE
  // ============================================================
  let deleteCardsMode = false;
  const toggleDeleteCardsBtn = document.getElementById("toggle-delete-cards");

  toggleDeleteCardsBtn?.addEventListener("click", () => {
    deleteCardsMode = !deleteCardsMode;

    document.querySelectorAll(".delete-card-btn").forEach(btn => {
      btn.classList.toggle("hidden", !deleteCardsMode);
    });

    toggleDeleteCardsBtn.innerText = deleteCardsMode
      ? "Sair do modo de exclus√£o"
      : "Excluir cards";
  });

  document.body.addEventListener("htmx:afterRequest", function () {
    if (deleteCardsMode) {
      deleteCardsMode = false;

      document.querySelectorAll(".delete-card-btn").forEach(btn => {
        btn.classList.add("hidden");
      });

      toggleDeleteCardsBtn.innerText = "Excluir cards";
    }
  });
</script>

<script>
  // ============================================================
  // DELETE COLUMNS MODE
  // ============================================================
  let deleteColumnsMode = false;
  const toggleDeleteColumnsBtn = document.getElementById("toggle-delete-columns");

  toggleDeleteColumnsBtn?.addEventListener("click", () => {
    deleteColumnsMode = !deleteColumnsMode;

    document.querySelectorAll(".delete-column-btn").forEach(btn => {
      btn.classList.toggle("hidden", !deleteColumnsMode);
    });

    toggleDeleteColumnsBtn.innerText = deleteColumnsMode
      ? "Sair do modo de exclus√£o"
      : "Excluir colunas";
  });

  document.body.addEventListener("htmx:afterRequest", function () {
    if (deleteColumnsMode) {
      deleteColumnsMode = false;

      document.querySelectorAll(".delete-column-btn").forEach(btn => {
        btn.classList.add("hidden");
      });

      toggleDeleteColumnsBtn.innerText = "Excluir colunas";
    }
  });
</script>

<script>
  // ============================================================
  // TAG COLORS (saved)
  // ============================================================
  window.applySavedTagColorsToBoard = function (scope) {
    const root = scope || document;

    root.querySelectorAll('li[data-card-id][data-tag-colors]').forEach((cardEl) => {
      let colors = {};
      try {
        colors = JSON.parse(cardEl.getAttribute("data-tag-colors") || "{}");
        if (!colors || typeof colors !== "object") colors = {};
      } catch (_e) {
        colors = {};
      }

      cardEl.querySelectorAll("[data-tag]").forEach((tagEl) => {
        const tag = tagEl.getAttribute("data-tag");
        const c = colors[tag];
        if (!c) return;

        tagEl.style.backgroundColor = c + "20";
        tagEl.style.color = c;
        tagEl.style.borderColor = c;
      });
    });
  };

  document.addEventListener("DOMContentLoaded", () => {
    window.applySavedTagColorsToBoard(document);
  });

  document.body.addEventListener("htmx:afterSwap", (evt) => {
    window.applySavedTagColorsToBoard(evt.detail?.target || evt.target || document);
  });

</script>

<script>
  // ============================================================
  // ADD COLUMN (client-side validation)
  // ============================================================
  function showAddColumnError(msg) {
    const el = document.getElementById("add-column-error");
    if (!el) return;
    el.textContent = msg || "Digite o nome da coluna antes.";
    el.classList.remove("hidden");
  }

  function hideAddColumnError() {
    const el = document.getElementById("add-column-error");
    if (!el) return;
    el.classList.add("hidden");
  }

  function validateAddColumnForm(form, ev) {
    const input = form.querySelector('input[name="name"]');
    const value = (input?.value || "").trim();

    if (!value) {
      ev.preventDefault();
      ev.stopPropagation();
      showAddColumnError("Digite o nome da coluna antes.");
      input?.focus();
      return false;
    }

    hideAddColumnError();
    return true;
  }

  document.addEventListener("input", (e) => {
    if (e.target && e.target.id === "add-column-name") hideAddColumnError();
  });
</script>









<script>
  // ============================================================
  // SORTABLE (cards) ‚Äî drag & drop de cards entre colunas
  // (Mobile-friendly: long-press no touch pra evitar arrastar sem querer)
  // ============================================================

  window.initSortable = function initSortable() {
    // read-only guard (mant√©m alinhado com board_ui.js)
    // H√° IDs duplicados no template; pega o board-root ‚Äúcorreto‚Äù (o √∫ltimo do DOM)
    const boardRoots = document.querySelectorAll('#board-root[data-can-edit]');
    const boardRoot = boardRoots.length ? boardRoots[boardRoots.length - 1] : null;
    const canEdit = (boardRoot?.getAttribute("data-can-edit") === "1");
    if (!canEdit) return;

    // todas as listas de cards por coluna
    const lists = Array.from(document.querySelectorAll('[id^="cards-col-"]'));
    if (!lists.length) return;

    const isCoarsePointer = !!(window.matchMedia && window.matchMedia("(pointer: coarse)").matches);

    function getCsrfToken() {
      return (
        document.querySelector("[name=csrfmiddlewaretoken]")?.value ||
        document.querySelector("input[name=csrfmiddlewaretoken]")?.value ||
        ""
      );
    }

    function resolveColumnIdFromList(listEl) {
      const d1 = listEl?.getAttribute?.("data-column-id");
      if (d1) return Number(d1);

      const col = listEl?.closest?.(".column-item[data-column-id]");
      const d2 = col?.getAttribute?.("data-column-id");
      if (d2) return Number(d2);

      const m = (listEl?.id || "").match(/^cards-col-(\d+)$/);
      if (m) return Number(m[1]);

      return 0;
    }

    function resolveCardIdFromItem(itemEl) {
      const v = itemEl?.getAttribute?.("data-card-id") || itemEl?.dataset?.cardId;
      return v ? Number(v) : 0;
    }

    async function postMove({ cardId, newColumnId, newPosition }) {
      const csrf = getCsrfToken();

      const resp = await fetch("/move-card/", {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrf
        },
        body: JSON.stringify({
          card_id: cardId,
          new_column_id: newColumnId,
          new_position: newPosition
        })
      });

      if (!resp.ok) {
        const txt = await resp.text().catch(() => "");
        console.error("move-card falhou:", resp.status, txt);
      }
    }

    function afterLocalMoveUpdateUI() {
      try {
        requestAnimationFrame(() => {
          const input = document.getElementById("board-filter");
          const q = (input?.value || "").trim();
          if (typeof applyBoardFilter === "function") applyBoardFilter(q);

          // recalcula por DOM
          refreshCounters();
          window.updateAggregatorCounts?.();
        });
      } catch (e) {}
    }

    // ============================================================
    // COLUMN "BELLY" (empurra as outras colunas)
    // ============================================================
    function getColumnItemFromList(listEl) {
      return listEl?.closest?.(".column-item[data-column-id]") || null;
    }

    function triggerColumnBelly(colEl) {
      if (!colEl) return;

      colEl.classList.remove("col-belly");
      void colEl.offsetWidth; // reflow para retrigger
      colEl.classList.add("col-belly");

      window.setTimeout(() => colEl.classList.remove("col-belly"), 320);
    }

    lists.forEach((listEl) => {
      // evita re-aplicar
      if (listEl.dataset.sortableApplied === "1") return;
      listEl.dataset.sortableApplied = "1";

      // üîë Config ‚Äúanti-arraste acidental‚Äù no mobile:
      // - long-press (delay) s√≥ no touch
      // - toler√¢ncia de movimento antes de considerar ‚Äúdrag‚Äù
      // - fallback melhora consist√™ncia em alguns Androids
      const mobileDnD = isCoarsePointer
        ? {
            delay: 280,
            delayOnTouchOnly: true,
            touchStartThreshold: 10,
            fallbackOnBody: true
          }
        : {
            delay: 0,
            delayOnTouchOnly: false,
            touchStartThreshold: 0
          };

      new Sortable(listEl, {
        group: "cards",
        animation: 150,
        ghostClass: "drag-ghost",
        dragClass: "drag-dragging",

        ...mobileDnD,

        // garante que seja s√≥ card
        draggable: 'li[data-card-id]',

        // n√£o inicia drag ao interagir com inputs/links/editores
        filter: "button, a, input, textarea, select, [contenteditable='true']",
        preventOnFilter: true,

        // scroll assistido (melhora colunas longas)
        scroll: true,
        scrollSensitivity: 60,
        scrollSpeed: 16,

        onStart: () => { window.__isDraggingCard = true; },

        onEnd: (evt) => {
          window.__isDraggingCard = false;
          afterLocalMoveUpdateUI(); // ‚úÖ garante update sempre (origem/destino)
        },

        onAdd: (evt) => {
          // ‚úÖ barriga na coluna destino
          triggerColumnBelly(getColumnItemFromList(evt.to));

          const item = evt.item;
          const cardId = resolveCardIdFromItem(item);
          const newColumnId = resolveColumnIdFromList(evt.to);
          const newPosition = Number(evt.newIndex || 0);

          if (!cardId || !newColumnId) return;

          afterLocalMoveUpdateUI(); // destino
          postMove({ cardId, newColumnId, newPosition });
        },

        onUpdate: (evt) => {
          // ‚úÖ barriga na coluna (mesma coluna)
          triggerColumnBelly(getColumnItemFromList(evt.to));

          const item = evt.item;
          const cardId = resolveCardIdFromItem(item);
          const newColumnId = resolveColumnIdFromList(evt.to);
          const newPosition = Number(evt.newIndex || 0);

          if (!cardId || !newColumnId) return;

          afterLocalMoveUpdateUI(); // mesma coluna
          postMove({ cardId, newColumnId, newPosition });
        },

        onRemove: (evt) => {
          // ‚úÖ opcional: barriga na coluna origem quando o card sai
          triggerColumnBelly(getColumnItemFromList(evt.from));

          afterLocalMoveUpdateUI(); // ‚úÖ origem (quando sai para outra coluna)
        },
      });
    });
  };

  document.addEventListener("DOMContentLoaded", window.initSortable);
  document.body.addEventListener("htmx:afterSwap", window.initSortable);
</script>
















<script>
  // ============================================================
  // DRAG AUTO-SCROLL (cards) ‚Äî facilita mover em colunas longas
  // Funciona com o seu window.__isDraggingCard (setado no initSortable)
  // ============================================================

  (function () {
    if (window.__cmDragAutoScrollInstalled) return;
    window.__cmDragAutoScrollInstalled = true;

    const CFG = {
      zonePx: 56,          // ‚Äúfaixa‚Äù no topo/rodap√© que ativa o scroll
      maxStep: 22,         // passo m√°ximo por frame (px)
      minStep: 4,          // passo m√≠nimo por frame (px)
      rafThrottle: true
    };

    let active = {
      scroller: null,
      dir: 0,     // -1 cima, +1 baixo
      intensity: 0
    };

    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    function isScrollable(el) {
      if (!el || el === document.body || el === document.documentElement) return false;
      const st = window.getComputedStyle(el);
      const oy = st.overflowY;
      if (oy !== "auto" && oy !== "scroll") return false;
      return el.scrollHeight > el.clientHeight + 2;
    }

    function findScrollParent(startEl) {
      let el = startEl;
      while (el && el !== document.body && el !== document.documentElement) {
        if (isScrollable(el)) return el;
        el = el.parentElement;
      }
      // fallback: colunas wrapper (caso a lista em si n√£o role)
      const wrap = document.getElementById("columns-wrapper");
      if (isScrollable(wrap)) return wrap;
      return null;
    }

    function findListUnderPointer(x, y) {
      // pega o elemento sob o ponteiro e procura um UL de cards
      const el = document.elementFromPoint(x, y);
      if (!el) return null;

      const list =
        el.closest?.('[id^="cards-col-"]') ||
        el.querySelector?.('[id^="cards-col-"]');

      return list || null;
    }

    function updateActiveFromPointer(x, y) {
      const list = findListUnderPointer(x, y);
      if (!list) {
        active.scroller = null;
        active.dir = 0;
        active.intensity = 0;
        return;
      }

      const scroller = findScrollParent(list) || list;
      if (!scroller) {
        active.scroller = null;
        active.dir = 0;
        active.intensity = 0;
        return;
      }

      const r = scroller.getBoundingClientRect();
      const topZoneEnd = r.top + CFG.zonePx;
      const botZoneStart = r.bottom - CFG.zonePx;

      if (y < r.top || y > r.bottom || x < r.left || x > r.right) {
        active.scroller = null;
        active.dir = 0;
        active.intensity = 0;
        return;
      }

      if (y <= topZoneEnd) {
        const d = clamp((topZoneEnd - y) / CFG.zonePx, 0, 1);
        active.scroller = scroller;
        active.dir = -1;
        active.intensity = d;
        return;
      }

      if (y >= botZoneStart) {
        const d = clamp((y - botZoneStart) / CFG.zonePx, 0, 1);
        active.scroller = scroller;
        active.dir = +1;
        active.intensity = d;
        return;
      }

      active.scroller = null;
      active.dir = 0;
      active.intensity = 0;
    }

    function stepScroll() {
      if (!window.__isDraggingCard) {
        active.scroller = null;
        active.dir = 0;
        active.intensity = 0;
        return;
      }

      if (active.scroller && active.dir !== 0) {
        const d = clamp(active.intensity || 0, 0, 1);
        const step = Math.round(CFG.minStep + (CFG.maxStep - CFG.minStep) * d);
        active.scroller.scrollTop += active.dir * step;
      }
    }

    let rafId = null;
    function loop() {
      stepScroll();
      rafId = requestAnimationFrame(loop);
    }

    // liga/desliga loop baseado no estado de drag (usa seus flags)
    document.addEventListener("pointermove", (e) => {
      if (!window.__isDraggingCard) return;
      updateActiveFromPointer(e.clientX, e.clientY);
    }, { passive: true });

    document.addEventListener("dragover", (e) => {
      // fallback (alguns browsers mant√™m dragover mais est√°vel durante Sortable)
      if (!window.__isDraggingCard) return;
      updateActiveFromPointer(e.clientX, e.clientY);
    }, { passive: true });

    document.addEventListener("pointerup", () => {
      active.scroller = null;
      active.dir = 0;
      active.intensity = 0;
    }, { passive: true });

    document.addEventListener("keyup", (e) => {
      if (e.key === "Escape") {
        active.scroller = null;
        active.dir = 0;
        active.intensity = 0;
      }
    });

    // inicia loop
    rafId = requestAnimationFrame(loop);
  })();
</script>

<script>
  window.USER_ACTIVITY_COUNTS = {{ request.user.profile.activity_counts|yesno:"true,false" }};
</script>




<script>
  // ============================================================
  // BoardRuntime ‚Äî rehidrata√ß√£o determin√≠stica (load/poll/modal close)
  // ============================================================
  (function () {
    if (window.BoardRuntime) return;

    function safe(fn) { try { fn && fn(); } catch(_) {} }

    function ensureSortable() {
      safe(() => window.initSortable && window.initSortable());
      safe(() => window.initSortableColumns && window.initSortableColumns());
    }

    function ensureTagColors(scope) {
      safe(() => window.applySavedTagColorsToBoard && window.applySavedTagColorsToBoard(scope || document));
    }

    function ensureTermColors(scope) {
      safe(() => window.applySavedTermColorsToBoard && window.applySavedTermColorsToBoard(scope || document));
    }

    function ensureHtmxProcess(scopeEl) {
      const el = scopeEl || document;
      if (window.htmx && typeof window.htmx.process === "function") {
        safe(() => window.htmx.process(el));
      }
    }

    function ensureAll(scopeEl) {
      // ordem importa: primeiro processa HTMX, depois rebind Sortable, depois styles
      ensureHtmxProcess(scopeEl);
      ensureSortable();
      ensureTagColors(scopeEl || document);
      ensureTermColors(scopeEl || document);
    }

    window.BoardRuntime = { ensure: ensureAll };

    document.addEventListener("DOMContentLoaded", () => {
      window.BoardRuntime.ensure(document);
    });

    document.body.addEventListener("htmx:afterSwap", (e) => {
      const scope = e.detail?.target || e.target || document;
      window.BoardRuntime.ensure(scope);
    });

    document.body.addEventListener("htmx:afterSettle", (e) => {
      const scope = e.detail?.target || e.target || document;
      window.BoardRuntime.ensure(scope);
    });


    document.addEventListener("modal:closed", () => {
      window.BoardRuntime.ensure(document);
    });
  })();
</script>


<script>
  // ============================================================
  // TERM COLORS (board.due_colors) ‚Äî rehidrata√ß√£o do MODAL + DOM
  // ============================================================
  window.applySavedTermColorsToBoard = function(scope) {
    const root = scope || document;
    const colors = window.BOARD_TERM_COLORS || {};

    const okInput   = root.querySelector('input[name="term_color_ok"], input[name="due_color_ok"], #term_color_ok, #due_color_ok');
    const warnInput = root.querySelector('input[name="term_color_warn"], input[name="due_color_warn"], #term_color_warn, #due_color_warn');
    const overInput = root.querySelector('input[name="term_color_overdue"], input[name="due_color_overdue"], #term_color_overdue, #due_color_overdue');

    if (okInput && colors.ok) okInput.value = colors.ok;
    if (warnInput && colors.warn) warnInput.value = colors.warn;
    if (overInput && colors.overdue) overInput.value = colors.overdue;

    root.querySelectorAll("[data-term-status]").forEach((el) => {
  const st = (el.getAttribute("data-term-status") || "").trim(); // ok|warn|overdue
  const c = (window.BOARD_TERM_COLORS || {})[st];
  if (!c) return;

  const isCalDot = el.classList.contains("cm-cal-dot");
  const isCalBar = el.classList.contains("cm-cal-bar");

  if (isCalDot || isCalBar) {
    // calend√°rio: cor s√≥lida (precisa ‚Äúaparecer‚Äù no wallpaper)
    el.style.backgroundColor = c;
    el.style.borderColor = c;
    el.style.color = c;
  } else {
    // restante do board: pode continuar suave
    el.style.backgroundColor = c + "20";
    el.style.color = c;
    el.style.borderColor = c;
  }
});

  };
</script>



<script>
function openReadonlyUserProfile(userId) {
  // Se for o pr√≥prio usu√°rio: abre o modal edit√°vel padr√£o
  try {
    const me = Number(window.CURRENT_USER_ID || 0);
    if (me && Number(userId) === me) {
      document.getElementById("open-user-settings")?.click?.();
      return;
    }
  } catch (e) {}

  if (!window.htmx) return;

  const modalBody = document.getElementById("modal-body");
  if (!modalBody) return;

  if (window.Modal?.close) {
    window.Modal.close({ clearBody: true, clearUrl: false });
  }

  if (window.Modal?.open) {
    window.Modal.open();
  }

  htmx.ajax("GET", `/users/${userId}/profile/readonly/`, {
    target: modalBody,
    swap: "innerHTML"
  });
}
</script>









<!--LUPA PESQUISA!!-->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const icon = document.getElementById("cm-search-icon");
  const wrapper = document.getElementById("cm-mobile-search-wrapper");

  const panel = document.getElementById("cm-search-panel");
  const desktopHome = document.getElementById("cm-search-desktop-home");

  if (!icon || !wrapper || !panel || !desktopHome) return;

  function isMobilePortrait() {
    return window.matchMedia("(max-width: 767px)").matches;
  }

  function openSearch() {
    if (!isMobilePortrait()) return;

    wrapper.classList.remove("hidden");
    wrapper.appendChild(panel);

    const input = panel.querySelector("#board-filter");
    input && input.focus();
  }

  function closeSearch() {
    // devolve pro desktop sempre
    desktopHome.appendChild(panel);
    wrapper.classList.add("hidden");
  }

  icon.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    openSearch();
  });

  // üîí Fechar clicando fora SEM deixar o clique ‚Äúpassar‚Äù pro perfil
  document.addEventListener("pointerdown", (e) => {
    if (!isMobilePortrait()) return;
    if (wrapper.classList.contains("hidden")) return;

    const clickedInside = wrapper.contains(e.target) || icon.contains(e.target);
    if (clickedInside) return;

    e.preventDefault();
    e.stopPropagation();
    closeSearch();
  }, true);

  window.addEventListener("resize", () => {
    if (!isMobilePortrait()) closeSearch();
  });
});
</script>







<!--ZERAR SCROLL NA TELA!!-->

<script>
(function () {
  function fitColumnsWrapper() {
    const wrap = document.getElementById("columns-wrapper");
    if (!wrap) return;

    // garante que a p√°gina n√£o role (s√≥ as colunas)
    document.documentElement.style.overflow = "hidden";
    document.body.style.overflow = "hidden";

    // altura dispon√≠vel = viewport - topo real do wrapper - folga
    const top = wrap.getBoundingClientRect().top;
    const paddingBottom = 12; // folga m√≠nima pra n√£o "colar" no fim
    const h = Math.max(240, Math.floor(window.innerHeight - top - paddingBottom));

    wrap.style.height = h + "px";
  }

  window.addEventListener("load", fitColumnsWrapper);
  window.addEventListener("resize", fitColumnsWrapper);

  // se algum swap HTMX mexer no topo, recalcula
  document.body.addEventListener("htmx:afterSwap", fitColumnsWrapper);
  document.body.addEventListener("htmx:afterSettle", fitColumnsWrapper);
})();
</script>


<script>
(function () {
  if (window.__cmTabsDelegated === true) return;
  window.__cmTabsDelegated = true;

  const ALLOWED = new Set(["desc", "tags", "check", "ativ", "files"]);

  function getInitialTab() {
    try {
      const deep = new URLSearchParams(window.location.search).get("tab");
      if (deep && ALLOWED.has(deep)) return deep;
    } catch (_e) {}
    return "desc";
  }

  function setActive(root, tab) {
    if (!root || !ALLOWED.has(tab)) return;

    root.querySelectorAll(".cm-tabbtn[data-cm-tab]").forEach((btn) => {
      btn.classList.toggle("is-active", btn.getAttribute("data-cm-tab") === tab);
    });

    root.querySelectorAll(".cm-panel[data-cm-panel]").forEach((p) => {
      p.classList.toggle("is-active", p.getAttribute("data-cm-panel") === tab);
    });

    root.setAttribute("data-cm-active", tab);

    // mant√©m compatibilidade com sua floatbar (cm:tabchange)
    try {
      root.dispatchEvent(new CustomEvent("cm:tabchange", { detail: { tab } }));
    } catch (_e) {}
  }

  function ensureModalTabs(scope) {
    const el = scope || document;
    const root =
      (el && el.id === "cm-root" && el) ||
      (el && el.querySelector && el.querySelector("#cm-root")) ||
      document.getElementById("cm-root");

    if (!root) return;
    setActive(root, getInitialTab());
  }

  // Delega√ß√£o: funciona mesmo ap√≥s HTMX swap
  document.addEventListener(
    "click",
    function (e) {
      const btn = e.target?.closest?.(".cm-tabbtn[data-cm-tab]");
      if (!btn) return;

      const root = btn.closest("#cm-root");
      if (!root) return;

      e.preventDefault();
      e.stopPropagation();

      setActive(root, btn.getAttribute("data-cm-tab"));
    },
    true
  );

  // Reaplica ap√≥s qualquer swap do modal
  document.body.addEventListener("htmx:afterSwap", function (evt) {
    const target = evt.detail?.target || evt.target;
    if (!target) return;

    if (target.id === "modal-body") {
      ensureModalTabs(target);
    }
  });

  // Primeira carga (caso o modal j√° esteja aberto por URL)
  document.addEventListener("DOMContentLoaded", () => ensureModalTabs(document));
})();
</script>



<script>
(function () {
  function animateAggregator(scope) {
    const col = scope.querySelector?.(".aggregator-column");
    if (!col) return;

    col.classList.remove("aggregator-enter");
    void col.offsetWidth; // reflow
    col.classList.add("aggregator-enter");
  }

  function animateAggregatorExit() {
    const col = document.querySelector(".aggregator-column");
    if (!col) return;

    col.classList.add("aggregator-exit");

    // espera a anima√ß√£o antes do HTMX swap
    setTimeout(() => {
      col.remove();
    }, 300);
  }

  document.body.addEventListener("htmx:beforeSwap", (e) => {
    const target = e.detail?.target;
    if (!target || target.id !== "columns-list") return;

    const hasBefore = document.querySelector(".aggregator-column");
    const hasAfter = e.detail.xhr.response?.includes("aggregator-column");

    // vai remover
    if (hasBefore && !hasAfter) {
      animateAggregatorExit();
    }
  });

  document.body.addEventListener("htmx:afterSwap", (e) => {
    const target = e.detail?.target;
    if (!target || target.id !== "columns-list") return;

    animateAggregator(target);
  });
})();
</script>




<script>
(function () {
  function closeDrawerSmooth() {
    document.body.classList.remove("drawer-open");
    document.getElementById("drawerOverlay")?.click?.();
  }

  function animateAggregator(scope) {
    const col = scope.querySelector(".aggregator-column");
    if (!col) return;

    // ENTRADA
    col.classList.add("aggregator-enter");

    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        col.classList.add("aggregator-enter-active");
        col.classList.remove("aggregator-enter");
      });
    });
  }

  function animateAggregatorExit() {
    const col = document.querySelector(".aggregator-column");
    if (!col) return;

    col.classList.add("aggregator-exit");
  }

  // üîë Integra√ß√£o com HTMX
  document.body.addEventListener("htmx:beforeRequest", (e) => {
    if (e.target.closest("#aggregator-toggle")) {
      closeDrawerSmooth();
      animateAggregatorExit();
    }
  });

  document.body.addEventListener("htmx:afterSwap", (e) => {
    // atraso proposital ‚Üí ritmo visual
    setTimeout(() => {
      animateAggregator(e.detail.target || document);
    }, 120);
  });
})();
</script>

<script>
(function () {
  function getParam(name) {
    try { return new URLSearchParams(window.location.search).get(name); }
    catch(e) { return null; }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const cardId = Number(getParam("card") || 0);
    if (!cardId) return;

    // abre o modal do card
    try {
      if (window.Modal && typeof window.Modal.openCard === "function") {
        window.Modal.openCard(cardId, true, null);
      }
    } catch (e) {}
  });
})();
</script>

{% if request.user.is_authenticated and request.user.profile.activity_counts %}
<script>
(function () {
  async function refreshBoardHistoryBadge() {
    try {
      const resp = await fetch(`/board/${window.BOARD_ID}/history/unread-count/`, {
        method: "GET",
        credentials: "same-origin",
        headers: { "Accept": "application/json" }
      });
      if (!resp.ok) return;

      const data = await resp.json();
      const n = Number(data.unread || 0);

      // Badge no item do drawer (Hist√≥rico do quadro)
      const badge = document.getElementById("board-history-badge");

      // Badges no bot√£o ‚ò∞ (desktop e mobile)
      const badgeDrawer = document.getElementById("drawer-unread-badge");
      const badgeDrawerMobile = document.getElementById("drawer-unread-badge-mobile");

      function applyBadge(el) {
        if (!el) return;
        if (n > 0) {
          el.textContent = String(n);
          el.classList.remove("hidden");
        } else {
          el.textContent = "0";
          el.classList.add("hidden");
        }
      }

      applyBadge(badge);
      applyBadge(badgeDrawer);
      applyBadge(badgeDrawerMobile);

    } catch (e) {}
  }

  document.addEventListener("DOMContentLoaded", refreshBoardHistoryBadge);

  document.body.addEventListener("htmx:afterSwap", () => {
    refreshBoardHistoryBadge();
  });

  document.addEventListener("modal:closed", refreshBoardHistoryBadge);

  window.refreshBoardHistoryBadge = refreshBoardHistoryBadge;
})();
</script>
{% endif %}





<script>
  document.addEventListener("DOMContentLoaded", refreshCounters);
  document.body.addEventListener("htmx:afterSwap", refreshCounters);
  document.body.addEventListener("htmx:afterSettle", refreshCounters);
</script>




<script>
  window.syncAggregatorCountersFromColumns = function syncAggregatorCountersFromColumns() {
    // monta um map {colId -> "N cards"} usando o que j√° est√° renderizado no header da coluna
    const map = new Map();

    document.querySelectorAll(".column-item[data-column-id]").forEach((col) => {
      const colId = col.getAttribute("data-column-id");
      const counterEl = col.querySelector("[data-column-counter]");
      if (!colId || !counterEl) return;

      // pega exatamente o texto que voc√™ j√° confia (ex: "4 cards")
      map.set(String(colId), counterEl.textContent.trim());
    });

    // aplica na agrupadora
    document.querySelectorAll("[data-agg-column-id]").forEach((row) => {
      const colId = row.getAttribute("data-agg-column-id");
      const target = row.querySelector("[data-agg-count]");
      if (!colId || !target) return;

      target.textContent = map.get(String(colId)) || "0 cards";
    });
  };
</script>







<script>
(function () {
  if (window.__cmBoardPanInstalled) return;
  window.__cmBoardPanInstalled = true;

  const wrap = document.getElementById("columns-wrapper");
  if (!wrap) return;

  // evita ‚Äúsele√ß√£o de texto‚Äù enquanto arrasta
  function setGrabbing(on) {
    wrap.classList.toggle("cm-grabbing", !!on);
    wrap.style.cursor = on ? "grabbing" : "";
    wrap.style.userSelect = on ? "none" : "";
  }

  // S√≥ faz pan quando o clique √© no ‚Äúfundo‚Äù (n√£o em cards/inputs/bot√µes)
  function isInteractiveTarget(t) {
    if (!t) return false;
    return !!t.closest(
      "a,button,input,textarea,select,[contenteditable='true']," +
      ".cm-cal-card,.checklist-item,.modal,.column-header,li[data-card-id]"
    );
  }

  // estado
  let down = false;
  let startX = 0;
  let startLeft = 0;
  let didMove = false;

  // threshold pra n√£o bloquear click simples
  const MOVE_PX = 6;

  wrap.addEventListener("pointerdown", (e) => {
    // bot√£o esquerdo (mouse) ou touch/pen
    if (e.pointerType === "mouse" && e.button !== 0) return;

    // n√£o brigar com drag de cards/colunas nem intera√ß√µes
    if (window.__isDraggingCard) return;
    if (isInteractiveTarget(e.target)) return;

    down = true;
    didMove = false;

    startX = e.clientX;
    startLeft = wrap.scrollLeft;

    // captura para continuar recebendo move
    try { wrap.setPointerCapture(e.pointerId); } catch (_e) {}

    setGrabbing(true);
  });

  wrap.addEventListener("pointermove", (e) => {
    if (!down) return;
    if (window.__isDraggingCard) return;

    const dx = e.clientX - startX;
    if (!didMove && Math.abs(dx) >= MOVE_PX) didMove = true;

    // pan: arrastar para a direita move o conte√∫do para a esquerda (scrollLeft diminui)
    wrap.scrollLeft = startLeft - dx;

    // se est√° arrastando, previne sele√ß√£o/drag nativo
    if (didMove) {
      e.preventDefault();
      e.stopPropagation();
    }
  }, { passive: false });

  function endPan(e) {
    if (!down) return;

    down = false;

    try { wrap.releasePointerCapture(e.pointerId); } catch (_e) {}
    setGrabbing(false);

    // se houve movimento, cancela click subsequente (evita abrir card sem querer)
    if (didMove) {
      const cancelClickOnce = (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        wrap.removeEventListener("click", cancelClickOnce, true);
      };
      wrap.addEventListener("click", cancelClickOnce, true);
    }
  }

  wrap.addEventListener("pointerup", endPan);
  wrap.addEventListener("pointercancel", endPan);

})();
</script>

<style>
  /* opcional: cursor de ‚Äúm√£o‚Äù quando passar no fundo */
  #columns-wrapper:not(.cm-grabbing) {
    cursor: grab;
  }
</style>





{% if request.user.is_authenticated and request.user.profile.activity_counts %}

<script>
/**
 * Atualiza badges de unread (FONTE √öNICA = POLL)
 * - Executa imediatamente na abertura da p√°gina
 * - N√£o recria DOM
 * - S√≥ altera texto/classe quando muda
 * - Ignora cards inexistentes
 * - N√£o interfere no modal
 */
(function () {
  if (window.__cardUnreadPollInstalled) return;
  window.__cardUnreadPollInstalled = true;

  async function refreshCardUnreadBadges() {
    // üîí n√£o roda se o modal estiver aberto
    if (document.getElementById("modal-body")) return;

    try {
      const resp = await fetch(
        `/board/${window.BOARD_ID}/cards/unread-activity/`,
        {
          method: "GET",
          credentials: "same-origin",
          headers: { "Accept": "application/json" }
        }
      );

      if (!resp.ok) return;

      const data = await resp.json();
      const map = data.cards || {};

      document.querySelectorAll("li[data-card-id]").forEach(cardEl => {
        const badge = cardEl.querySelector("[data-card-unread-badge]");
        if (!badge) return;

        const cardId = cardEl.getAttribute("data-card-id");
        const n = Number(map[cardId] || 0);

        // üîë s√≥ altera se houve mudan√ßa real
        const prev = Number(badge.textContent || 0);
        if (n === prev) return;

        if (n > 0) {
          badge.textContent = n;
          badge.classList.remove("hidden");
        } else {
          badge.textContent = "";
          badge.classList.add("hidden");
        }
      });

    } catch (e) {
      console.warn("unread poll error", e);
    }
  }

  // üöÄ EXECU√á√ÉO IMEDIATA NA ABERTURA DA P√ÅGINA
  document.addEventListener("DOMContentLoaded", () => {
    refreshCardUnreadBadges();
  });

  // üîÑ reidrata ap√≥s swaps
  document.body.addEventListener("htmx:afterSwap", refreshCardUnreadBadges);

  // üîÅ ao fechar modal (quando backend marca como lido)
  document.addEventListener("modal:closed", refreshCardUnreadBadges);

  // ‚è±Ô∏è polling cont√≠nuo
  setInterval(refreshCardUnreadBadges, 5000);
})();
</script>

{% endif %}





<script>
  document.body.addEventListener("userPrefsUpdated", function (e) {
    const w = e?.detail?.board_col_width;
    if (!w) return;

    const wrap = document.getElementById("columns-wrapper");
    if (!wrap) return;

    wrap.style.setProperty("--col-base", `${w}px`);
  });
</script>



<script>
document.addEventListener("pointerup", (e) => {
  const btn = e.target.closest("[data-column-color]");
  if (!btn) return;

  e.preventDefault();
  e.stopPropagation();

  // se voc√™ j√° tem onclick, isso for√ßa a mesma a√ß√£o no mobile
  btn.click();
}, { capture: true });
</script>


{% endblock content %}
