{% extends "base.html" %}
{% load static %}
{% load tag_helpers %}

{% block title %}{{ board.name }}{% endblock %}

{% block content %}




<!-- CSS dinâmico do wallpaper -->
<link rel="stylesheet" href="{% url 'boards:board_wallpaper_css' board.id %}">

<!-- CSS estático do layout -->
<link rel="stylesheet" href="{% static 'boards/board_detail.css' %}">


<!-- ======================== MENU HAMBÚRGUER ======================== -->
<div class="relative mt-4">
    <button id="board-menu-btn" class="text-xl text-gray-900 bg-white/80 border border-gray-400 rounded-md px-2 py-1 shadow-md
               hover:bg-white transition">
        ☰
    </button>



    <div id="board-menu" class="hidden absolute left-0 mt-2 bg-white shadow-lg rounded-md border p-2 w-48 z-50">
        <a href="{% url 'boards:boards_index' %}" class="block px-4 py-2 hover:bg-gray-100 rounded">
            ← Voltar aos Quadros
        </a>

        <button class="block text-left w-full px-4 py-2 hover:bg-gray-100 rounded"
            hx-get="{% url 'boards:update_board_wallpaper' board.id %}" hx-target="body" hx-swap="beforeend">
            Trocar Wallpaper
        </button>

        <button class="block text-left w-full px-4 py-2 hover:bg-gray-100 text-red-600"
            hx-post="{% url 'boards:remove_board_wallpaper' board.id %}" hx-target="body" hx-swap="beforeend">
            Remover papel de parede
        </button>
        <button id="toggle-delete-columns"
            class="block text-left w-full px-4 py-2 hover:bg-gray-100 text-red-600 rounded">
            Excluir colunas
        </button>

        <button id="toggle-delete-cards"
           class="block text-left w-full px-4 py-2 hover:bg-gray-100 text-red-600 rounded">
           Excluir cards
        </button> 
        <form method="post" action="{% url 'logout' %}" style="display:inline;">
            {% csrf_token %}
        <button type="submit">Sair</button>
        </form>
    </div>
</div>

<script>
    const menuBtn = document.getElementById("board-menu-btn");
    const menu = document.getElementById("board-menu");

    menuBtn.addEventListener("click", () => {
        menu.classList.toggle("hidden");
    });

    document.addEventListener("click", (ev) => {
        if (!menu.contains(ev.target) && !menuBtn.contains(ev.target)) {
            menu.classList.add("hidden");
        }
    });
</script>



<!-- ======================== TOPO DO BOARD ======================== -->
<div class="flex items-center gap-4 mt-6 mb-6">

    {% if board.image %}
    <div class="relative group inline-block">
        <div
            class="h-28 w-48 border border-gray-300 rounded-lg overflow-hidden bg-white flex items-center justify-center">
            <img src="{{ board.image.url }}" class="h-full w-auto object-contain">
        </div>

        <button class="absolute top-1 right-1 bg-red-600 text-white text-xs px-2 py-1 rounded
                       opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer"
            hx-post="{% url 'boards:update_board_image' board.id %}?delete=1" hx-target="body" hx-swap="beforeend">
            X
        </button>
    </div>
    {% else %}
    <div class="h-28 w-48 flex items-center justify-center rounded-lg border border-gray-300 
               bg-gray-100 text-gray-400 text-3xl cursor-pointer hover:bg-gray-200"
        hx-get="{% url 'boards:update_board_image' board.id %}" hx-target="body" hx-swap="beforeend">
        +
    </div>
    {% endif %}

    <h1 id="board-title" contenteditable="true"
        class="text-2xl font-semibold inline-block bg-white/70 px-2 py-1 rounded"
        onblur="updateBoardTitle({{ board.id }})"
        onkeypress="if(event.key==='Enter'){ event.preventDefault(); this.blur(); }">
        {{ board.name }}
    </h1>
</div>



<!-- ======================== FILTRO DE TAGS ======================== -->
<div class="mb-6 flex flex-wrap items-center gap-2">
    <span class="text-sm font-semibold text-gray-600 board-label">Filtrar por etiquetas:</span>


    <input type="text" id="tag-filter" placeholder="Ex: urgente" class="border rounded px-3 py-2 text-sm w-60"
        oninput="filterByTag(this.value)">
</div>


<h3 class="text-lg font-semibold mb-3 board-label">Colunas:</h3>




<!-- ======================== LISTA DE COLUNAS ======================== -->
<div id="columns-wrapper" class="flex gap-6 overflow-x-auto pb-6 pr-4">

    <div id="columns-list" class="flex gap-6">
        {% for column in columns %}
            {% include "boards/partials/column_item.html" %}
        {% endfor %}

    </div>

    <div id="add-column-box"
        class="w-64 bg-white/60 backdrop-blur-md border border-gray-300 rounded-xl p-4 h-fit shrink-0 shadow-md">

        <h3 class="font-semibold mb-2">Adicionar nova coluna</h3>

        <form method="post" hx-post="{% url 'boards:add_column' board.id %}" hx-target="#columns-list"
            hx-swap="beforeend">
            {% csrf_token %}
            <label class="block text-sm font-medium mb-1">Nome:</label>
            <input type="text" name="name" class="w-full border rounded px-3 py-2 mb-3" placeholder="Nome da coluna">

            <button class="px-3 py-2 bg-blue-600 text-white rounded w-full">
                Adicionar Coluna
            </button>
        </form>
    </div>
</div>



<!-- ======================== SCRIPTS ======================== -->
<script>
    function filterByTag(text) {
        text = text.trim().toLowerCase();
        document.querySelectorAll('[id^="cards-col-"] li[data-card-id]').forEach(card => {
            const tags = card.querySelectorAll('span.text-xs');
            let match = false;

            tags.forEach(t => {
                if (t.innerText.toLowerCase().includes(text))
                    match = true;
            });

            card.style.display = (text === "" || match) ? "" : "none";
        });
    }
</script>

<script>
    function initSortable() {
        document.querySelectorAll("[id^='cards-col-']").forEach(listEl => {

            if (listEl.dataset.sortableApplied === "1") return;
            listEl.dataset.sortableApplied = "1";

            new Sortable(listEl, {
                group: "cards",
                animation: 150,
                ghostClass: "drag-ghost",

                onEnd: evt => {
                    const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]")?.value;

                    fetch("{% url 'boards:move_card' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrftoken
                        },
                        body: JSON.stringify({
                            card_id: Number(evt.item.dataset.cardId),
                            new_column_id: Number(evt.to.id.replace("cards-col-", "")),
                            new_position: Number(evt.newIndex)
                        })
                    });
                }
            });
        });
    }

    document.addEventListener("DOMContentLoaded", initSortable);
    document.body.addEventListener("htmx:afterSwap", initSortable);
</script>

<script>
    function updateBoardTitle(boardId) {
        const titleEl = document.getElementById("board-title");
        const newTitle = titleEl.innerText.trim();

        const formData = new FormData();
        formData.append("name", newTitle);

        fetch(`/board/${boardId}/rename/`, {
            method: "POST",
            headers: { "X-CSRFToken": document.querySelector("meta[name='csrf-token']").content },
            body: formData
        });
    }
</script>

<script>
    let deleteCardsMode = false;

    const toggleDeleteCardsBtn = document.getElementById("toggle-delete-cards");

    toggleDeleteCardsBtn?.addEventListener("click", () => {
        deleteCardsMode = !deleteCardsMode;

        document.querySelectorAll(".delete-card-btn").forEach(btn => {
            btn.classList.toggle("hidden", !deleteCardsMode);
        });

        toggleDeleteCardsBtn.innerText = deleteCardsMode
            ? "Sair do modo de exclusão"
            : "Excluir cards";
    });

    // ao excluir um card → desligar modo delete
    document.body.addEventListener("htmx:afterRequest", function () {
        if (deleteCardsMode) {
            deleteCardsMode = false;

            document.querySelectorAll(".delete-card-btn").forEach(btn => {
                btn.classList.add("hidden");
            });

            toggleDeleteCardsBtn.innerText = "Excluir cards";
        }
    });
</script>

<script>
    let deleteColumnsMode = false;

    const toggleDeleteColumnsBtn = document.getElementById("toggle-delete-columns");

    toggleDeleteColumnsBtn?.addEventListener("click", () => {
        deleteColumnsMode = !deleteColumnsMode;

        document.querySelectorAll(".delete-column-btn").forEach(btn => {
            btn.classList.toggle("hidden", !deleteColumnsMode);
        });

        toggleDeleteColumnsBtn.innerText = deleteColumnsMode
            ? "Sair do modo de exclusão"
            : "Excluir colunas";
    });

    // ao excluir uma coluna → desliga o modo
    document.body.addEventListener("htmx:afterRequest", function () {
        if (deleteColumnsMode) {
            deleteColumnsMode = false;

            document.querySelectorAll(".delete-column-btn").forEach(btn => {
                btn.classList.add("hidden");
            });

            toggleDeleteColumnsBtn.innerText = "Excluir colunas";
        }
    });
</script>



{% endblock %}